#!/bin/bash
# ====================
#  MANAGER ANSIBLE
# ====================

# --- S√âCURIT√â ---
trap '' SIGINT SIGQUIT SIGTSTP

# =======================================================
# CONFIGURATION & PERSISTANCE
# =======================================================

if [ -z "$ANSIBLE_HOME" ]; then export ANSIBLE_HOME="$HOME/ansible"; fi
export ANSIBLE_ROOT=$(readlink -f "$ANSIBLE_HOME")
export ANSIBLE_CONFIG="$ANSIBLE_ROOT/ansible.cfg"
CONFIG_FILE="$ANSIBLE_ROOT/.manager_config"

if [ -f "$CONFIG_FILE" ]; then source "$CONFIG_FILE"; fi

# D√©fauts
if [ -z "$BACKUP_DIR" ]; then export BACKUP_DIR="/var/backups/ansible_manager"; fi
if [ -z "$CRON_USER" ]; then export CRON_USER="root"; fi

# Chemins
PLAYBOOKS_DIR="$ANSIBLE_ROOT/playbooks"
ROLES_DIR="$ANSIBLE_ROOT/roles"
DESC_FILE="$PLAYBOOKS_DIR/.descriptions"
VAULT_PASS_FILE="$ANSIBLE_ROOT/.vault_pass"

# Couleurs & Design
BLUE=$'\033[0;34m'
GREEN=$'\033[0;32m'
RED=$'\033[0;31m'
YELLOW=$'\033[1;33m'
CYAN=$'\033[0;36m'
GREY=$'\033[1;30m'
NC=$'\033[0m'
BOLD=$'\033[1m'
SEP="${BLUE}------------------------------------------------${NC}"
SEP_RED="${RED}------------------------------------------------${NC}"

mkdir -p "$PLAYBOOKS_DIR" "$ROLES_DIR"

# =======================================================
# UTILITAIRES
# =======================================================

pause() { echo ""; read -p "Entr√©e pour continuer..."; }

save_config() {
    echo "BACKUP_DIR=\"$BACKUP_DIR\"" > "$CONFIG_FILE"
    echo "CRON_USER=\"$CRON_USER\"" >> "$CONFIG_FILE"
    _check_gitignore
}

_check_gitignore() {
    cd "$ANSIBLE_ROOT" || return
    if [ ! -f ".gitignore" ]; then touch ".gitignore"; fi
    if ! grep -q ".manager_config" ".gitignore"; then echo ".manager_config" >> ".gitignore"; fi
}

ask_sudo_gui() {
    # Tente une √©l√©vation silencieuse (cache ou NOPASSWD global)
    if sudo -n true 2>/dev/null; then return 0; fi
    
    echo -e "\n${YELLOW}üîí Authentification requise pour cette action${NC}"
    read -s -p "Mot de passe : " user_pass; echo ""
    echo "$user_pass" | sudo -S -v 2>/dev/null
    if [ $? -eq 0 ]; then return 0; else echo -e "${RED}‚ùå Mot de passe incorrect.${NC}"; pause; return 1; fi
}

run_as_root() { 
    # Force l'authentification avant d'ex√©cuter la commande sensible
    if ask_sudo_gui; then sudo "$@"; return $?; fi; return 1; 
}

# --- INFO SYST√àME ---
get_sys_info() {
    LOCAL_IP=$(hostname -I | awk '{print $1}')
    PUBLIC_IP=$(curl -s -4 -m 1 https://icanhazip.com 2>/dev/null)
    [[ ! "$PUBLIC_IP" =~ ^[0-9.]+$ ]] && PUBLIC_IP="N/A"
    OS_NAME=$(grep -oP 'PRETTY_NAME="\K[^"]+' /etc/os-release 2>/dev/null | cut -c1-20)
    [ -z "$OS_NAME" ] && OS_NAME="Linux"
    CPU_USAGE=$(top -bn1 | grep "Cpu(s)" | sed "s/.*, *\([0-9.]*\)%* id.*/\1/" | awk '{print 100 - $1"%"}' 2>/dev/null)
    [ -z "$CPU_USAGE" ] && CPU_USAGE="N/A"
    RAM_USAGE=$(free -h | awk '/^Mem:/ {print $3 "/" $2}')
    SYS_UPTIME=$(uptime -p | sed 's/up //;s/ hours/h/;s/ minutes/m/;s/ days/j/')
    APP_VER=$(ansible --version 2>/dev/null | head -n1 | awk '{print $NF}' | tr -d ']')

    if systemctl is-active --quiet cron; then SX="${GREEN}‚óè ACTIF${NC}"; else SX="${RED}‚óè OFF${NC}"; fi
    if systemctl is-active --quiet ufw; then FW="${GREEN}‚óè ACTIF${NC}"; else FW="${RED}‚óè INACTIF${NC}"; fi

    cd "$ANSIBLE_ROOT" || return
    if [ -d ".git" ]; then
        if [ -n "$(git status --porcelain)" ]; then ST_GIT="${YELLOW}‚ö†Ô∏è  Modifi√©${NC}"; else ST_GIT="${GREEN}‚úÖ √Ä jour${NC}"; fi
    else ST_GIT="${RED}üî¥ Non Config${NC}"; fi

    if [ -d "$BACKUP_DIR" ]; then ST_BKP="${GREEN}‚úÖ Configur√©${NC}"; else ST_BKP="${RED}üî¥ Non Config${NC}"; fi

    if [ -r /var/log/syslog ]; then
        if tail -n 50 /var/log/syslog | grep -qi "CRON.*error\|CRON.*exit status [1-9]"; then
            ST_CRON="${RED}‚ö†Ô∏è  Erreurs${NC}"
        else ST_CRON="${GREEN}‚úÖ Clean${NC}"; fi
    else ST_CRON="${GREY}? (No Access)${NC}"; fi
}

ensure_git() {
    if ! command -v git &> /dev/null; then
        echo -e "${YELLOW}Git n'est pas install√©.${NC}"
        read -p "L'installer ? (o/n) " i
        if [ "$i" == "o" ]; then run_as_root apt update && run_as_root apt install -y git; else return 1; fi
    fi
    _check_gitignore
    return 0
}

# =======================================================
# MODULE 1 : ASSISTANT CR√âATION
# =======================================================
module_assistant_dev() {
    cd "$ANSIBLE_ROOT" || return

    _create_role_wizard() {
        echo -e "\n${CYAN}--- NOUVEAU R√îLE ---${NC}"
        read -p "Nom du r√¥le (ex: mysql, common) : " rname; [ -z "$rname" ] && return
        target="$ROLES_DIR/$rname"
        if [ -d "$target" ]; then echo -e "${RED}Erreur : Le dossier existe d√©j√†.${NC}"; pause; return; fi
        mkdir -p "$target"/{tasks,handlers,defaults,vars,templates,files,meta}
        for d in tasks handlers defaults vars meta; do echo "---" > "$target/$d/main.yml"; done
        echo -e "${GREEN}‚úÖ Structure cr√©√©e dans roles/$rname${NC}"
        read -p "G√©n√©rer un playbook d'installation ? (o/n) " cp
        if [ "$cp" == "o" ]; then
            echo -e "---\n- name: Deploy $rname\n  hosts: all\n  become: yes\n  roles:\n    - $rname" > "$PLAYBOOKS_DIR/deploy_$rname.yml"
            echo -e "${GREEN}‚úÖ Playbook g√©n√©r√© : deploy_$rname.yml${NC}"
        fi; pause
    }
    
    _create_playbook_wizard() {
        echo -e "\n${CYAN}--- NOUVEAU PLAYBOOK ---${NC}"
        read -p "Nom du fichier (ex: update_sys) : " p; [ -z "$p" ] && return
        p="${p%.yml}.yml"; t="$PLAYBOOKS_DIR/$p"
        if [ -f "$t" ]; then echo -e "${RED}Fichier existant.${NC}"; pause; return; fi
        echo -e "---\n- name: New Playbook\n  hosts: all\n  become: yes\n  tasks:\n    - name: Ping\n      ping:" > "$t"
        echo -e "${GREEN}‚úÖ Cr√©√©.${NC}"
        read -p "Ouvrir l'√©diteur ? (o/n)" e; [ "$e" == "o" ] && nano "$t"
    }

    while true; do
        clear
        echo -e "${BLUE}################################################${NC}"
        echo -e "${BLUE}#            ASSISTANT DE CR√âATION             #${NC}"
        echo -e "${BLUE}################################################${NC}"
        echo -e "${GREY}G√©n√©rez rapidement vos structures Ansible.${NC}"
        echo -e "$SEP"
        echo -e "  ${GREEN}1.${NC} ‚ú® Cr√©er un nouveau R√¥le (+ Structure)"
        echo -e "  ${GREEN}2.${NC} üìÑ Cr√©er un nouveau Playbook simple"
        echo -e "  ${YELLOW}3.${NC} ‚ûï Ajouter une T√¢che (Task)"
        echo -e "  ${YELLOW}4.${NC} üí≤ Ajouter une Variable (Config)"
        echo -e "  ${RED}5.${NC} üóëÔ∏è  Supprimer un √©l√©ment"
        echo -e "$SEP_RED"
        echo -e "  ${RED}0.${NC} Retour"
        echo -e "$SEP"
        read -p "  Choix > " c
        case $c in
            1) _create_role_wizard;; 
            2) _create_playbook_wizard;;
            3) echo "Fonction Task Wizard"; pause ;;
            4) echo "Fonction Var Wizard"; pause ;; 
            5) echo "Fonction Delete Wizard"; pause ;;
            0) return;;
        esac
    done
}

# =======================================================
# MODULE 2 : LANCEUR
# =======================================================
module_launcher() {
    cd "$ANSIBLE_ROOT" || return
    _get_desc() {
        local f="$1"
        local d=$(grep "^$f|" "$DESC_FILE" 2>/dev/null | cut -d'|' -f2-)
        [ -n "$d" ] && echo "$d" || echo "${GREY}Aucune description${NC}"
    }

    while true; do
        clear
        echo -e "${BLUE}################################################${NC}"
        echo -e "${BLUE}#             LANCEUR DE PLAYBOOKS             #${NC}"
        echo -e "${BLUE}################################################${NC}"
        echo -e "${GREY}S√©lectionnez un script d'automatisation √† ex√©cuter.${NC}"
        echo -e "$SEP"

        mapfile -t files < <(find "$PLAYBOOKS_DIR" -maxdepth 1 -name "*.yml" -printf "%f\n" | sort)
        if [ ${#files[@]} -eq 0 ]; then echo -e "${RED}Aucun playbook trouv√©.${NC}"; echo -e "$SEP"; else
            local i=0
            for f in "${files[@]}"; do
                printf "  ${GREEN}[%d]${NC} %-30s ${GREY}%s${NC}\n" "$i" "${f:0:30}" "$(_get_desc "$f")"
                ((i++))
            done
        fi
        echo -e "$SEP_RED"
        echo -e "  ${RED}0.${NC} Retour"
        echo -e "$SEP"
        
        read -p "  Num√©ro du playbook > " idx
        if [ "$idx" == "0" ]; then return; fi
        
        if [[ "$idx" =~ ^[0-9]+$ ]] && [ "$idx" -lt "${#files[@]}" ]; then
            sel="${files[$idx]}"
            echo -e "\n${CYAN}üöÄ Lancement de : $sel${NC}"
            echo -e "${GREY}----------------------------------------${NC}"
            ansible-playbook "$PLAYBOOKS_DIR/$sel"
            echo -e "${GREY}----------------------------------------${NC}"
            pause
        else echo "Choix invalide."; sleep 0.5; fi
    done
}

# =======================================================
# MODULE 3 : SAUVEGARDE & GIT
# =======================================================
module_backup_git() {
    cd "$ANSIBLE_ROOT" || return

    _run_backup_local() {
        if [ ! -d "$BACKUP_DIR" ]; then return 1; fi
        if ! sudo touch "$BACKUP_DIR/.chk" 2>/dev/null; then return 1; fi
        sudo rm "$BACKUP_DIR/.chk"
        D=$(date +%Y%m%d_%H%M%S)
        FILE="$BACKUP_DIR/ansible_backup_$D.tar.gz"
        echo -e "${GREY}[Local] Compression...${NC}"
        if tar --exclude='.git' --exclude='*.retry' -czf "/tmp/ansible_temp.tar.gz" . 2>/dev/null; then
            if sudo mv "/tmp/ansible_temp.tar.gz" "$FILE"; then
                echo -e "${GREEN}‚úÖ Sauvegarde locale OK : $(basename "$FILE")${NC}"; return 0
            fi
        fi
        echo -e "${RED}‚ùå Erreur Local.${NC}"; return 1
    }

    _run_push_git() {
        if [ ! -d ".git" ]; then return 1; fi
        echo -e "${GREY}[Git] Sync...${NC}"
        git fetch origin >/dev/null 2>&1
        if [ -n "$(git status --porcelain)" ]; then
            git add -A; git commit -m "Auto-backup $(date)" >/dev/null 2>&1
        fi
        cur=$(git rev-parse --abbrev-ref HEAD)
        if git push origin "$cur" 2>/dev/null || git push -u origin "$cur" 2>/dev/null; then
             echo -e "${GREEN}‚úÖ Push Git OK (Branche: $cur).${NC}"; return 0
        else echo -e "${RED}‚ùå Erreur Push Git.${NC}"; return 1; fi
    }

    _pull_git() {
        ensure_git || return
        cur=$(git rev-parse --abbrev-ref HEAD)
        if git pull origin "$cur"; then
            echo -e "${GREEN}‚úÖ Mis √† jour.${NC}"
            git branch --set-upstream-to=origin/"$cur" "$cur" 2>/dev/null
        else echo -e "${RED}‚ùå Erreur Pull.${NC}"; fi
        pause
    }

    _menu_config() {
        while true; do
            clear
            echo -e "${BLUE}################################################${NC}"
            echo -e "${BLUE}#            PARAM√àTRES & CONFIG               #${NC}"
            echo -e "${BLUE}################################################${NC}"
            echo -e "${GREY}G√©rez ici les chemins et la connexion GitHub.${NC}"
            echo -e "$SEP"
            
            curr_remote=$(git remote get-url origin 2>/dev/null || echo "${RED}Non d√©fini${NC}")
            curr_user=$(git config user.name || echo "${RED}Inconnu${NC}")
            
            echo -e "  üìÇ Dossier Local : ${YELLOW}$BACKUP_DIR${NC}"
            echo -e "  üîó Remote Git    : ${CYAN}$curr_remote${NC}"
            echo -e "  üë§ Identit√© Git  : ${CYAN}$curr_user${NC}"
            echo -e "$SEP"

            echo -e "  ${GREEN}1.${NC} Changer le dossier de sauvegarde local"
            echo -e "  ${GREEN}2.${NC} Configurer Remote Git (URL)"
            echo -e "  ${GREEN}3.${NC} Configurer Identit√© (Nom/Email)"
            echo -e "  ${RED}0.${NC} Retour"
            echo -e "$SEP"
            
            read -p "  Choix > " conf_choice
            case "$conf_choice" in
                1)
                    echo -e "\n${CYAN}--- CHEMIN LOCAL ---${NC}"
                    read -p "Nouveau chemin absolu : " new_path
                    if [[ "$new_path" == /* ]]; then
                        if ask_sudo_gui; then
                            sudo mkdir -p "$new_path"
                            if sudo touch "$new_path/.test" 2>/dev/null; then
                                sudo rm "$new_path/.test"
                                export BACKUP_DIR="$new_path"
                                save_config
                                echo -e "${GREEN}‚úÖ Enregistr√©.${NC}"
                            else echo -e "${RED}‚ùå Permission refus√©e.${NC}"; fi
                        fi
                    else echo -e "${RED}Chemin invalide.${NC}"; fi
                    pause
                    ;;
                2)
                    echo -e "\n${CYAN}--- URL GIT ---${NC}"
                    read -p "URL (https/ssh) : " u
                    if [ -n "$u" ]; then
                        if git remote get-url origin >/dev/null 2>&1; then git remote set-url origin "$u"; else git remote add origin "$u"; fi
                        echo -e "${GREEN}‚úÖ Remote mis √† jour.${NC}"
                    fi
                    pause
                    ;;
                3)
                    echo -e "\n${CYAN}--- IDENTIT√â ---${NC}"
                    read -p "Nom : " n; read -p "Email : " e
                    git config user.name "$n"; git config user.email "$e"
                    echo -e "${GREEN}‚úÖ Identit√© enregistr√©e.${NC}"
                    pause
                    ;;
                0) return ;;
            esac
        done
    }

    _smart_backup_menu() {
        echo -e "\n${BOLD}${CYAN}=== ASSISTANT DE SAUVEGARDE ===${NC}"
        echo "1. üíæ Local uniquement"
        echo "2. ‚òÅÔ∏è  Git uniquement"
        echo "3. üíé Les Deux (Recommand√©)"
        echo "0. Annuler"
        read -p "> " choice
        
        local sl=0; local sg=0; local al=0; local ag=0

        case "$choice" in
            1) al=1; if _run_backup_local; then sl=1; fi ;;
            2) ag=1; if _run_push_git; then sg=1; fi ;;
            3)
                al=1; ag=1
                echo "---"
                if _run_backup_local; then sl=1; else echo -e "${YELLOW}‚ö†Ô∏è  Echec Local.${NC}"; fi
                echo "---"
                if _run_push_git; then sg=1; else echo -e "${YELLOW}‚ö†Ô∏è  Echec Git.${NC}"; fi
                ;;
            0) return ;;
        esac

        echo -e "\n${BOLD}=== R√âSULTAT ===${NC}"
        msg=""
        if [ $al -eq 1 ]; then if [ $sl -eq 1 ]; then msg+="${GREEN}LOCAL [OK]${NC}  "; else msg+="${RED}LOCAL [KO]${NC}  "; fi; fi
        if [ $ag -eq 1 ]; then if [ $sg -eq 1 ]; then msg+="${GREEN}GIT [OK]${NC}"; else msg+="${RED}GIT [KO]${NC}"; fi; fi
        echo -e "$msg"
        pause
    }

    _lazygit_mode() {
        if ! command -v lazygit &>/dev/null; then
             echo -e "${YELLOW}Lazygit introuvable.${NC}"
             read -p "Installer ? (o/n) " i
             if [ "$i" == "o" ] && ask_sudo_gui; then
                 v=$(curl -s "https://api.github.com/repos/jesseduffield/lazygit/releases/latest" | grep -Po '"tag_name": "v\K[^"]*')
                 curl -Lo lz.tar.gz "https://github.com/jesseduffield/lazygit/releases/latest/download/lazygit_${v}_Linux_x86_64.tar.gz"
                 tar xf lz.tar.gz lazygit; sudo install lazygit /usr/local/bin; rm lz.tar.gz lazygit
             else return; fi
        fi
        trap - SIGINT SIGQUIT SIGTSTP; lazygit; trap '' SIGINT SIGQUIT SIGTSTP
    }

    _rollback_git() {
        while true; do
            clear
            echo -e "${RED}‚ö†Ô∏è  ZONE DANGER : ROLLBACK${NC}"
            echo "1. Annuler modifs (Discard Changes)"
            echo "2. Reset Soft (Annuler commit, garder fichiers)"
            echo "3. Reset Hard (Tout effacer > Remote)"
            echo "0. Retour"
            read -p "> " c
            case $c in
                1) git checkout .; git clean -fd; echo "Annul√©."; pause;;
                2) git reset --soft HEAD~1; echo "Reset Soft OK."; pause;;
                3) read -p "CONFIRMER (OUI) : " k
                   if [ "$k" == "OUI" ]; then
                       git fetch origin
                       git reset --hard origin/$(git rev-parse --abbrev-ref HEAD)
                       echo "Reset Hard OK."
                   fi; pause;;
                0) return ;;
            esac
        done
    }

    while true; do
        clear
        echo -e "${BLUE}################################################${NC}"
        echo -e "${BLUE}#      CENTRE DE SAUVEGARDE & VERSIONNING      #${NC}"
        echo -e "${BLUE}################################################${NC}"
        echo -e "${GREY}G√©rez vos versions Git et vos archives locales.${NC}"
        echo -e "$SEP"
        
        if [ -d "$BACKUP_DIR" ]; then SL="${GREEN}Configur√©${NC}"; else SL="${RED}Invalide${NC}"; fi
        if [ -d ".git" ]; then SG="${GREEN}Initialis√©${NC}"; else SG="${RED}Absent${NC}"; fi
        
        printf "  üíæ Local : %-25b | üê± Git : %s\n" "$SL" "$SG"
        echo -e "$SEP"

        echo -e " ${BOLD}${CYAN}üöÄ ACTIONS${NC}"
        echo -e "    ${GREEN}1.${NC} üíé Assistant Sauvegarde (Smart Backup)"
        echo -e "    ${GREEN}2.${NC} ‚òÅÔ∏è  Synchroniser Git (Push rapide)"
        echo -e "    ${GREEN}3.${NC} ‚¨áÔ∏è  Mise √† jour Git (Pull)"
        echo ""
        
        echo -e " ${BOLD}${CYAN}‚öôÔ∏è  CONFIGURATION${NC}"
        echo -e "    ${GREEN}4.${NC} üîß Configurer (Chemins, Remote, etc.)"
        echo -e "    ${GREEN}5.${NC} üê¢ Terminal Avanc√© (Lazygit)"
        echo -e "    ${YELLOW}6.${NC} üîô Rollback / Annuler"
        
        echo -e "$SEP_RED"
        echo -e "  ${RED}0.${NC} Retour au menu principal"
        echo -e "$SEP"

        read -p "  Choix > " c
        case "$c" in
            1) _smart_backup_menu ;;
            2) _run_push_git; pause ;;
            3) _pull_git ;;
            4) _menu_config ;;
            5) _lazygit_mode ;;
            6) _rollback_git ;;
            0) return ;;
        esac
    done
}

# =======================================================
# MODULE 4 : VAULT
# =======================================================
module_vault() {
    export EDITOR="nano"
    if [ ! -f "$VAULT_PASS_FILE" ]; then 
        echo -e "${RED}Erreur : .vault_pass manquant.${NC}"; pause; return
    fi
    
    while true; do
        clear
        echo -e "${BLUE}################################################${NC}"
        echo -e "${BLUE}#           GESTION DES SECRETS (VAULT)        #${NC}"
        echo -e "${BLUE}################################################${NC}"
        echo -e "${GREY}Chiffrez vos variables sensibles (mots de passe, cl√©s).${NC}"
        echo -e "$SEP"
        echo -e "  ${GREEN}1.${NC} üîí Chiffrer un fichier (Encrypt)"
        echo -e "  ${GREEN}2.${NC} üîì D√©chiffrer un fichier (Decrypt)"
        echo -e "  ${GREEN}3.${NC} üìù √âditer un fichier chiffr√© (Edit)"
        echo -e "  ${GREEN}4.${NC} üëÄ Voir un fichier chiffr√© (View)"
        echo -e "$SEP_RED"
        echo -e "  ${RED}0.${NC} Retour"
        echo -e "$SEP"
        
        read -p "  Choix > " c
        if [ "$c" == "0" ]; then return; fi
        
        read -e -p "  Chemin du fichier (Tab) : " f
        if [ -z "$f" ]; then continue; fi
        if [ ! -f "$f" ]; then echo "Introuvable."; pause; continue; fi

        case $c in
            1) ansible-vault encrypt "$f"; pause ;;
            2) ansible-vault decrypt "$f"; pause ;;
            3) ansible-vault edit "$f"; ;;
            4) ansible-vault view "$f" | less ;;
        esac
    done
}

# =======================================================
# MODULE 5 : INVENTAIRE
# =======================================================
module_inventory() {
    cd "$ANSIBLE_ROOT" || return
    while true; do
        clear
        echo -e "${BLUE}################################################${NC}"
        echo -e "${BLUE}#              INVENTAIRE ANSIBLE              #${NC}"
        echo -e "${BLUE}################################################${NC}"
        echo -e "${GREY}Visualisez vos machines et testez la connexion.${NC}"
        echo -e "$SEP"
        echo -e "  ${GREEN}1.${NC} üå≥ Vue Graphique (Groupes/H√¥tes)"
        echo -e "  ${GREEN}2.${NC} üìã Vue Liste (D√©tails)"
        echo -e "  ${GREEN}3.${NC} üì° Test de connexion (PING All)"
        echo -e "  ${GREEN}4.${NC} üîç Infos d√©taill√©es (Setup/Facts)"
        echo -e "$SEP_RED"
        echo -e "  ${RED}0.${NC} Retour"
        echo -e "$SEP"

        read -p "  Choix > " c
        case $c in
            1) ansible-inventory --graph; pause ;;
            2) ansible-inventory --list | grep "ansible_host" -B 5 | less ;;
            3) echo -e "${CYAN}Ping en cours...${NC}"; ansible all -m ping; pause ;;
            4) read -p "  Machine : " h; [ -n "$h" ] && ansible "$h" -m setup | less ;;
            0) return ;;
        esac
    done
}

# =======================================================
# MODULE 6 : CRON (Monitor)
# =======================================================
module_cron() {
    if ! ask_sudo_gui; then return; fi
    while true; do
        clear
        echo -e "${BLUE}################################################${NC}"
        echo -e "${BLUE}#            PLANIFICATEUR (CRON)              #${NC}"
        echo -e "${BLUE}################################################${NC}"
        echo -e "${GREY}G√©rez l'ex√©cution automatique de vos playbooks.${NC}"
        echo -e "$SEP"
        
        echo -e "  üë§ Utilisateur actuel : ${CYAN}$CRON_USER${NC}"
        echo -e "$SEP"
        
        echo -e "  ${GREEN}1.${NC} üìù √âditer la table Cron (Edit)"
        echo -e "  ${GREEN}2.${NC} üìÑ Lister les t√¢ches actuelles"
        echo -e "  ${GREEN}3.${NC} üìÇ Voir les logs d'ex√©cution (Syslog)"
        echo -e "  ${GREEN}4.${NC} üîÑ Changer l'utilisateur cible"
        echo -e "$SEP_RED"
        echo -e "  ${RED}0.${NC} Retour"
        echo -e "$SEP"
        
        read -p "  Choix > " c
        case $c in
            1) sudo crontab -u "$CRON_USER" -e ;;
            2) echo -e "\n${CYAN}--- T√¢ches de $CRON_USER ---${NC}"; sudo crontab -u "$CRON_USER" -l; pause ;;
            3) sudo grep CRON /var/log/syslog | tail -n 20; pause ;;
            4) 
                read -p "  Nouvel utilisateur pour Cron : " u
                if id "$u" &>/dev/null; then
                    export CRON_USER="$u"
                    save_config
                    echo -e "${GREEN}‚úÖ Utilisateur chang√© vers $u.${NC}"
                else
                    echo -e "${RED}‚ùå Utilisateur $u inconnu.${NC}"
                fi
                pause
                ;;
            0) return ;;
        esac
    done
}

# =======================================================
# MODULE 7 : PARE-FEU (UFW) - NOPASSWD Support
# =======================================================
module_firewall() {
    # Pas de blocage global ici pour autoriser le status sans MDP
    while true; do
        clear
        echo -e "${BLUE}################################################${NC}"
        echo -e "${BLUE}#             PARE-FEU (UFW)                   #${NC}"
        echo -e "${BLUE}################################################${NC}"
        
        # Affichage (Utilise NOPASSWD si dispo, sinon demandera)
        sudo ufw status numbered
        
        echo -e "$SEP"
        echo -e "  ${GREEN}1.${NC} ‚ûï Ouvrir un Port (Allow)"
        echo -e "  ${GREEN}2.${NC} ‚ûñ Supprimer une R√®gle (Delete)"
        echo -e "  ${GREEN}3.${NC} üîÑ Recharger (Reload)"
        echo -e "$SEP_RED"
        echo -e "  ${RED}0.${NC} Retour"
        echo -e "$SEP"
        
        read -p "  Choix > " c
        case $c in
            1) read -p "Port (ex: 80/tcp) : " p; run_as_root ufw allow "$p"; pause ;;
            2) read -p "Num√©ro de r√®gle : " n; run_as_root ufw delete "$n"; pause ;;
            3) run_as_root ufw reload; pause ;;
            0) return ;;
        esac
    done
}

# =======================================================
# AUTRES OUTILS SIMPLES
# =======================================================
module_jail() {
    echo -e "${GREEN}Jail ($ANSIBLE_ROOT)${NC}"; bash --rcfile <(echo "PS1='(Jail) \w\$ '; cd $ANSIBLE_ROOT")
}
module_updates() {
    if ask_sudo_gui; then sudo apt update && sudo apt upgrade -y; pause; fi
}
module_power() {
    if [ "$1" == "OFF" ]; then sudo poweroff; else sudo reboot; fi
}
open_user_shell() {
    if ! ask_sudo_gui; then return; fi
    trap - SIGINT SIGQUIT SIGTSTP; export SKIP_KIOSK=1
    cd "$ANSIBLE_ROOT" || cd "$HOME"; bash --login; unset SKIP_KIOSK; trap '' SIGINT SIGQUIT SIGTSTP
}

# =======================================================
# MENU PRINCIPAL
# =======================================================

while true; do
    clear
    get_sys_info
    
    echo -e "${BLUE}###############################${NC}"
    echo -e "${BLUE}#       ANSIBLE MANAGER       #${NC}"
    echo -e "${BLUE}###############################${NC}"
    
    printf "  üñ•Ô∏è  ${CYAN}%-29s${NC} | ‚è±Ô∏è  ${GREY}%s${NC}\n" "$OS_NAME" "$SYS_UPTIME"
    printf "  üß† CPU: ${YELLOW}%-23s${NC} | üíæ RAM: ${YELLOW}%s${NC}\n" "$CPU_USAGE" "$RAM_USAGE"
    printf "  üè† LAN: ${YELLOW}%-23s${NC} | üåç WAN: ${YELLOW}%s${NC}\n" "$LOCAL_IP" "$PUBLIC_IP"
    echo -e "$SEP"
    printf "  ‚è∞ Automate : %-20b | üõ°Ô∏è  Pare-feu : %s\n" "$SX" "$FW"
    printf "  ‚ÑπÔ∏è  Ansible  : %-20s | üìÅ Racine    : %s\n" "${CYAN}$APP_VER${NC}" "$(basename "$ANSIBLE_HOME")"
    printf "  üê± Git Stat : %-20b | üíæ Backup Loc : %s\n" "$ST_GIT" "$ST_BKP"
    printf "  üë§ Cron User : %-20s | üìâ Log Err    : %b\n" "$CRON_USER" "$ST_CRON"
    echo -e "$SEP"

    # Section 1
    echo -e " ${BOLD}${CYAN}üöÄ OP√âRATIONS & D√âVELOPPEMENT${NC}"
    echo -e "    ${GREEN}1.${NC} üßô Assistant Cr√©ation (R√¥les/Tasks)"
    echo -e "    ${GREEN}2.${NC} üöÄ Lancer un Playbook"
    echo -e "    ${GREEN}3.${NC} üíé Centre de Sauvegardes & Git"
    echo -e "    ${GREEN}4.${NC} üîê Gestion des Secrets (Vault)"
    echo ""

    # Section 2 (Verticale)
    echo -e " ${BOLD}${CYAN}üõ†Ô∏è  OUTILS${NC}"
    echo -e "    ${GREEN}5.${NC} üåç Inventaire Ansible"
    echo -e "    ${GREEN}6.${NC} ‚è∞ T√¢ches Planifi√©es (Cron)"
    echo -e "    ${GREEN}7.${NC} üß± Pare-feu (UFW)"
    echo -e "    ${GREEN}8.${NC} üîí Shell Restreint (Jail)"
    echo -e "    ${GREEN}9.${NC} üì¶ Mises √† jour Syst√®me"
    
    echo -e "$SEP_RED"
    
    # Section 3
    echo -e " ${BOLD}${RED}üíÄ SYST√àME${NC}"
    echo -e "    ${RED}10.${NC}üîå √âteindre le serveur"
    echo -e "    ${RED}11.${NC}‚ôªÔ∏è  Red√©marrer le serveur"
    echo -e "$SEP"
    
    # Footer
    echo -e "  [${YELLOW}admin${NC}] üíª Console Admin    |    [${RED}exit${NC}] üö™ Quitter"
    echo -e "$SEP"

    read -r -p "  Votre choix > " choice

    case "$choice" in
        1) module_assistant_dev ;;
        2) module_launcher ;;
        3) module_backup_git ;;
        4) module_vault ;;
        5) module_inventory ;;
        6) module_cron ;;
        7) module_firewall ;;
        8) module_jail ;;
        9) module_updates ;;
        10) module_power "OFF" ;;
        11) module_power "REBOOT" ;;
        admin) open_user_shell ;;
        exit|q) echo "Bye."; exit 0 ;;
        *) echo "Choix invalide."; sleep 0.5 ;;
    esac
done
