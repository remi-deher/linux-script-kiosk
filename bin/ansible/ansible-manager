#!/bin/bash
# ====================
#  MANAGER ANSIBLE
# ====================

# --- SÃ‰CURITÃ‰ : EmpÃªcher la sortie accidentelle ---
trap '' SIGINT SIGQUIT SIGTSTP

# =======================================================
# CONFIGURATION GLOBALE
# =======================================================

if [ -z "$ANSIBLE_HOME" ]; then
    export ANSIBLE_HOME="$HOME/ansible"
fi

export ANSIBLE_ROOT=$(readlink -f "$ANSIBLE_HOME")
export ANSIBLE_CONFIG="$ANSIBLE_ROOT/ansible.cfg"

# Chemins internes
PLAYBOOKS_DIR="$ANSIBLE_ROOT/playbooks"
ROLES_DIR="$ANSIBLE_ROOT/roles"
BACKUP_DIR="/var/backups/ansible_manager"
DESC_FILE="$PLAYBOOKS_DIR/.descriptions"
VAULT_PASS_FILE="$ANSIBLE_ROOT/.vault_pass"
CMD_UFW="/usr/sbin/ufw"

# Couleurs
BLUE=$'\033[0;34m'
GREEN=$'\033[0;32m'
RED=$'\033[0;31m'
YELLOW=$'\033[1;33m'
CYAN=$'\033[0;36m'
GREY=$'\033[1;30m'
NC=$'\033[0m'
BOLD=$'\033[1m'

# CrÃ©ation des dossiers si inexistants
mkdir -p "$PLAYBOOKS_DIR" "$ROLES_DIR"

# =======================================================
# FONCTIONS UTILITAIRES
# =======================================================

pause() {
    echo ""
    read -p "EntrÃ©e pour continuer..."
}

ask_sudo_gui() {
    if sudo -n true 2>/dev/null; then return 0; fi
    echo -e "\n${YELLOW}ðŸ”’ Authentification requise (Sudo)${NC}"
    read -s -p "Mot de passe : " user_pass
    echo ""
    echo "$user_pass" | sudo -S -v 2>/dev/null
    if [ $? -eq 0 ]; then return 0;
    else
        echo -e "${RED}âŒ Mot de passe incorrect.${NC}"
        pause
        return 1
    fi
}

run_as_root() {
    if ask_sudo_gui; then sudo "$@"; return $?; fi
    return 1
}

get_sys_info() {
    LOCAL_IP=$(hostname -I | awk '{print $1}')
    PUBLIC_IP=$(curl -s -4 -m 1 https://icanhazip.com 2>/dev/null)
    [[ ! "$PUBLIC_IP" =~ ^[0-9.]+$ ]] && PUBLIC_IP="N/A"

    OS_NAME=$(grep -oP 'PRETTY_NAME="\K[^"]+' /etc/os-release 2>/dev/null | cut -c1-20)
    [ -z "$OS_NAME" ] && OS_NAME="Linux"

    CPU_USAGE=$(top -bn1 | grep "Cpu(s)" | sed "s/.*, *\([0-9.]*\)%* id.*/\1/" | awk '{print 100 - $1"%"}' 2>/dev/null)
    [ -z "$CPU_USAGE" ] && CPU_USAGE="N/A"
    RAM_USAGE=$(free -h | awk '/^Mem:/ {print $3 "/" $2}')
    SYS_UPTIME=$(uptime -p | sed 's/up //;s/ hours/h/;s/ minutes/m/;s/ days/j/')
    
    APP_VER=$(ansible --version 2>/dev/null | head -n1 | awk '{print $NF}' | tr -d ']')

    if systemctl is-active --quiet cron; then SX="${GREEN}â— ACTIF${NC}"; else SX="${RED}â— OFF${NC}"; fi
    if systemctl is-active --quiet ufw; then FW="${GREEN}â— ACTIF${NC}"; else FW="${RED}â— INACTIF${NC}"; fi
}

ensure_git() {
    if ! command -v git &> /dev/null; then
        echo -e "${YELLOW}Git n'est pas installÃ©.${NC}"
        read -p "L'installer ? (o/n) " i
        if [ "$i" == "o" ]; then run_as_root apt update && run_as_root apt install -y git; else return 1; fi
    fi
    return 0
}

# =======================================================
# MODULE : ASSISTANT DE DÃ‰VELOPPEMENT (Wizard)
# =======================================================
module_assistant_dev() {
    cd "$ANSIBLE_ROOT" || return

    _create_role_wizard() {
        echo -e "\n${CYAN}--- CRÃ‰ATION DE RÃ”LE ---${NC}"
        read -p "Nom du rÃ´le (ex: apache, docker) : " rname
        [ -z "$rname" ] && return
        
        target="$ROLES_DIR/$rname"
        if [ -d "$target" ]; then echo -e "${RED}Erreur: Le dossier existe dÃ©jÃ .${NC}"; pause; return; fi

        mkdir -p "$target"/{tasks,handlers,defaults,vars,templates,files,meta}
        for d in tasks handlers defaults vars meta; do
            echo "---" > "$target/$d/main.yml"
        done

        echo -e "${GREEN}âœ… Structure crÃ©Ã©e dans roles/$rname${NC}"

        read -p "CrÃ©er un playbook pour lancer ce rÃ´le ? (o/n) " cp
        if [ "$cp" == "o" ]; then
            pb_file="$PLAYBOOKS_DIR/deploy_$rname.yml"
            cat > "$pb_file" <<EOF
---
- name: Deploiement de $rname
  hosts: all
  become: yes
  roles:
    - $rname
EOF
            echo -e "${GREEN}âœ… Playbook crÃ©Ã© : playbooks/deploy_$rname.yml${NC}"
        fi
        pause
    }

    _create_playbook_wizard() {
        echo -e "\n${CYAN}--- CRÃ‰ATION DE PLAYBOOK ---${NC}"
        read -p "Nom du playbook (sans extension) : " pname
        [ -z "$pname" ] && return
        pname="${pname%.yml}.yml"
        target="$PLAYBOOKS_DIR/$pname"

        if [ -f "$target" ]; then echo -e "${RED}Fichier existant.${NC}"; pause; return; fi

        cat > "$target" <<EOF
---
- name: Nouveau Playbook
  hosts: all
  become: yes
  tasks:
    - name: Test ping
      ping:
EOF
        echo -e "${GREEN}âœ… Fichier crÃ©Ã© : $target${NC}"
        read -p "L'Ã©diter maintenant ? (o/n) " ed
        [ "$ed" == "o" ] && nano "$target"
    }

    _select_role_target() {
        mapfile -t roles < <(ls -1 "$ROLES_DIR")
        if [ ${#roles[@]} -eq 0 ]; then echo "Aucun rÃ´le trouvÃ©."; return 1; fi
        echo "SÃ©lectionnez le rÃ´le cible :"
        for i in "${!roles[@]}"; do echo "[$i] ${roles[$i]}"; done
        read -p "> " idx
        if [[ "$idx" =~ ^[0-9]+$ ]] && [ -n "${roles[$idx]}" ]; then
            SELECTED_ROLE="${roles[$idx]}"
            return 0
        fi
        return 1
    }

    _add_task_wizard() {
        echo -e "\n${CYAN}--- AJOUT DE TÃ‚CHE (Action) ---${NC}"
        _select_role_target || { pause; return; }
        
        echo "Dossier cible ?"
        echo "1. tasks (Actions principales)"
        echo "2. handlers (Actions sur notification)"
        read -p "> " dchoice
        
        case "$dchoice" in
            1) target_file="$ROLES_DIR/$SELECTED_ROLE/tasks/main.yml" ;;
            2) target_file="$ROLES_DIR/$SELECTED_ROLE/handlers/main.yml" ;;
            *) return ;;
        esac

        echo -e "\n${YELLOW}Ajout Ã  la fin de $target_file${NC}"
        read -p "Nom de la tÃ¢che : " tname
        read -p "Module (ex: apt, copy, service) : " tmod
        
        echo "" >> "$target_file"
        echo "- name: $tname" >> "$target_file"
        echo "  $tmod:" >> "$target_file"
        echo "    # TODO: arguments pour $tmod" >> "$target_file"
        
        echo -e "${GREEN}âœ… Squelette ajoutÃ©.${NC}"
        read -p "Ã‰diter pour complÃ©ter ? (o/n) " ed
        [ "$ed" == "o" ] && nano "$target_file"
    }

    _add_var_wizard() {
        echo -e "\n${CYAN}--- AJOUT DE VARIABLE (Config) ---${NC}"
        _select_role_target || { pause; return; }
        
        echo "Dossier cible ?"
        echo "1. defaults (Valeurs par dÃ©faut)"
        echo "2. vars (PrioritÃ© haute)"
        read -p "> " dchoice
        
        case "$dchoice" in
            1) target_file="$ROLES_DIR/$SELECTED_ROLE/defaults/main.yml" ;;
            2) target_file="$ROLES_DIR/$SELECTED_ROLE/vars/main.yml" ;;
            *) return ;;
        esac

        echo -e "\n${YELLOW}Ajout dans $target_file${NC}"
        read -p "Nom variable (ex: port_http) : " vname
        read -p "Valeur : " vval
        
        echo "" >> "$target_file"
        echo "$vname: $vval" >> "$target_file"
        echo -e "${GREEN}âœ… AjoutÃ©.${NC}"
        sleep 1
    }

    _delete_wizard() {
        echo -e "\n${RED}--- SUPPRESSION ---${NC}"
        echo "1. Supprimer un RÃ´le"
        echo "2. Supprimer un Playbook"
        read -p "> " delc
        
        case "$delc" in
            1)
                _select_role_target || { pause; return; }
                read -p "Supprimer DÃ‰FINITIVEMENT '$SELECTED_ROLE' ? (oui/non) " c
                if [ "$c" == "oui" ]; then rm -rf "$ROLES_DIR/$SELECTED_ROLE"; echo "Fait."; pause; fi
                ;;
            2)
                mapfile -t pbs < <(find "$PLAYBOOKS_DIR" -maxdepth 1 -name "*.yml" -printf "%f\n")
                if [ ${#pbs[@]} -eq 0 ]; then echo "Vide."; pause; return; fi
                for i in "${!pbs[@]}"; do echo "[$i] ${pbs[$i]}"; done
                read -p "NumÃ©ro : " idx
                if [[ "$idx" =~ ^[0-9]+$ ]] && [ -n "${pbs[$idx]}" ]; then
                    p="${pbs[$idx]}"
                    read -p "Supprimer '$p' ? (oui/non) " c
                    if [ "$c" == "oui" ]; then rm "$PLAYBOOKS_DIR/$p"; echo "Fait."; pause; fi
                fi
                ;;
        esac
    }

    while true; do
        clear
        echo -e "${BLUE}=== ASSISTANT DÃ‰VELOPPEMENT ===${NC}"
        echo -e "  ${GREEN}1.${NC} âœ¨ CrÃ©er un nouveau RÃ´le"
        echo -e "  ${GREEN}2.${NC} ðŸ“„ CrÃ©er un nouveau Playbook"
        echo "-----------------------------------"
        echo -e "  ${YELLOW}3.${NC} âž• Ajouter une TÃ¢che (Action)"
        echo -e "  ${YELLOW}4.${NC} ðŸ’² Ajouter une Variable (Config)"
        echo "-----------------------------------"
        echo -e "  ${RED}5.${NC} ðŸ—‘ï¸  Supprimer (RÃ´le ou Playbook)"
        echo -e "  ${RED}0.${NC} Retour"
        echo ""
        read -p "> " c
        case "$c" in
            1) _create_role_wizard ;;
            2) _create_playbook_wizard ;;
            3) _add_task_wizard ;;
            4) _add_var_wizard ;;
            5) _delete_wizard ;;
            0) return ;;
        esac
    done
}

# =======================================================
# MODULE : SAUVEGARDE & GIT
# =======================================================
module_backup_git() {
    cd "$ANSIBLE_ROOT" || return

    _backup_local() {
        if ! ask_sudo_gui; then return; fi
        D=$(date +%Y%m%d_%H%M%S)
        FILE="$BACKUP_DIR/ansible_backup_$D.tar.gz"
        
        sudo mkdir -p "$BACKUP_DIR"
        echo -e "${CYAN}CrÃ©ation de l'archive locale...${NC}"
        tar --exclude='.git' --exclude='*.retry' -czf "/tmp/ansible_temp.tar.gz" .
        sudo mv "/tmp/ansible_temp.tar.gz" "$FILE"
        echo -e "${GREEN}âœ… Sauvegarde rÃ©ussie :${NC} $FILE"
        pause
    }

    _config_git() {
        ensure_git || return
        echo -e "\n${CYAN}--- CONFIGURATION GIT & BRANCHES ---${NC}"
        
        # 1. INIT
        if [ ! -d ".git" ]; then git init; else echo "DÃ©pÃ´t local dÃ©jÃ  initialisÃ©."; fi

        # 2. USER
        cuser=$(git config user.name)
        if [ -z "$cuser" ]; then
            read -p "Votre Nom : " gname
            read -p "Votre Email : " gemail
            git config user.name "$gname"
            git config user.email "$gemail"
        fi

        # 3. REMOTE URL
        cremote=$(git remote get-url origin 2>/dev/null)
        if [ -z "$cremote" ]; then
            read -p "URL dÃ©pÃ´t (https/ssh) : " gurl
            [ -n "$gurl" ] && git remote add origin "$gurl"
        else
            echo -e "Remote actuel : ${GREY}$cremote${NC}"
            read -p "Changer URL ? (o/n) " chg
            if [ "$chg" == "o" ]; then
                read -p "Nouvelle URL : " nurl
                git remote set-url origin "$nurl"
            fi
        fi

        # 4. CONFIGURATION DES BRANCHES (Local & Distant)
        echo -e "\n${YELLOW}--- Configuration des Branches ---${NC}"
        current_branch=$(git rev-parse --abbrev-ref HEAD 2>/dev/null || echo "master")
        
        echo "Le standard actuel est 'main'. Votre branche actuelle est '$current_branch'."
        read -p "Nom de la branche principale souhaitÃ©e (DÃ©faut: main) : " target_branch
        [ -z "$target_branch" ] && target_branch="main"

        # Renommage Local (Force le nom)
        if [ "$current_branch" != "$target_branch" ]; then
            echo -e "${GREY}Renommage local de '$current_branch' vers '$target_branch'...${NC}"
            git branch -M "$target_branch"
        else
            echo -e "${GREEN}Branche locale '$target_branch' OK.${NC}"
        fi

        # Tentative de liaison Remote (Upstream)
        echo -e "${GREY}VÃ©rification du dÃ©pÃ´t distant...${NC}"
        if git fetch origin 2>/dev/null; then
            # Le remote rÃ©pond, on regarde si la branche existe
            if git ls-remote --exit-code --heads origin "$target_branch" >/dev/null 2>&1; then
                git branch --set-upstream-to=origin/"$target_branch" "$target_branch"
                echo -e "${GREEN}âœ… Liaison Ã©tablie : local/$target_branch <-> origin/$target_branch${NC}"
            else
                echo -e "${YELLOW}La branche '$target_branch' n'existe pas encore sur le serveur.${NC}"
                echo "Elle sera crÃ©Ã©e automatiquement lors du prochain Push."
            fi
        else
            echo -e "${RED}Impossible de joindre le dÃ©pÃ´t distant.${NC}"
            echo "VÃ©rifiez l'URL ou votre connexion. La config sera appliquÃ©e au prochain Push."
        fi
        
        pause
    }

    _push_git() {
        ensure_git || return
        if [ ! -d ".git" ]; then echo -e "${RED}Pas de dÃ©pÃ´t git.${NC}"; pause; return; fi

        # Config identitÃ© si manquante
        if [ -z "$(git config user.email)" ]; then
            echo -e "${RED}IdentitÃ© Git manquante.${NC}"
            _config_git
            return
        fi

        echo -e "\n${CYAN}--- SYNCHRONISATION GITHUB (PUSH) ---${NC}"
        
        # Fetch silencieux
        git fetch origin > /dev/null 2>&1

        # 1. Check Local Changes
        git update-index -q --refresh
        STATUS_PORCELAIN=$(git status --porcelain)
        NEEDS_PUSH=0

        if [ -n "$STATUS_PORCELAIN" ]; then
            echo -e "${YELLOW}âš ï¸  Modifications locales dÃ©tectÃ©es :${NC}"
            git status -s
            echo ""
            read -p "CrÃ©er un COMMIT maintenant ? (o/n) " conf
            if [ "$conf" == "o" ]; then
                read -p "Message commit : " msg
                [ -z "$msg" ] && msg="Update via Ansible Manager $(date)"
                git add -A
                if git commit -m "$msg"; then
                    echo -e "${GREEN}Commit crÃ©Ã©.${NC}"
                    NEEDS_PUSH=1
                else
                    echo -e "${RED}Erreur lors du commit.${NC}"; pause; return
                fi
            fi
        else
            echo -e "${GREEN}Aucun fichier en attente de commit.${NC}"
        fi

        # 2. Check Ahead
        CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD)
        UNPUSHED_COUNT=$(git rev-list origin/$CURRENT_BRANCH..HEAD --count 2>/dev/null)
        
        if [ -n "$UNPUSHED_COUNT" ] && [ "$UNPUSHED_COUNT" -gt 0 ]; then
            echo -e "\n${YELLOW}Vous avez $UNPUSHED_COUNT commit(s) prÃªts Ã  Ãªtre envoyÃ©s.${NC}"
            NEEDS_PUSH=1
        fi

        # 3. Action Push (avec fallback intelligent si remote manquant)
        if [ "$NEEDS_PUSH" == "1" ]; then
            echo ""
            read -p "Envoyer vers GitHub (Push) ? (o/n) " cp
            if [ "$cp" == "o" ]; then
                echo -e "${CYAN}Push vers origin/$CURRENT_BRANCH...${NC}"
                
                # Push standard
                if git push origin "$CURRENT_BRANCH" 2>/dev/null; then
                    echo -e "${GREEN}âœ… Push rÃ©ussi.${NC}"
                else
                    # Fallback : Premier push / Set Upstream
                    echo -e "${YELLOW}Premier envoi dÃ©tectÃ© pour '$CURRENT_BRANCH'. Configuration upstream...${NC}"
                    if git push -u origin "$CURRENT_BRANCH"; then
                        echo -e "${GREEN}âœ… Push rÃ©ussi et branche configurÃ©e !${NC}"
                    else
                        echo -e "${RED}âŒ Ã‰chec du push.${NC}"
                    fi
                fi
            else
                echo "Push reportÃ©."
            fi
        else
            if [ -z "$STATUS_PORCELAIN" ]; then
                echo -e "${GREEN}âœ… Tout est synchronisÃ©.${NC}"
            fi
        fi
        pause
    }

    _pull_git() {
        ensure_git || return
        echo -e "\n${CYAN}--- PULL (MISE Ã€ JOUR) ---${NC}"
        
        current_branch=$(git rev-parse --abbrev-ref HEAD)
        
        # Essai standard
        if git pull > /dev/null 2>&1; then
            echo -e "${GREEN}âœ… DÃ©pÃ´t mis Ã  jour avec succÃ¨s.${NC}"
        else
            echo -e "${YELLOW}âš ï¸  Le pull standard a Ã©chouÃ©.${NC}"
            echo -e "Tentative de rÃ©paration du lien avec origin/$current_branch..."
            
            # Essai forcÃ© avec nom de branche explicite
            if git pull origin "$current_branch"; then
                echo -e "${GREEN}âœ… SuccÃ¨s !${NC}"
                git branch --set-upstream-to=origin/"$current_branch" "$current_branch" 2>/dev/null
                echo -e "${GREY}Lien permanent rÃ©tabli.${NC}"
            else
                echo -e "${RED}âŒ Ã‰chec critique (Conflit ou branche distante inexistante).${NC}"
                echo "Essayez de lancer le menu '2. Configurer DÃ©pÃ´t GitHub' pour vÃ©rifier les branches."
            fi
        fi
        pause
    }

    _rollback_git() {
        ensure_git || return
        while true; do
            clear
            echo -e "${RED}=== ANNULATION / ROLLBACK ===${NC}"
            echo -e "${GREY}Attention : ces actions peuvent dÃ©truire des donnÃ©es.${NC}"
            echo ""
            echo "1. Annuler les modifications NON commitÃ©es (Discard Changes)"
            echo "2. Annuler le dernier commit (Garder les fichiers) (Soft Reset)"
            echo "3. âš ï¸  RÃ©initialiser TOTALEMENT sur le dÃ©pÃ´t distant (Hard Reset)"
            echo "0. Retour"
            read -p "> " c
            case "$c" in
                1)
                    read -p "Voulez-vous supprimer toutes les modifications en cours ? (o/n) " conf
                    if [ "$conf" == "o" ]; then
                        git checkout .
                        git clean -fd
                        echo -e "${GREEN}Modifications annulÃ©es.${NC}"
                        pause
                    fi
                    ;;
                2)
                    read -p "Annuler le dernier commit mais garder les fichiers modifiÃ©s ? (o/n) " conf
                    if [ "$conf" == "o" ]; then
                        git reset --soft HEAD~1
                        echo -e "${GREEN}Dernier commit annulÃ©. Fichiers prÃ©servÃ©s.${NC}"
                        pause
                    fi
                    ;;
                3)
                    read -p "âš ï¸  DANGER: Cela va effacer TOUT ce qui n'est pas sur GitHub. SÃ»r ? (taper 'OUI') " conf
                    if [ "$conf" == "OUI" ]; then
                        git fetch origin
                        current=$(git rev-parse --abbrev-ref HEAD)
                        if ! git rev-parse "origin/$current" >/dev/null 2>&1; then
                             echo "${YELLOW}Branche distante introuvable. Essai sur origin/main...${NC}"
                             current="main"
                        fi
                        git reset --hard origin/$current
                        echo -e "${GREEN}DÃ©pÃ´t rÃ©initialisÃ© sur origin/$current.${NC}"
                        pause
                    fi
                    ;;
                0) return ;;
            esac
        done
    }

    _lazygit_mode() {
        if ! command -v lazygit &> /dev/null; then
            echo -e "${YELLOW}Lazygit n'est pas installÃ©.${NC}"
            read -p "L'installer automatiquement ? (o/n) " inst
            if [ "$inst" == "o" ]; then
                if ask_sudo_gui; then
                   echo "Installation de la derniÃ¨re version..."
                   LAZYGIT_VERSION=$(curl -s "https://api.github.com/repos/jesseduffield/lazygit/releases/latest" | grep -Po '"tag_name": "v\K[^"]*')
                   curl -Lo lazygit.tar.gz "https://github.com/jesseduffield/lazygit/releases/latest/download/lazygit_${LAZYGIT_VERSION}_Linux_x86_64.tar.gz"
                   tar xf lazygit.tar.gz lazygit
                   sudo install lazygit /usr/local/bin
                   rm lazygit.tar.gz lazygit
                   echo -e "${GREEN}Lazygit installÃ© !${NC}"
                   sleep 1
                else
                   return
                fi
            else
                return
            fi
        fi

        echo -e "${GREEN}Ouverture de Lazygit...${NC}"
        trap - SIGINT SIGQUIT SIGTSTP
        lazygit
        trap '' SIGINT SIGQUIT SIGTSTP
    }

    while true; do
        clear
        echo -e "${BLUE}=== SAUVEGARDES & GIT ===${NC}"
        echo -e "  ${GREEN}1.${NC} ðŸ’¾ Sauvegarde Locale (Tar.gz)"
        echo -e "  ${GREEN}2.${NC} âš™ï¸  Configurer DÃ©pÃ´t GitHub (Init/Branches)"
        echo -e "  ${GREEN}3.${NC} ðŸš€ Synchroniser (Push)"
        echo -e "  ${GREEN}4.${NC} â¬‡ï¸  Mettre Ã  jour (Pull)"
        echo -e "  ${YELLOW}5.${NC} ðŸ”™ Rollback / Annuler"
        echo -e "  ${CYAN}6.${NC} ðŸ¢ Terminal AvancÃ© (Lazygit)"
        echo -e "  ${RED}0.${NC} Retour"
        echo ""
        read -p "> " c
        case "$c" in
            1) _backup_local ;;
            2) _config_git ;;
            3) _push_git ;;
            4) _pull_git ;;
            5) _rollback_git ;;
            6) _lazygit_mode ;;
            0) return ;;
        esac
    done
}

# =======================================================
# MODULES SIMPLES (Launcher, Cron, etc.)
# =======================================================
module_launcher() {
    cd "$ANSIBLE_ROOT" || return
    _get_desc() {
        local f="$1"
        local d=$(grep "^$f|" "$DESC_FILE" 2>/dev/null | cut -d'|' -f2-)
        [ -n "$d" ] && echo "$d" || echo "${GREY}Sans description${NC}"
    }

    mapfile -t files < <(find "$PLAYBOOKS_DIR" -maxdepth 1 -name "*.yml" -printf "%f\n" | sort)
    if [ ${#files[@]} -eq 0 ]; then echo -e "${RED}Aucun playbook.${NC}"; pause; return; fi

    local i=0
    echo -e "${BLUE}--- SÃ‰LECTIONNER UN PLAYBOOK ---${NC}"
    for f in "${files[@]}"; do
        printf "%-3s | %-25s | %s\n" "[$i]" "${f:0:25}" "$(_get_desc "$f")"
        ((i++))
    done
    
    echo "0. Retour"
    read -p "NumÃ©ro : " idx
    if [ "$idx" == "0" ]; then return; fi
    if [[ "$idx" =~ ^[0-9]+$ ]] && [ "$idx" -lt "${#files[@]}" ]; then
        sel="${files[$idx]}"
        echo -e "\n${GREEN}>>> Lancement de $sel${NC}"
        ansible-playbook "$PLAYBOOKS_DIR/$sel"
        pause
    fi
}

module_cron() {
    if ! ask_sudo_gui; then return; fi
    while true; do
        clear; echo -e "${BLUE}=== CRON ===${NC}"
        echo "1. Ã‰diter crontab root"
        echo "2. Lister crontab root"
        echo "0. Retour"
        read -p "> " c
        case $c in
            1) sudo crontab -e ;;
            2) sudo crontab -l; pause ;;
            0) return ;;
        esac
    done
}

module_vault() {
    export EDITOR="/usr/bin/nano"
    if [ ! -f "$VAULT_PASS_FILE" ]; then echo "Pas de fichier .vault_pass"; pause; return; fi
    while true; do
        clear; echo -e "${BLUE}=== VAULT ===${NC}"
        echo "1. Encrypt File"
        echo "2. Decrypt File"
        echo "3. Edit Encrypted File"
        echo "0. Retour"
        read -p "> " c
        case $c in
            1) read -p "File: " f; ansible-vault encrypt "$f"; pause ;;
            2) read -p "File: " f; ansible-vault decrypt "$f"; pause ;;
            3) read -p "File: " f; ansible-vault edit "$f"; ;;
            0) return ;;
        esac
    done
}

module_inventory() {
    while true; do
        clear; echo -e "${BLUE}=== INVENTAIRE ===${NC}"
        echo "1. Graphique"
        echo "2. Liste"
        echo "3. Ping All"
        echo "0. Retour"
        read -p "> " c
        case $c in
            1) ansible-inventory --graph; pause ;;
            2) ansible-inventory --list; pause ;;
            3) ansible all -m ping; pause ;;
            0) return ;;
        esac
    done
}

module_jail() {
    echo -e "\n${GREEN}Shell Restreint dans $ANSIBLE_ROOT${NC}"
    echo "Tapez 'exit' pour sortir."
    bash --rcfile <(echo "PS1='(Jail) \w\$ '; cd $ANSIBLE_ROOT")
}

module_firewall() {
    if ! ask_sudo_gui; then return; fi
    while true; do
        clear; echo -e "${BLUE}=== UFW ===${NC}"
        sudo ufw status numbered
        echo "----------------"
        echo "1. Allow Port"
        echo "2. Delete Rule"
        echo "0. Retour"
        read -p "> " c
        case $c in
            1) read -p "Port: " p; sudo ufw allow "$p"; pause ;;
            2) read -p "Num: " n; sudo ufw delete "$n"; pause ;;
            0) return ;;
        esac
    done
}

module_updates() {
    if ask_sudo_gui; then
        sudo apt update && sudo apt upgrade -y
        pause
    fi
}

module_power() {
    local a="$1"
    if [ "$a" == "ETEINDRE" ]; then sudo poweroff; fi
    if [ "$a" == "REDEMARRER" ]; then sudo reboot; fi
}

open_user_shell() {
    if ! ask_sudo_gui; then return; fi
    echo -e "\n${GREEN}ðŸ”“ Console Admin.${NC} 'exit' pour revenir."
    trap - SIGINT SIGQUIT SIGTSTP
    export SKIP_KIOSK=1
    cd "$ANSIBLE_ROOT" || cd "$HOME"
    bash --login
    unset SKIP_KIOSK
    trap '' SIGINT SIGQUIT SIGTSTP
}

# =======================================================
# MENU PRINCIPAL (Main Loop)
# =======================================================
SEP="${BLUE}------------------------------------------------${NC}"
SEP_RED="${RED}------------------------------------------------${NC}"

while true; do
    clear
    get_sys_info
    
    # Header
    echo -e "${BLUE}###################################${NC}"
    echo -e "${BLUE}#       ANSIBLE MANAGER           #${NC}"
    echo -e "${BLUE}###################################${NC}"
    
    printf "  ðŸ–¥ï¸  ${CYAN}%-29s${NC} | â±ï¸  ${GREY}%s${NC}\n" "$OS_NAME" "$SYS_UPTIME"
    printf "  ðŸ§  CPU: ${YELLOW}%-23s${NC} | ðŸ’¾ RAM: ${YELLOW}%s${NC}\n" "$CPU_USAGE" "$RAM_USAGE"
    printf "  ðŸ  LAN: ${YELLOW}%-23s${NC} | ðŸŒ WAN: ${YELLOW}%s${NC}\n" "$LOCAL_IP" "$PUBLIC_IP"
    echo -e "$SEP"
    printf "  â° Automate : %-20b | ðŸ›¡ï¸  Pare-feu : %s\n" "$SX" "$FW"
    printf "  â„¹ï¸  Ansible  : %-20s | ðŸ“ Racine    : %s\n" "${CYAN}$APP_VER${NC}" "$(basename "$ANSIBLE_HOME")"
    echo -e "$SEP"

    # --- SECTION DÃ‰VELOPPEMENT & AUTOMATISATION ---
    echo -e " ${BOLD}${CYAN}ðŸš€ DÃ‰VELOPPEMENT & OPÃ‰RATIONS${NC}"
    echo -e "    ${GREEN}1.${NC} ðŸ§™ Assistant CrÃ©ation (RÃ´les/Tasks/Config)"
    echo -e "    ${GREEN}2.${NC} â–¶ï¸  Lancer un Playbook"
    echo -e "    ${GREEN}3.${NC} ðŸ’¾ Sauvegardes & Git (Backup/Push/Rollback)"
    echo -e "    ${GREEN}4.${NC} ðŸ” Gestion des Secrets (Vault)"
    echo ""

    # --- SECTION OUTILS ---
    echo -e " ${BOLD}${CYAN}ðŸ› ï¸  OUTILS${NC}"
    echo -e "    ${GREEN}5.${NC} ðŸŒ Inventaire"
    echo -e "    ${GREEN}6.${NC} â° TÃ¢ches Cron"
    echo -e "    ${GREEN}7.${NC} ðŸ§± Pare-feu (UFW)"
    echo -e "    ${GREEN}8.${NC} ðŸ”’ Shell Restreint (Jail)"
    echo -e "    ${GREEN}9.${NC} ðŸ“¦ Mises Ã  jour SystÃ¨me"
    
    echo -e "$SEP_RED"
    
    # --- SECTION SYSTÃˆME ---
    echo -e " ${BOLD}${RED}ðŸ’€ SYSTÃˆME${NC}"
    echo -e "    ${RED}10.${NC}ðŸ”Œ Ã‰teindre"
    echo -e "    ${RED}11.${NC}â™»ï¸  RedÃ©marrer"
    echo -e "$SEP"
    echo -e "  [${YELLOW}admin${NC}] ðŸ’» Console Admin    |    [${RED}exit${NC}] ðŸšª Quitter"
    echo -e "$SEP"

    read -r -p "  Votre choix > " choice

    case "$choice" in
        1) module_assistant_dev ;;
        2) module_launcher ;;
        3) module_backup_git ;;
        4) module_vault ;;
        5) module_inventory ;;
        6) module_cron ;;
        7) module_firewall ;;
        8) module_jail ;;
        9) module_updates ;;
        10) module_power "ETEINDRE" ;;
        11) module_power "REDEMARRER" ;;
        admin) open_user_shell ;;
        exit|q) echo "Bye."; exit 0 ;;
        *) echo "Choix invalide."; sleep 0.5 ;;
    esac
done
