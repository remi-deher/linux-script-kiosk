#!/bin/bash
# =========================
#  MANAGER ANSIBLE
# =========================

# --- SÃ‰CURITÃ‰ : EmpÃªcher la sortie accidentelle ---
trap '' SIGINT SIGQUIT SIGTSTP

# =======================================================
# CONFIGURATION GLOBALE
# =======================================================

if [ -z "$ANSIBLE_HOME" ]; then
    export ANSIBLE_HOME="$HOME/ansible"
fi

export ANSIBLE_ROOT=$(readlink -f "$ANSIBLE_HOME")
export ANSIBLE_CONFIG="$ANSIBLE_ROOT/ansible.cfg"

# Chemins internes
PLAYBOOKS_DIR="$ANSIBLE_ROOT/playbooks"
DESC_FILE="$PLAYBOOKS_DIR/.descriptions"
VAULT_PASS_FILE="$ANSIBLE_ROOT/.vault_pass"
CMD_UFW="/usr/sbin/ufw"

# Couleurs (Correction: ajout de $ pour interprÃ©tation ANSI)
BLUE=$'\033[0;34m'
GREEN=$'\033[0;32m'
RED=$'\033[0;31m'
YELLOW=$'\033[1;33m'
CYAN=$'\033[0;36m'
GREY=$'\033[1;30m'
NC=$'\033[0m'
BOLD=$'\033[1m'

# =======================================================
# FONCTIONS UTILITAIRES
# =======================================================

pause() {
    echo ""
    read -p "EntrÃ©e pour continuer..."
}

ask_sudo_gui() {
    if sudo -n true 2>/dev/null; then return 0; fi
    echo -e "\n${YELLOW}ðŸ”’ Authentification requise (Sudo)${NC}"
    read -s -p "Mot de passe : " user_pass
    echo ""
    echo "$user_pass" | sudo -S -v 2>/dev/null
    if [ $? -eq 0 ]; then return 0;
    else
        echo -e "${RED}âŒ Mot de passe incorrect.${NC}"
        pause
        return 1
    fi
}

run_as_root() {
    if ask_sudo_gui; then sudo "$@"; return $?; fi
    return 1
}

# --- RÃ‰CUPÃ‰RATION DES INFOS SYSTÃˆME ---
get_sys_info() {
    # 1. IP
    LOCAL_IP=$(hostname -I | awk '{print $1}')
    PUBLIC_IP=$(curl -s -4 -m 1 https://icanhazip.com 2>/dev/null)
    [[ ! "$PUBLIC_IP" =~ ^[0-9.]+$ ]] && PUBLIC_IP="N/A"

    # 2. OS
    OS_NAME=$(grep -oP 'PRETTY_NAME="\K[^"]+' /etc/os-release 2>/dev/null | cut -c1-20)
    [ -z "$OS_NAME" ] && OS_NAME="Linux"

    # 3. CPU/RAM
    CPU_USAGE=$(top -bn1 | grep "Cpu(s)" | sed "s/.*, *\([0-9.]*\)%* id.*/\1/" | awk '{print 100 - $1"%"}' 2>/dev/null)
    [ -z "$CPU_USAGE" ] && CPU_USAGE="N/A"
    RAM_USAGE=$(free -h | awk '/^Mem:/ {print $3 "/" $2}')

    # 4. Uptime
    SYS_UPTIME=$(uptime -p | sed 's/up //;s/ hours/h/;s/ minutes/m/;s/ days/j/')
    
    # 5. Version Ansible
    APP_VER=$(ansible --version 2>/dev/null | head -n1 | awk '{print $NF}' | tr -d ']')

    # 6. Status Services (Cron & UFW)
    if systemctl is-active --quiet cron; then 
        SX="${GREEN}â— ACTIF${NC}"
    else 
        SX="${RED}â— OFF${NC}"
    fi

    if systemctl is-active --quiet ufw; then
        FW="${GREEN}â— ACTIF${NC}"
    else
        FW="${RED}â— INACTIF${NC}"
    fi
}

# =======================================================
# MODULE : LANCEUR DE PLAYBOOK (Launcher)
# =======================================================
module_launcher() {
    local main_choice
    local SELECTED_FILE
    
    cd "$ANSIBLE_ROOT" || return

    _get_desc() {
        local filename="$1"
        local saved_desc=$(grep "^$filename|" "$DESC_FILE" 2>/dev/null | cut -d'|' -f2-)
        if [ -n "$saved_desc" ]; then
            echo "$saved_desc"
        else
            local yaml_name=$(grep -m 1 "name:" "$PLAYBOOKS_DIR/$filename" 2>/dev/null | sed -E 's/.*name:\s*"?([^"]+)"?/\1/' | sed 's/^[ \t]*//')
            if [ -n "$yaml_name" ]; then echo "${GREY}(YAML) $yaml_name${NC}"; else echo "${GREY}Aucune description${NC}"; fi
        fi
    }

    _save_desc() {
        if [ ! -f "$DESC_FILE" ]; then touch "$DESC_FILE"; fi
        sed -i "/^$1|/d" "$DESC_FILE"
        echo "$1|$2" >> "$DESC_FILE"
    }

    _select_playbook() {
        local title="$1"
        mapfile -t files < <(find "$PLAYBOOKS_DIR" -maxdepth 1 -type f -name "*.yml" -printf "%f\n" 2>/dev/null | sort)
        
        if [ ${#files[@]} -eq 0 ]; then echo -e "${RED}Aucun playbook trouvÃ©.${NC}"; sleep 2; return 1; fi

        if command -v fzf &> /dev/null; then
            local list_fzf=""
            for f in "${files[@]}"; do
                d=$(_get_desc "$f")
                clean_d=$(echo "$d" | sed 's/\x1b\[[0-9;]*m//g')
                list_fzf+="$f :: $clean_d\n"
            done
            local sel=$(echo -e "$list_fzf" | fzf --height=40% --layout=reverse --border --header="--- $title ---" --delimiter=' :: ' --with-nth=1,2)
            if [ -z "$sel" ]; then return 1; fi
            SELECTED_FILE=$(echo "$sel" | awk -F ' :: ' '{print $1}')
            return 0
        else
            local i=0
            echo -e "${BLUE}--- $title ---${NC}"
            for f in "${files[@]}"; do
                printf "%-3s | %-25s | %s\n" "[$i]" "${f:0:25}" "$(_get_desc "$f")"
                ((i++))
            done
            read -p "NumÃ©ro : " idx
            if [[ "$idx" =~ ^[0-9]+$ ]] && [ "$idx" -lt "${#files[@]}" ]; then
                SELECTED_FILE="${files[$idx]}"
                return 0
            fi
            return 1
        fi
    }

    while true; do
        clear
        echo -e "${BLUE}=== LANCEUR DE PLAYBOOKS ===${NC}"
        echo "1. Lancer un playbook"
        echo "2. Modifier une description"
        echo "3. Supprimer un playbook"
        echo "r. Retour au menu principal"
        echo ""
        read -p "Choix > " main_choice

        case $main_choice in
            1)
                if _select_playbook "LANCEMENT"; then
                    echo -e "\n${GREEN}>>> ExÃ©cution de : $SELECTED_FILE${NC}"
                    ansible-playbook "$PLAYBOOKS_DIR/$SELECTED_FILE"
                    pause
                fi
                ;;
            2)
                if _select_playbook "MODIFIER DESC"; then
                    echo "Actuelle : $(_get_desc "$SELECTED_FILE")"
                    read -p "Nouvelle description : " new_d
                    [ -n "$new_d" ] && _save_desc "$SELECTED_FILE" "$new_d"
                fi
                ;;
            3)
                if _select_playbook "SUPPRIMER"; then
                    read -p "Confirmer suppression de $SELECTED_FILE ? (oui/non) " c
                    if [ "$c" == "oui" ]; then
                        rm "$PLAYBOOKS_DIR/$SELECTED_FILE"
                        sed -i "/^$SELECTED_FILE|/d" "$DESC_FILE"
                        echo "SupprimÃ©."; sleep 1
                    fi
                fi
                ;;
            r|q) return 0 ;;
        esac
    done
}

# =======================================================
# MODULE : GESTION DES CRONS (Scheduler)
# =======================================================
module_cron() {
    if ! ask_sudo_gui; then return; fi

    local TARGET_USER="root"
    if [ -f "$ANSIBLE_ROOT/group_vars/all.yml" ] && [ -f "$VAULT_PASS_FILE" ]; then
        local user_found=$(ansible-vault view "$ANSIBLE_ROOT/group_vars/all.yml" 2>/dev/null | grep "^cron_user:" | awk '{print $2}' | tr -d '"' | tr -d "'")
        [ -n "$user_found" ] && TARGET_USER="$user_found"
    fi

    local LOG_DIR="/var/log/ansible_cron"
    sudo mkdir -p "$LOG_DIR"
    sudo chown "$TARGET_USER" "$LOG_DIR"

    _translate_schedule() {
        local m=$1 h=$2 dom=$3 mon=$4 dow=$5
        if [[ "$m" == "*" && "$h" == "*" ]]; then echo "Toutes les minutes"
        elif [[ "$m" =~ ^\*/([0-9]+) ]]; then echo "Toutes les ${BASH_REMATCH[1]} min"
        elif [[ "$dow" != "*" && "$dom" == "*" ]]; then echo "Hebdo (J: $dow) Ã  $h:$m"
        elif [[ "$dom" != "*" ]]; then echo "Mensuel (Le $dom) Ã  $h:$m"
        else echo "$m $h $dom $mon $dow"; fi
    }

    _ask_schedule() {
         echo -e "${GREY}Format: Minute Heure JourMois Mois JourSemaine${NC}"
         read -p "Planning (ex: '0 2 * * *' pour 2h00 matin) : " sched
         if [ -z "$sched" ]; then sched="0 2 * * *"; fi
         RES_SCHEDULE="$sched"
    }

    _list_tasks() {
        echo -e "\n${BLUE}--- TÃ¢ches ($TARGET_USER) ---${NC}"
        sudo -u "$TARGET_USER" crontab -l 2>/dev/null | grep "ansible-playbook" | while read -r line; do
             echo "$line" | sed "s|$ANSIBLE_ROOT/playbooks/||" | cut -c1-60
        done
        echo ""
    }

    _add_task() {
        mapfile -t pbs < <(find "$PLAYBOOKS_DIR" -maxdepth 1 -type f -name "*.yml" -printf "%f\n" | sort)
        echo "SÃ©lectionnez un playbook :"
        local i=0
        for p in "${pbs[@]}"; do echo "[$i] $p"; ((i++)); done
        read -p "> " idx
        if [[ "$idx" =~ ^[0-9]+$ ]] && [ "$idx" -lt "${#pbs[@]}" ]; then
            local sel="${pbs[$idx]}"
            _ask_schedule
            read -p "Commentaire : " comm
            
            local cmd="cd $ANSIBLE_ROOT && /usr/bin/ansible-playbook playbooks/$sel >> $LOG_DIR/${sel}.log 2>&1"
            local cron_line="$RES_SCHEDULE $cmd # $comm"
            
            (sudo -u "$TARGET_USER" crontab -l 2>/dev/null; echo "$cron_line") | sudo -u "$TARGET_USER" crontab -
            echo -e "${GREEN}TÃ¢che ajoutÃ©e.${NC}"
        fi
    }

    _del_task() {
        echo "Pour supprimer, il est conseillÃ© d'Ã©diter manuellement pour l'instant."
        read -p "Ouvrir 'crontab -e' pour $TARGET_USER ? (o/n) " e
        if [ "$e" == "o" ]; then sudo -u "$TARGET_USER" crontab -e; fi
    }

    while true; do
        clear
        echo -e "${BLUE}=== PLANIFICATEUR DE TÃ‚CHES ===${NC}"
        echo "User cible : $TARGET_USER"
        echo "----------------------------"
        echo "1. Lister les tÃ¢ches"
        echo "2. Ajouter une tÃ¢che"
        echo "3. Ã‰diter manuellement"
        echo "r. Retour"
        read -p "> " c
        case $c in
            1) _list_tasks; pause ;;
            2) _add_task; pause ;;
            3) _del_task ;;
            r) return ;;
        esac
    done
}

# =======================================================
# MODULE : GESTION DES SECRETS (Vault)
# =======================================================
module_vault() {
    export EDITOR="/usr/bin/nano"
    if [ ! -f "$VAULT_PASS_FILE" ]; then
        echo -e "${RED}Erreur: .vault_pass introuvable.${NC}"; pause; return
    fi

    _select_vault_file() {
        local prompt="$1"
        mapfile -t files < <(find "$ANSIBLE_ROOT/group_vars" "$ANSIBLE_ROOT/inventory" -type f \( -name "*.yml" -o -name "*.yaml" \) 2>/dev/null | sort)
        
        echo -e "${BLUE}--- $prompt ---${NC}"
        local i=0
        for f in "${files[@]}"; do
            local rel=${f#$ANSIBLE_ROOT/}
            local status=""
            if grep -q "\$ANSIBLE_VAULT" "$f"; then status="${GREEN}[LOCK]${NC}"; else status="${GREY}[OPEN]${NC}"; fi
            echo -e "[$i] $rel $status"
            ((i++))
        done
        read -p "NumÃ©ro : " idx
        if [[ "$idx" =~ ^[0-9]+$ ]] && [ "$idx" -lt "${#files[@]}" ]; then
            SELECTED_VAULT_FILE="${files[$idx]}"
            return 0
        fi
        return 1
    }

    while true; do
        clear
        echo -e "${BLUE}=== GESTIONNAIRE DE SECRETS (VAULT) ===${NC}"
        echo "1. Ã‰diter (edit)"
        echo "2. Chiffrer (encrypt)"
        echo "3. DÃ©chiffrer (decrypt)"
        echo "4. Voir (view)"
        echo "r. Retour"
        read -p "> " c
        case $c in
            1) if _select_vault_file "Ã‰DITER"; then ansible-vault edit "$SELECTED_VAULT_FILE"; fi ;;
            2) if _select_vault_file "CHIFFRER"; then ansible-vault encrypt "$SELECTED_VAULT_FILE"; pause; fi ;;
            3) if _select_vault_file "DÃ‰CHIFFRER"; then ansible-vault decrypt "$SELECTED_VAULT_FILE"; pause; fi ;;
            4) if _select_vault_file "VOIR"; then ansible-vault view "$SELECTED_VAULT_FILE" | less; fi ;;
            r) return ;;
        esac
    done
}

# =======================================================
# MODULE : INVENTAIRE (Inventory)
# =======================================================
module_inventory() {
    cd "$ANSIBLE_ROOT" || return
    while true; do
        clear
        echo -e "${BLUE}=== EXPLORATEUR D'INVENTAIRE ===${NC}"
        echo "1. Graphique des groupes (Graph)"
        echo "2. Liste simple des hÃ´tes"
        echo "3. Tester le PING (tous)"
        echo "4. Voir les variables (Setup)"
        echo "r. Retour"
        read -p "> " c
        case $c in
            1) ansible-inventory --graph; pause ;;
            2) ansible-inventory --list | grep "ansible_host" -B 5 | less ;;
            3) ansible all -m ping; pause ;;
            4) 
               read -p "Nom de la machine : " h
               [ -n "$h" ] && ansible "$h" -m setup | less
               ;;
            r) return ;;
        esac
    done
}

# =======================================================
# MODULE : GÃ‰NÃ‰RATEUR DE RÃ”LE
# =======================================================
module_create_role() {
    echo -e "\n${GREEN}>>> GÃ©nÃ©rateur de RÃ´le Ansible${NC}"
    read -p "Nom du nouveau rÃ´le (ex: docker) : " role_name
    
    if [ -z "$role_name" ]; then echo "AnnulÃ©."; sleep 1; return; fi

    local target="$ANSIBLE_ROOT/roles/$role_name"
    if [ -d "$target" ]; then echo -e "${RED}Le rÃ´le existe dÃ©jÃ .${NC}"; pause; return; fi

    mkdir -p "$target"/{tasks,handlers,defaults,templates,files,vars,meta}
    echo "---" > "$target/tasks/main.yml"
    echo "---" > "$target/handlers/main.yml"
    echo "---" > "$target/defaults/main.yml"
    echo -e "${GREEN}âœ… RÃ´le crÃ©Ã© dans : $target${NC}"
    pause
}

# =======================================================
# MODULE : SHELL RESTREINT (Jail)
# =======================================================
module_jail() {
    local JAIL_ROOT="$ANSIBLE_ROOT"
    
    echo -e "\n${GREEN}>>> OUVERTURE DU SHELL RESTREINT${NC}"
    echo -e "    PÃ©rimÃ¨tre : ${YELLOW}$JAIL_ROOT${NC}"
    echo -e "${GREY}Tapez 'exit' pour revenir au menu.${NC}"
    
    cd "$JAIL_ROOT" || return
    trap - SIGINT SIGQUIT SIGTSTP

    local RC_FILE=$(mktemp)
    cat > "$RC_FILE" <<EOF
        unalias -a
        export PS1='\[\033[01;33m\][RESTRICTED]\[\033[00m\] \w\$ '
        cd() {
            if [ -z "\$1" ]; then builtin cd "$JAIL_ROOT"; return; fi
            builtin cd "\$1"
            if [[ "\$PWD" != "$JAIL_ROOT"* ]]; then
                echo "â›” Sortie du pÃ©rimÃ¨tre interdite."
                builtin cd "$JAIL_ROOT"
            fi
        }
EOF
    bash --rcfile "$RC_FILE"
    rm "$RC_FILE"
    trap '' SIGINT SIGQUIT SIGTSTP
}

# =======================================================
# MODULE : PARE-FEU (Firewall UFW)
# =======================================================
module_firewall() {
    while true; do
        clear
        local st_txt="${RED}INACTIF${NC}"
        if sudo ufw status | grep -q "active"; then st_txt="${GREEN}ACTIF${NC}"; fi
        
        echo -e "${BLUE}=== GESTION PARE-FEU UFW ($st_txt) ===${NC}"
        echo "1. Voir les rÃ¨gles"
        echo "2. Ouvrir un port"
        echo "3. Supprimer une rÃ¨gle"
        echo "4. Activer"
        echo "5. DÃ©sactiver"
        echo "r. Retour"
        read -p "> " c

        case $c in
            1) run_as_root $CMD_UFW status numbered; pause ;;
            2) 
                read -p "Port/Proto (ex: 80/tcp) : " p
                [ -n "$p" ] && run_as_root $CMD_UFW allow "$p" && pause
                ;;
            3)
                run_as_root $CMD_UFW status numbered
                read -p "NumÃ©ro de la rÃ¨gle Ã  supprimer : " n
                [ -n "$n" ] && run_as_root $CMD_UFW delete "$n" && pause
                ;;
            4) run_as_root $CMD_UFW enable; pause ;;
            5) run_as_root $CMD_UFW disable; pause ;;
            r) return ;;
        esac
    done
}

# =======================================================
# MODULE : SYSTÃˆME (Updates & Power)
# =======================================================
module_updates() {
    while true; do
        clear
        echo -e "${BLUE}=== MISES Ã€ JOUR SYSTÃˆME ===${NC}"
        echo "1. Update & Upgrade (Standard)"
        echo "2. Nettoyage (Autoremove)"
        echo "3. Dist-Upgrade (Complet)"
        echo "r. Retour"
        read -p "> " c
        case $c in
            1) run_as_root apt update && run_as_root apt upgrade -y; pause ;;
            2) run_as_root apt autoremove -y; pause ;;
            3) run_as_root apt dist-upgrade -y; pause ;;
            r) return ;;
        esac
    done
}

module_power() {
    local action="$1"
    echo -e "\n${RED}${BOLD}âš ï¸  ATTENTION : Vous allez $action le serveur.${NC}"
    read -p "Tapez 'confirmer' pour exÃ©cuter : " input
    if [ "$input" == "confirmer" ]; then
        if [ "$action" == "ETEINDRE" ]; then run_as_root poweroff; fi
        if [ "$action" == "REDEMARRER" ]; then run_as_root reboot; fi
    else
        echo "AnnulÃ©."
        pause
    fi
}

open_user_shell() {
    if ! ask_sudo_gui; then return; fi
    echo -e "\n${GREEN}ðŸ”“ AccÃ¨s autorisÃ©.${NC} Tapez 'exit' pour revenir."
    # On dÃ©sactive le piÃ¨ge (trap) pour autoriser Ctrl+C / Ctrl+Z dans le shell admin
    trap - SIGINT SIGQUIT SIGTSTP
    export SKIP_KIOSK=1
    
    cd "$ANSIBLE_ROOT" || cd "$HOME"
    bash --login
    
    unset SKIP_KIOSK
    # On rÃ©active le piÃ¨ge pour empÃªcher la fermeture du script aprÃ¨s le retour
    trap '' SIGINT SIGQUIT SIGTSTP
}

# =======================================================
# MENU PRINCIPAL (BOUCLE INFINIE)
# =======================================================
SEP="${BLUE}------------------------------------------------${NC}"
SEP_RED="${RED}------------------------------------------------${NC}"

while true;
do
    clear
    # Collecte des infos systÃ¨me
    get_sys_info
    
    # --- EN-TÃŠTE AVEC CADRE BLEU ---
    echo -e "${BLUE}#################################${NC}"
    echo -e "${BLUE}#       ANSIBLE MANAGER         #${NC}"
    echo -e "${BLUE}#################################${NC}"
    
    printf "  ðŸ–¥ï¸  ${CYAN}%-29s${NC} | â±ï¸  ${GREY}%s${NC}\n" "$OS_NAME" "$SYS_UPTIME"
    printf "  ðŸ§  CPU: ${YELLOW}%-23s${NC} | ðŸ’¾ RAM: ${YELLOW}%s${NC}\n" "$CPU_USAGE" "$RAM_USAGE"
    printf "  ðŸ  LAN: ${YELLOW}%-23s${NC} | ðŸŒ WAN: ${YELLOW}%s${NC}\n" "$LOCAL_IP" "$PUBLIC_IP"
    
    echo -e "$SEP"

    # --- INFO SERVICE (Correction alignement avec couleurs) ---
    # On utilise %-20s pour compenser les caractÃ¨res ANSI invisibles (~11 chars)
    # SX et APP_VER contiennent des couleurs, donc leur longueur "rÃ©elle" est > longueur visible
    printf "  â° Automate : %-20b | ðŸ›¡ï¸  Pare-feu : %s\n" "$SX" "$FW"
    printf "  â„¹ï¸  Ansible  : %-20s | ðŸ“ Racine    : %s\n" "${CYAN}$APP_VER${NC}" "$(basename "$ANSIBLE_HOME")"

    echo -e "$SEP"

    # --- MENU : AUTOMATISATION ---
    echo -e " ${BOLD}${CYAN}ðŸ¤– AUTOMATISATION${NC}"
    echo -e "    ${GREEN}1.${NC} ðŸš€ Lancer un Playbook"
    echo -e "    ${GREEN}2.${NC} â° GÃ©rer les TÃ¢ches Cron"
    echo -e "    ${GREEN}3.${NC} ðŸ” Gestion des Secrets (Vault)"
    echo ""

    # --- MENU : OUTILS ---
    echo -e " ${BOLD}${CYAN}ðŸ› ï¸  OUTILS & PARAMÃˆTRES${NC}"
    echo -e "    ${GREEN}4.${NC} ðŸŒ Explorateur d'Inventaire"
    echo -e "    ${GREEN}5.${NC} ðŸ”’ Explorateur Fichiers (Jail)"
    echo -e "    ${GREEN}6.${NC} âž• CrÃ©er un nouveau RÃ´le"
    echo -e "    ${GREEN}7.${NC} ðŸ§± Pare-feu (UFW)"
    echo -e "    ${GREEN}8.${NC} ðŸš€ Mises Ã  jour (App & OS)"

    echo -e "$SEP_RED"

    # --- MENU : SYSTÃˆME (Danger) ---
    echo -e " ${BOLD}${RED}ðŸ’€ ZONES SYSTÃˆME${NC}"
    echo -e "    ${RED}9.${NC} ðŸ”Œ Ã‰teindre le serveur"
    echo -e "    ${RED}10.${NC}â™»ï¸  RedÃ©marrer le serveur"

    echo -e "$SEP"

    # --- PIED DE PAGE ---
    echo -e "  [${YELLOW}admin${NC}] ðŸ’» Console Admin    |    [${RED}exit${NC}] ðŸšª Quitter"
    echo -e "$SEP"

    read -r -p "  Votre choix > " choice

    case "$choice" in
        1) module_launcher ;;
        2) module_cron ;;
        3) module_vault ;;
        4) module_inventory ;;
        5) module_jail ;;
        6) module_create_role ;;
        7) module_firewall ;;
        8) module_updates ;;
        9) module_power "ETEINDRE" ;;
        10) module_power "REDEMARRER" ;;
        admin) open_user_shell ;;
        exit|quit|q)
            echo "Au revoir."
            kill -9 $PPID 2>/dev/null
            exit 0 
            ;;
        *) 
            echo "Choix invalide."
            sleep 0.5 
            ;;
    esac
done
