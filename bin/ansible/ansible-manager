#!/bin/bash
# ======================================
#  MANAGER ANSIBLE
# ======================================

# --- S√âCURIT√â ---
trap '' SIGINT SIGQUIT SIGTSTP

# =======================================================
# CONFIGURATION
# =======================================================

if [ -z "$ANSIBLE_HOME" ]; then export ANSIBLE_HOME="$HOME/ansible"; fi
# R√©solution du lien symbolique d√®s le d√©part pour la s√©curit√©
export ANSIBLE_ROOT=$(readlink -f "$ANSIBLE_HOME")
export ANSIBLE_CONFIG="$ANSIBLE_ROOT/ansible.cfg"
CONFIG_FILE="$ANSIBLE_ROOT/.manager_config"

# Chargement config persistante
if [ -f "$CONFIG_FILE" ]; then source "$CONFIG_FILE"; fi

# Valeurs par d√©faut
if [ -z "$BACKUP_DIR" ]; then export BACKUP_DIR="/var/backups/ansible_manager"; fi
if [ -z "$CRON_USER" ]; then export CRON_USER="root"; fi

# Chemins internes
PLAYBOOKS_DIR="$ANSIBLE_ROOT/playbooks"
ROLES_DIR="$ANSIBLE_ROOT/roles"
DESC_FILE="$PLAYBOOKS_DIR/.descriptions"
VAULT_PASS_FILE="$ANSIBLE_ROOT/.vault_pass"
CMD_UFW="/usr/sbin/ufw"

# Cr√©ation structure
mkdir -p "$PLAYBOOKS_DIR" "$ROLES_DIR"

# Couleurs
BLUE=$'\033[0;34m'
GREEN=$'\033[0;32m'
RED=$'\033[0;31m'
YELLOW=$'\033[1;33m'
CYAN=$'\033[0;36m'
GREY=$'\033[1;30m'
NC=$'\033[0m'
BOLD=$'\033[1m'
SEP="${BLUE}------------------------------------------------${NC}"
SEP_RED="${RED}------------------------------------------------${NC}"

# =======================================================
# FONCTIONS SYST√àME
# =======================================================

pause() {
    echo ""
    read -p "Appuyez sur Entr√©e pour continuer..."
}

_check_gitignore() {
    cd "$ANSIBLE_ROOT" || return
    if [ ! -f ".gitignore" ]; then touch ".gitignore"; fi
    if ! grep -q ".manager_config" ".gitignore"; then echo ".manager_config" >> ".gitignore"; fi
    if ! grep -q ".ansible.cfg" ".gitignore"; then echo ".ansible.cfg" >> ".gitignore"; fi
    if ! grep -q ".vault_pass" ".gitignore"; then echo ".vault_pass" >> ".gitignore"; fi
    if ! grep -q "keys/" ".gitignore"; then echo "keys/" >> ".gitignore"; fi
}

save_config() {
    echo "BACKUP_DIR=\"$BACKUP_DIR\"" > "$CONFIG_FILE"
    echo "CRON_USER=\"$CRON_USER\"" >> "$CONFIG_FILE"
    _check_gitignore
}

ask_sudo_gui() {
    if sudo -n true 2>/dev/null; then
        return 0
    fi
    echo -e "\n${YELLOW}üîí Authentification requise${NC}"
    read -s -p "Mot de passe Sudo : " user_pass
    echo ""
    echo "$user_pass" | sudo -S -v 2>/dev/null
    if [ $? -eq 0 ]; then
        return 0
    else
        echo -e "${RED}‚ùå Incorrect.${NC}"
        pause
        return 1
    fi
}

run_sudo() {
    if sudo -n true 2>/dev/null; then
        sudo "$@"
        return $?
    fi
    if ! ask_sudo_gui; then
        return 1
    fi
    sudo "$@"
}

run_sudo_silent() {
    if sudo -n "$@" 2>/dev/null; then
        return 0
    fi
    return 1
}

# --- INFOS SYST√àME ---
get_sys_info() {
    LOCAL_IP=$(hostname -I | awk '{print $1}')
    PUBLIC_IP=$(curl -s -4 -m 1 https://icanhazip.com 2>/dev/null)
    [[ ! "$PUBLIC_IP" =~ ^[0-9.]+$ ]] && PUBLIC_IP="N/A"

    OS_NAME=$(grep -oP 'PRETTY_NAME="\K[^"]+' /etc/os-release 2>/dev/null | cut -c1-20)
    [ -z "$OS_NAME" ] && OS_NAME="Linux"

    CPU_USAGE=$(top -bn1 | grep "Cpu(s)" | sed "s/.*, *\([0-9.]*\)%* id.*/\1/" | awk '{print 100 - $1"%"}' 2>/dev/null)
    [ -z "$CPU_USAGE" ] && CPU_USAGE="N/A"

    RAM_USAGE=$(free -h | awk '/^Mem:/ {print $3 "/" $2}')
    SYS_UPTIME=$(uptime -p | sed 's/up //;s/ hours/h/;s/ minutes/m/;s/ days/j/')
    APP_VER=$(ansible --version 2>/dev/null | head -n1 | awk '{print $NF}' | tr -d ']')

    if systemctl is-active --quiet cron; then SX="${GREEN}‚óè ACTIF${NC}"; else SX="${RED}‚óè OFF${NC}"; fi

    # Check UFW status without blocking
    if run_sudo_silent $CMD_UFW status 2>/dev/null | grep -q "Status: active"; then
        FW="${GREEN}‚óè ACTIF${NC}"
    else
        FW="${RED}‚óè INACTIF${NC}"
    fi

    cd "$ANSIBLE_ROOT" || return
    if [ -d ".git" ]; then
        if [ -n "$(git status --porcelain)" ]; then ST_GIT="${YELLOW}‚ö†Ô∏è  Modifi√©${NC}"; else ST_GIT="${GREEN}‚úÖ √Ä jour${NC}"; fi
    else ST_GIT="${RED}üî¥ Non Config${NC}"; fi

    if [ -d "$BACKUP_DIR" ]; then ST_BKP="${GREEN}‚úÖ Configur√©${NC}"; else ST_BKP="${RED}üî¥ Non Config${NC}"; fi

    # Check Cron Logs readability
    if [ -r /var/log/syslog ]; then
        if tail -n 50 /var/log/syslog | grep -qi "CRON.*error\|CRON.*exit status [1-9]"; then
            ST_CRON="${RED}‚ö†Ô∏è  Erreurs${NC}"
        else ST_CRON="${GREEN}‚úÖ Clean${NC}"; fi
    else ST_CRON="${GREY}? (No Access)${NC}"; fi
}

ensure_git() {
    if ! command -v git &> /dev/null; then
        echo -e "${YELLOW}Git n'est pas install√©.${NC}"
        read -p "L'installer ? (o/n) " i
        if [ "$i" == "o" ]; then
             if ask_sudo_gui; then
                 run_sudo apt update && run_sudo apt install -y git
             fi
        else return 1; fi
    fi
    _check_gitignore
    return 0
}

# =======================================================
# MODULE 1 : ASSISTANT CR√âATION
# =======================================================
module_assistant_dev() {
    cd "$ANSIBLE_ROOT" || return

    _create_role_wizard() {
        echo -e "\n${CYAN}--- NOUVEAU R√îLE ---${NC}"
        read -p "Nom du r√¥le (ex: mysql, common) : " rname; [ -z "$rname" ] && return
        target="$ROLES_DIR/$rname"
        if [ -d "$target" ]; then echo -e "${RED}Erreur : Le dossier existe d√©j√†.${NC}"; pause; return; fi
        mkdir -p "$target"/{tasks,handlers,defaults,vars,templates,files,meta}
        for d in tasks handlers defaults vars meta; do echo "---" > "$target/$d/main.yml"; done
        echo -e "${GREEN}‚úÖ Structure cr√©√©e dans roles/$rname${NC}"
        read -p "G√©n√©rer un playbook d'installation ? (o/n) " cp
        if [ "$cp" == "o" ]; then
            echo -e "---\n- name: Deploy $rname\n  hosts: all\n  become: yes\n  roles:\n    - $rname" > "$PLAYBOOKS_DIR/deploy_$rname.yml"
            echo -e "${GREEN}‚úÖ Playbook g√©n√©r√© : deploy_$rname.yml${NC}"
        fi; pause
    }

    _create_playbook_wizard() {
        echo -e "\n${CYAN}--- NOUVEAU PLAYBOOK ---${NC}"
        read -p "Nom du fichier (ex: update_sys) : " p; [ -z "$p" ] && return
        p="${p%.yml}.yml"; t="$PLAYBOOKS_DIR/$p"
        if [ -f "$t" ]; then echo -e "${RED}Fichier existant.${NC}"; pause; return; fi
        echo -e "---\n- name: New Playbook\n  hosts: all\n  become: yes\n  tasks:\n    - name: Ping\n      ping:" > "$t"
        echo -e "${GREEN}‚úÖ Cr√©√©.${NC}"
        read -p "Ouvrir l'√©diteur ? (o/n)" e; [ "$e" == "o" ] && nano "$t"
    }

    while true; do
        clear
        echo -e "${BLUE}################################################${NC}"
        echo -e "${BLUE}#            ASSISTANT DE CR√âATION             #${NC}"
        echo -e "${BLUE}################################################${NC}"
        echo -e "${GREY}G√©n√©rez rapidement vos structures Ansible.${NC}"
        echo -e "$SEP"
        echo -e "  ${GREEN}1.${NC} ‚ú® Cr√©er un nouveau R√¥le (+ Structure)"
        echo -e "  ${GREEN}2.${NC} üìÑ Cr√©er un nouveau Playbook simple"
        echo -e "  ${YELLOW}3.${NC} ‚ûï Ajouter une T√¢che (Task)"
        echo -e "  ${YELLOW}4.${NC} üí≤ Ajouter une Variable (Config)"
        echo -e "  ${RED}5.${NC} üóëÔ∏è  Supprimer un √©l√©ment"
        echo -e "$SEP_RED"
        echo -e "  ${RED}0.${NC} Retour"
        echo -e "$SEP"
        read -p "  Choix > " c
        case $c in
            1) _create_role_wizard;;
            2) _create_playbook_wizard;;
            3) echo "Fonction Task Wizard"; pause ;;
            4) echo "Fonction Var Wizard"; pause ;;
            5) echo "Fonction Delete Wizard"; pause ;;
            0) return;;
        esac
    done
}

# =======================================================
# MODULE 2 : LANCEUR
# =======================================================
module_launcher() {
    cd "$ANSIBLE_ROOT" || return
    _get_desc() {
        local f="$1"
        local d=$(grep "^$f|" "$DESC_FILE" 2>/dev/null | cut -d'|' -f2-)
        [ -n "$d" ] && echo "$d" || echo "${GREY}Aucune description${NC}"
    }

    while true; do
        clear
        echo -e "${BLUE}################################################${NC}"
        echo -e "${BLUE}#             LANCEUR DE PLAYBOOKS             #${NC}"
        echo -e "${BLUE}################################################${NC}"
        echo -e "${GREY}S√©lectionnez un script d'automatisation √† ex√©cuter.${NC}"
        echo -e "$SEP"

        mapfile -t files < <(find "$PLAYBOOKS_DIR" -maxdepth 1 -name "*.yml" -printf "%f\n" | sort)
        if [ ${#files[@]} -eq 0 ]; then echo -e "${RED}Aucun playbook trouv√©.${NC}"; echo -e "$SEP"; else
            local i=1
            for f in "${files[@]}"; do
                printf "  ${GREEN}[%d]${NC} %-30s ${GREY}%s${NC}\n" "$i" "${f:0:30}" "$(_get_desc "$f")"
                ((i++))
            done
        fi
        echo -e "$SEP_RED"
        echo -e "  ${RED}0.${NC} Retour"
        echo -e "$SEP"

        read -p "  Num√©ro du playbook > " idx
        if [ "$idx" == "0" ]; then return; fi

        real_idx=$((idx-1))

        if [[ "$idx" =~ ^[0-9]+$ ]] && [ "$real_idx" -lt "${#files[@]}" ] && [ "$real_idx" -ge 0 ]; then
            sel="${files[$real_idx]}"
            echo -e "\n${CYAN}üöÄ Lancement de : $sel${NC}"
            echo -e "${GREY}----------------------------------------${NC}"
            ansible-playbook "$PLAYBOOKS_DIR/$sel"
            echo -e "${GREY}----------------------------------------${NC}"
            pause
        else echo "Choix invalide."; sleep 0.5; fi
    done
}

# =======================================================
# MODULE 3 : SAUVEGARDE & GIT
# =======================================================
module_backup_git() {
    cd "$ANSIBLE_ROOT" || return

    _run_backup_local() {
        if [ ! -d "$BACKUP_DIR" ]; then return 1; fi
        if ! run_sudo touch "$BACKUP_DIR/.chk" 2>/dev/null; then return 1; fi
        run_sudo rm "$BACKUP_DIR/.chk"
        D=$(date +%Y%m%d_%H%M%S)
        FILE="$BACKUP_DIR/ansible_backup_$D.tar.gz"
        echo -e "${GREY}[Local] Compression...${NC}"
        if tar --exclude='.git' --exclude='*.retry' -czf "/tmp/ansible_temp.tar.gz" . 2>/dev/null; then
            if run_sudo mv "/tmp/ansible_temp.tar.gz" "$FILE"; then
                echo -e "${GREEN}‚úÖ Sauvegarde locale OK : $(basename "$FILE")${NC}"; return 0
            fi
        fi
        echo -e "${RED}‚ùå Erreur Local.${NC}"; return 1
    }

    _run_push_git() {
        if [ ! -d ".git" ]; then return 1; fi
        echo -e "${GREY}[Git] Sync...${NC}"
        git fetch origin >/dev/null 2>&1
        if [ -n "$(git status --porcelain)" ]; then
            git add -A; git commit -m "Auto-backup $(date)" >/dev/null 2>&1
        fi
        cur=$(git rev-parse --abbrev-ref HEAD)
        if git push origin "$cur" 2>/dev/null || git push -u origin "$cur" 2>/dev/null; then
             echo -e "${GREEN}‚úÖ Push Git OK (Branche: $cur).${NC}"; return 0
        else echo -e "${RED}‚ùå Erreur Push Git.${NC}"; return 1; fi
    }

    _pull_git() {
        ensure_git || return
        cur=$(git rev-parse --abbrev-ref HEAD)
        if git pull origin "$cur"; then
            echo -e "${GREEN}‚úÖ Mis √† jour.${NC}"
            git branch --set-upstream-to=origin/"$cur" "$cur" 2>/dev/null
        else echo -e "${RED}‚ùå Erreur Pull.${NC}"; fi
        pause
    }

    _menu_config() {
        while true; do
            clear
            echo -e "${BLUE}################################################${NC}"
            echo -e "${BLUE}#            PARAM√àTRES & CONFIG               #${NC}"
            echo -e "${BLUE}################################################${NC}"

            curr_remote=$(git remote get-url origin 2>/dev/null || echo "${RED}Non d√©fini${NC}")
            curr_user=$(git config user.name || echo "${RED}Inconnu${NC}")

            echo -e "  üìÇ Dossier Local : ${YELLOW}$BACKUP_DIR${NC}"
            echo -e "  üîó Remote Git    : ${CYAN}$curr_remote${NC}"
            echo -e "  üë§ Identit√© Git  : ${CYAN}$curr_user${NC}"
            echo -e "$SEP"

            echo -e "  ${GREEN}1.${NC} Changer le dossier de sauvegarde local"
            echo -e "  ${GREEN}2.${NC} Configurer Remote Git (URL)"
            echo -e "  ${GREEN}3.${NC} Configurer Identit√© (Nom/Email)"
            echo -e "  ${RED}0.${NC} Retour"
            echo -e "$SEP"

            read -p "  Choix > " conf_choice
            case "$conf_choice" in
                1)
                    echo -e "\n${CYAN}--- CHEMIN LOCAL ---${NC}"
                    read -p "Nouveau chemin absolu : " new_path
                    if [[ "$new_path" == /* ]]; then
                        if ask_sudo_gui; then
                            run_sudo mkdir -p "$new_path"
                            export BACKUP_DIR="$new_path"
                            save_config
                            echo -e "${GREEN}‚úÖ Enregistr√©.${NC}"
                        fi
                    else echo -e "${RED}Chemin invalide.${NC}"; fi
                    pause
                    ;;
                2)
                    read -p "URL Git : " u
                    if [ -n "$u" ]; then
                        if git remote get-url origin >/dev/null 2>&1; then git remote set-url origin "$u"; else git remote add origin "$u"; fi
                        echo -e "${GREEN}‚úÖ OK.${NC}"
                    fi
                    pause
                    ;;
                3)
                    read -p "Nom : " n; read -p "Email : " e
                    git config user.name "$n"; git config user.email "$e"
                    echo -e "${GREEN}‚úÖ OK.${NC}"
                    pause
                    ;;
                0) return ;;
            esac
        done
    }

    _smart_backup_menu() {
        echo -e "\n${BOLD}${CYAN}=== ASSISTANT DE SAUVEGARDE ===${NC}"
        echo "1. üíæ Local uniquement"
        echo "2. ‚òÅÔ∏è  Git uniquement"
        echo "3. üíé Les Deux (Recommand√©)"
        echo "0. Annuler"
        read -p "> " choice

        local sl=0; local sg=0; local al=0; local ag=0

        case "$choice" in
            1) al=1; if _run_backup_local; then sl=1; fi ;;
            2) ag=1; if _run_push_git; then sg=1; fi ;;
            3)
                al=1; ag=1
                echo "---"
                if _run_backup_local; then sl=1; else echo -e "${YELLOW}‚ö†Ô∏è  Echec Local.${NC}"; fi
                echo "---"
                if _run_push_git; then sg=1; else echo -e "${YELLOW}‚ö†Ô∏è  Echec Git.${NC}"; fi
                ;;
            0) return ;;
        esac

        echo -e "\n${BOLD}=== R√âSULTAT ===${NC}"
        msg=""
        if [ $al -eq 1 ]; then if [ $sl -eq 1 ]; then msg+="${GREEN}LOCAL [OK]${NC}  "; else msg+="${RED}LOCAL [KO]${NC}  "; fi; fi
        if [ $ag -eq 1 ]; then if [ $sg -eq 1 ]; then msg+="${GREEN}GIT [OK]${NC}"; else msg+="${RED}GIT [KO]${NC}"; fi; fi
        echo -e "$msg"
        pause
    }

    _lazygit_mode() {
        if ! command -v lazygit &>/dev/null; then
             echo -e "${YELLOW}Lazygit introuvable.${NC}"
             pause; return
        fi
        trap - SIGINT SIGQUIT SIGTSTP; lazygit; trap '' SIGINT SIGQUIT SIGTSTP
    }

    _rollback_git() {
        while true; do
            clear
            echo -e "${RED}‚ö†Ô∏è  ZONE DANGER : ROLLBACK${NC}"
            echo "1. Annuler modifs (Discard Changes)"
            echo "2. Reset Soft (Annuler commit, garder fichiers)"
            echo "3. Reset Hard (Tout effacer > Remote)"
            echo "0. Retour"
            read -p "> " c
            case $c in
                1) git checkout .; git clean -fd; echo "Annul√©."; pause;;
                2) git reset --soft HEAD~1; echo "Reset Soft OK."; pause;;
                3) read -p "CONFIRMER (OUI) : " k
                   if [ "$k" == "OUI" ]; then
                       git fetch origin
                       git reset --hard origin/$(git rev-parse --abbrev-ref HEAD)
                       echo "Reset Hard OK."
                   fi; pause;;
                0) return ;;
            esac
        done
    }

    while true; do
        clear
        echo -e "${BLUE}################################################${NC}"
        echo -e "${BLUE}#      CENTRE DE SAUVEGARDE & VERSIONNING      #${NC}"
        echo -e "${BLUE}################################################${NC}"
        echo -e "${GREY}G√©rez vos versions Git et vos archives locales.${NC}"
        echo -e "$SEP"

        if [ -d "$BACKUP_DIR" ]; then SL="${GREEN}Configur√©${NC}"; else SL="${RED}Invalide${NC}"; fi
        if [ -d ".git" ]; then SG="${GREEN}Initialis√©${NC}"; else SG="${RED}Absent${NC}"; fi

        printf "  üíæ Local : %-25b | üê± Git : %s\n" "$SL" "$SG"
        echo -e "$SEP"

        echo -e " ${BOLD}${CYAN}üöÄ ACTIONS${NC}"
        echo -e "    ${GREEN}1.${NC} üíé Assistant Sauvegarde (Smart Backup)"
        echo -e "    ${GREEN}2.${NC} ‚òÅÔ∏è  Synchroniser Git (Push rapide)"
        echo -e "    ${GREEN}3.${NC} ‚¨áÔ∏è  Mise √† jour Git (Pull)"
        echo ""
        echo -e " ${BOLD}${CYAN}‚öôÔ∏è  CONFIGURATION${NC}"
        echo -e "    ${GREEN}4.${NC} üîß Configurer (Chemins, Remote, etc.)"
        echo -e "    ${GREEN}5.${NC} üê¢ Terminal Avanc√© (Lazygit)"
        echo -e "    ${YELLOW}6.${NC} üîô Rollback / Annuler"
        echo -e "$SEP_RED"
        echo -e "  ${RED}0.${NC} Retour au menu principal"
        echo -e "$SEP"

        read -p "  Choix > " c
        case "$c" in
            1) _smart_backup_menu ;;
            2) _run_push_git; pause ;;
            3) _pull_git ;;
            4) _menu_config ;;
            5) _lazygit_mode ;;
            6) _rollback_git ;;
            0) return ;;
        esac
    done
}

# =======================================================
# MODULE 4 : SECRETS & CONFIG PROJET
# =======================================================
module_project_config() {
    export EDITOR="nano"

    cd "$ANSIBLE_ROOT" || return
    _check_gitignore

    _manage_vault_pass() {
        echo -e "\n${CYAN}--- GESTION MOT DE PASSE VAULT ---${NC}"
        if [ -f "$VAULT_PASS_FILE" ]; then
            echo -e "√âtat : ${GREEN}Pr√©sent${NC}"
            echo "1. Voir le mot de passe"
            echo "2. Modifier le mot de passe"
            read -p "> " vp_choice
            case "$vp_choice" in
                1) cat "$VAULT_PASS_FILE"; echo ""; pause ;;
                2) read -s -p "Nouveau mot de passe : " new_pass
                   echo "$new_pass" > "$VAULT_PASS_FILE"
                   echo -e "\n${GREEN}Modifi√©.${NC}"; pause ;;
            esac
        else
            echo -e "√âtat : ${RED}Absent${NC}"
            read -p "Cr√©er le fichier .vault_pass ? (o/n) " c
            if [ "$c" == "o" ]; then
                read -s -p "Mot de passe : " new_pass
                echo "$new_pass" > "$VAULT_PASS_FILE"
                _check_gitignore
                echo -e "\n${GREEN}Fichier cr√©√©.${NC}"; pause
            fi
        fi
    }

    _manage_ansible_cfg() {
        echo -e "\n${CYAN}--- CONFIGURATION ANSIBLE.CFG ---${NC}"
        local cfg="$ANSIBLE_ROOT/ansible.cfg"
        local bkp="$ANSIBLE_ROOT/.ansible.cfg"
        if [ ! -f "$cfg" ]; then
            echo -e "${YELLOW}Fichier inexistant.${NC}"
            read -p "Cr√©er un fichier par d√©faut ? (o/n) " c
            if [ "$c" == "o" ]; then
                echo -e "[defaults]\ninventory = ./inventory\nroles_path = ./roles\nhost_key_checking = False" > "$cfg"
                echo -e "${GREEN}Fichier cr√©√©.${NC}"
            else return; fi
        fi
        echo -e "Fichier actuel : $cfg"
        read -p "Voulez-vous l'√©diter ? (o/n) " ed
        if [ "$ed" == "o" ]; then
            cp "$cfg" "$bkp"; _check_gitignore; nano "$cfg"
            echo -e "${GREEN}√âdition termin√©e. Backup cr√©√© dans .ansible.cfg${NC}"
        fi
    }

    # RESTAURATION AVEC DIFF
    _restore_ansible_cfg() {
        local cfg="$ANSIBLE_ROOT/ansible.cfg"
        local bkp="$ANSIBLE_ROOT/.ansible.cfg"
        echo -e "\n${RED}‚ö†Ô∏è  RESTAURATION ANSIBLE.CFG${NC}"
        if [ ! -f "$bkp" ]; then
            echo -e "${RED}Aucune sauvegarde (.ansible.cfg) trouv√©e.${NC}"; pause; return
        fi

        echo -e "${YELLOW}COMPARAISON AVANT RESTAURATION :${NC}"
        echo -e "  ${RED}- Ligne actuelle (Va dispara√Ætre)${NC}"
        echo -e "  ${GREEN}+ Ligne de sauvegarde (Va √™tre restaur√©e)${NC}"
        echo -e "$SEP"

        # Affichage du diff
        if command -v diff > /dev/null; then
            diff -u --color=always "$cfg" "$bkp" 2>/dev/null || diff -u "$cfg" "$bkp"
        else
            echo -e "${GREY}(Commande diff introuvable, impossible de comparer)${NC}"
        fi

        echo -e "$SEP"
        read -p "√âcraser la config actuelle par la sauvegarde ? (o/n) " c
        if [ "$c" == "o" ]; then
            cp "$bkp" "$cfg"
            echo -e "${GREEN}‚úÖ Configuration restaur√©e.${NC}"; pause
        fi
    }

    _select_vault_file() {
        local mode="$1"
        local prompt="$2"
        mapfile -t files < <(find "$ANSIBLE_ROOT" -type f \( -name "*.yml" -o -name "*.yaml" -o -name "pass" \) -not -path '*/.*' | sort)

        if [ ${#files[@]} -eq 0 ]; then echo -e "${RED}Aucun fichier trouv√©.${NC}"; return 1; fi

        echo -e "${BLUE}--- $prompt ---${NC}"
        local i=1
        local valid_files=()

        for f in "${files[@]}"; do
            is_locked=false
            if head -n 1 "$f" | grep -q "\$ANSIBLE_VAULT"; then is_locked=true; fi
            if [[ "$mode" == "OPEN" && "$is_locked" == "true" ]]; then continue; fi
            if [[ "$mode" == "LOCKED" && "$is_locked" == "false" ]]; then continue; fi

            valid_files+=("$f")
            if [ "$is_locked" == "true" ]; then status="${RED}[üîí LOCKED]${NC}"; else status="${GREEN}[üîì OPEN]${NC}"; fi
            rel_path="${f#$ANSIBLE_ROOT/}"

            # Affichage "dossier/fichier"
            dir_name=$(dirname "$rel_path")
            base_name=$(basename "$rel_path")
            if [ "$dir_name" == "." ]; then display_path="$base_name"; else display_path="${GREY}${dir_name}/${NC}${base_name}"; fi

            printf "  [${GREEN}%d${NC}] %-50b %b\n" "$i" "$display_path" "$status"
            ((i++))
        done

        if [ ${#valid_files[@]} -eq 0 ]; then echo -e "${YELLOW}Aucun fichier correspondant.${NC}"; return 1; fi

        echo -e "  [${RED}0${NC}] Annuler"
        read -p "  Num√©ro > " idx
        if [ "$idx" == "0" ]; then return 1; fi

        real_idx=$((idx-1))
        if [[ "$idx" =~ ^[0-9]+$ ]] && [ "$real_idx" -lt "${#valid_files[@]}" ] && [ "$real_idx" -ge 0 ]; then
            SELECTED_VAULT_FILE="${valid_files[$real_idx]}"
            return 0
        fi
        return 1
    }

    while true; do
        clear
        echo -e "${BLUE}################################################${NC}"
        echo -e "${BLUE}#         SECRETS & CONFIGURATION PROJET       #${NC}"
        echo -e "${BLUE}################################################${NC}"
        echo -e "${GREY}G√©rez vos mots de passe et la config Ansible.${NC}"
        echo -e "$SEP"

        if [ -f "$VAULT_PASS_FILE" ]; then VP="${GREEN}OK${NC}"; else VP="${RED}Manquant${NC}"; fi
        if [ -f "ansible.cfg" ]; then AC="${GREEN}Pr√©sent${NC}"; else AC="${YELLOW}D√©faut${NC}"; fi

        printf "  üîë .vault_pass : %-20b | ‚öôÔ∏è  ansible.cfg : %s\n" "$VP" "$AC"
        echo -e "$SEP"

        echo -e " ${BOLD}${CYAN}üîß CONFIGURATION${NC}"
        echo -e "    ${GREEN}1.${NC} üîë G√©rer le mot de passe (.vault_pass)"
        echo -e "    ${GREEN}2.${NC} ‚öôÔ∏è  √âditer ansible.cfg (Backup auto)"
        echo -e "    ${YELLOW}3.${NC} üîô Restaurer ansible.cfg (Rollback)"
        echo ""

        echo -e " ${BOLD}${CYAN}üîê ACTIONS VAULT (CHIFFREMENT)${NC}"
        if [ ! -f "$VAULT_PASS_FILE" ]; then
            echo -e "    ${RED}‚ö†Ô∏è  Cr√©ez d'abord le fichier .vault_pass (Option 1)${NC}"
        else
            echo -e "    ${GREEN}4.${NC} üîí Chiffrer (Liste uniquement les fichiers CLAIRS)"
            echo -e "    ${GREEN}5.${NC} üîì D√©chiffrer (Liste uniquement les fichiers CHIFFR√âS)"
            echo -e "    ${GREEN}6.${NC} üìù √âditer (Liste uniquement les fichiers CHIFFR√âS)"
            echo -e "    ${GREEN}7.${NC} üëÄ Voir (Liste uniquement les fichiers CHIFFR√âS)"
        fi

        echo -e "$SEP_RED"
        echo -e "  ${RED}0.${NC} Retour"
        echo -e "$SEP"

        read -p "  Choix > " c
        if [ "$c" == "0" ]; then return; fi

        case $c in
            1) _manage_vault_pass ;;
            2) _manage_ansible_cfg ;;
            3) _restore_ansible_cfg ;;
            4|5|6|7)
                if [ ! -f "$VAULT_PASS_FILE" ]; then continue; fi
                if [ "$c" == "4" ]; then mode="OPEN"; else mode="LOCKED"; fi
                if ! _select_vault_file "$mode" "S√âLECTION FICHIER"; then continue; fi
                f="$SELECTED_VAULT_FILE"
                case $c in
                    4) ansible-vault encrypt "$f"; pause ;;
                    5) ansible-vault decrypt "$f"; pause ;;
                    6) ansible-vault edit "$f"; ;;
                    7) ansible-vault view "$f" | less ;;
                esac
                ;;
        esac
    done
}

# =======================================================
# MODULE 5 : INVENTAIRE
# =======================================================
module_inventory() {
    cd "$ANSIBLE_ROOT" || return
    while true; do
        clear
        echo -e "${BLUE}################################################${NC}"
        echo -e "${BLUE}#              INVENTAIRE ANSIBLE              #${NC}"
        echo -e "${BLUE}################################################${NC}"
        echo -e "${GREY}Visualisez vos machines et testez la connexion.${NC}"
        echo -e "$SEP"
        echo -e "  ${GREEN}1.${NC} üå≥ Vue Graphique (Groupes/H√¥tes)"
        echo -e "  ${GREEN}2.${NC} üìã Vue Liste (D√©tails)"
        echo -e "  ${GREEN}3.${NC} üì° Test de connexion (PING All)"
        echo -e "  ${GREEN}4.${NC} üîç Infos d√©taill√©es (Setup/Facts)"
        echo -e "$SEP_RED"
        echo -e "  ${RED}0.${NC} Retour"
        echo -e "$SEP"

        read -p "  Choix > " c
        case $c in
            1) ansible-inventory --graph; pause ;;
            2) ansible-inventory --list | grep "ansible_host" -B 5 | less ;;
            3) echo -e "${CYAN}Ping en cours...${NC}"; ansible all -m ping; pause ;;
            4) read -p "  Machine : " h; [ -n "$h" ] && ansible "$h" -m setup | less ;;
            0) return ;;
        esac
    done
}

# =======================================================
# MODULE 6 : CRON
# =======================================================
module_cron() {
    if ! ask_sudo_gui; then return; fi
    while true; do
        clear
        echo -e "${BLUE}################################################${NC}"
        echo -e "${BLUE}#            PLANIFICATEUR (CRON)              #${NC}"
        echo -e "${BLUE}################################################${NC}"
        echo -e "${GREY}G√©rez l'ex√©cution automatique de vos playbooks.${NC}"
        echo -e "$SEP"

        echo -e "  üë§ Utilisateur actuel : ${CYAN}$CRON_USER${NC}"
        echo -e "$SEP"

        echo -e "  ${GREEN}1.${NC} üìù √âditer la table Cron (Edit)"
        echo -e "  ${GREEN}2.${NC} üìÑ Lister les t√¢ches actuelles"
        echo -e "  ${GREEN}3.${NC} üìÇ Voir les logs d'ex√©cution (Syslog)"
        echo -e "  ${GREEN}4.${NC} üîÑ Changer l'utilisateur cible"
        echo -e "$SEP_RED"
        echo -e "  ${RED}0.${NC} Retour"
        echo -e "$SEP"

        read -p "  Choix > " c
        case $c in
            1) sudo crontab -u "$CRON_USER" -e ;;
            2) echo -e "\n${CYAN}--- T√¢ches de $CRON_USER ---${NC}"; sudo crontab -u "$CRON_USER" -l; pause ;;
            3) sudo grep CRON /var/log/syslog | tail -n 20; pause ;;
            4)
                read -p "  Nouvel utilisateur pour Cron : " u
                if id "$u" &>/dev/null; then
                    export CRON_USER="$u"
                    save_config
                    echo -e "${GREEN}‚úÖ Utilisateur chang√© vers $u.${NC}"
                else
                    echo -e "${RED}‚ùå Utilisateur $u inconnu.${NC}"
                fi
                pause
                ;;
            0) return ;;
        esac
    done
}

# =======================================================
# MODULE 7 : PARE-FEU (UFW)
# =======================================================
module_firewall() {
    while true; do
        clear
        echo -e "${BLUE}################################################${NC}"
        echo -e "${BLUE}#             PARE-FEU (UFW)                   #${NC}"
        echo -e "${BLUE}################################################${NC}"

        # Statut sans blocage (si sudo NOPASSWD configur√©)
        run_sudo_silent ufw status numbered || run_sudo ufw status numbered

        echo -e "$SEP"
        echo -e "  ${GREEN}1.${NC} ‚ûï Ouvrir un Port (Allow)"
        echo -e "  ${GREEN}2.${NC} ‚ûñ Supprimer une R√®gle (Delete)"
        echo -e "  ${GREEN}3.${NC} üîÑ Recharger (Reload)"
        echo -e "$SEP_RED"
        echo -e "  ${RED}0.${NC} Retour"
        echo -e "$SEP"

        read -p "  Choix > " c
        case $c in
            1) read -p "Port (ex: 80/tcp) : " p; run_sudo ufw allow "$p"; pause ;;
            2) read -p "Num√©ro de r√®gle : " n; run_sudo ufw delete "$n"; pause ;;
            3) run_sudo ufw reload; pause ;;
            0) return ;;
        esac
    done
}

# =======================================================
# MODULE 8 : JAIL / SHELL RESTREINT
# =======================================================
module_jail() {
    local TD
    TD=$(readlink -f "$ANSIBLE_ROOT")
    local SN="Ansible"

    echo -e "\n${GREEN}üîí SHELL RESTREINT ACTIV√âE : $SN (Stealth Mode)${NC}"
    echo -e "${GREY}P√©rim√®tre : $TD${NC}"

    local REAL_SUDO=$(which sudo)
    local OH="$HOME"

    # Lancement du shell avec blocage de l'autocompl√©tion hors-zone
    bash --rcfile <(echo "
        export HOME='$TD'
        export PS1='\[\033[01;31m\](Jail:$SN) \[\033[01;34m\]\w \$ \[\033[00m\]'

        # 1. Moteur de surveillance de position
        check_jail_breach() {
            local current_phys
            current_phys=\$(pwd -P)
            if [[ \"\$current_phys\" != \"$TD\"* ]]; then
                echo -e \"\n\033[0;31m‚õî ALERTE S√âCURIT√â : Tentative de sortie d√©tect√©e.\033[0m\"
                builtin cd \"$TD\"
            fi
        }

        # 2. Blocage de l'autocompl√©tion hors p√©rim√®tre
        # On d√©sactive la compl√©tion standard des fichiers/commandes qui sortent du dossier
        _jail_completion() {
            local cur=\"\${COMP_WORDS[COMP_CWORD]}\"
            # Si l'utilisateur tente de compl√©ter un chemin absolu ou un retour en arri√®re
            if [[ \"\$cur\" == /* || \"\$cur\" == *..* ]]; then
                COMPREPLY=()
            else
                # On autorise uniquement la compl√©tion des fichiers locaux
                COMPREPLY=( \$(compgen -f -- \"\$cur\") )
            fi
        }
        # Appliquer √† cd, ls, nano, etc. (ou par d√©faut)
        complete -F _jail_completion -D

        # 3. Wrapper SUDO Inspecteur
        sudo() {
            local forbidden=false
            for arg in \"\$@\"; do
                if [[ \"\$arg\" == /* || \"\$arg\" == *..* ]]; then
                    local abs_arg=\$(readlink -f \"\$arg\" 2>/dev/null)
                    if [[ \"\$abs_arg\" != \"$TD\"* ]]; then forbidden=true; fi
                fi
            done

            if [ \"\$forbidden\" = true ]; then
                echo -e \"\033[0;31m‚ùå ACC√àS REFUS√â : Hors p√©rim√®tre.\033[0m\"
                return 1
            fi

            if [[ \"\$1\" == \"bash\" || \"\$1\" == \"sh\" ]]; then
                $REAL_SUDO bash --rcfile <(echo \"export PS1='[ROOT-JAIL] \w # '; check_jail_breach() { if [[ \\\$(pwd -P) != \\\"$TD\\\"* ]]; then builtin cd \\\"$TD\\\"; fi; }; export PROMPT_COMMAND='check_jail_breach'; cd \\\"$TD\\\"\")
            else
                $REAL_SUDO \"\$@\"
            fi
            check_jail_breach
        }

        export PROMPT_COMMAND='check_jail_breach'
        alias su='echo ‚ùå Commande d√©sactiv√©e'

        builtin cd \"$TD\"
    ")

    export HOME="$OH"
    trap '' SIGINT SIGQUIT SIGTSTP
}

# =======================================================
# AUTRES
# =======================================================
module_updates() {
    if ask_sudo_gui; then sudo apt update && sudo apt upgrade -y; pause; fi
}
module_power() {
    if [ "$1" == "OFF" ]; then sudo poweroff; else sudo reboot; fi
}
open_user_shell() {
    if ! ask_sudo_gui; then return; fi
    trap - SIGINT SIGQUIT SIGTSTP; export SKIP_KIOSK=1
    cd "$ANSIBLE_ROOT" || cd "$HOME"; bash --login; unset SKIP_KIOSK; trap '' SIGINT SIGQUIT SIGTSTP
}

# =======================================================
# BOUCLE PRINCIPALE
# =======================================================
while true; do
    clear
    get_sys_info

    echo -e "${BLUE}###########################${NC}"
    echo -e "${BLUE}#       ANSIBLE MANAGER   #${NC}"
    echo -e "${BLUE}###########################${NC}"

    printf "  üñ•Ô∏è  ${CYAN}%-29s${NC} | ‚è±Ô∏è  ${GREY}%s${NC}\n" "$OS_NAME" "$SYS_UPTIME"
    printf "  üß† CPU: ${YELLOW}%-23s${NC} | üíæ RAM: ${YELLOW}%s${NC}\n" "$CPU_USAGE" "$RAM_USAGE"
    printf "  üè† LAN: ${YELLOW}%-23s${NC} | üåç WAN: ${YELLOW}%s${NC}\n" "$LOCAL_IP" "$PUBLIC_IP"
    echo -e "$SEP"
    printf "  ‚è∞ Automate : %-20b | üõ°Ô∏è  Pare-feu : %s\n" "$SX" "$FW"
    printf "  ‚ÑπÔ∏è  Ansible  : %-20s | üìÅ Racine    : %s\n" "${CYAN}$APP_VER${NC}" "$(basename "$ANSIBLE_HOME")"
    printf "  üê± Git Stat : %-20b | üíæ Backup Loc : %s\n" "$ST_GIT" "$ST_BKP"
    printf "  üë§ Cron User : %-20s | üìâ Log Err    : %b\n" "$CRON_USER" "$ST_CRON"
    echo -e "$SEP"

    # Section 1
    echo -e " ${BOLD}${CYAN}üöÄ OP√âRATIONS & D√âVELOPPEMENT${NC}"
    echo -e "    ${GREEN}1.${NC} üßô Assistant Cr√©ation (R√¥les/Tasks)"
    echo -e "    ${GREEN}2.${NC} üöÄ Lancer un Playbook"
    echo -e "    ${GREEN}3.${NC} üíé Centre de Sauvegardes & Git"
    echo -e "    ${GREEN}4.${NC} üîê Secrets & Config Projet (.vault/cfg)"
    echo ""

    # Section 2 (Verticale)
    echo -e " ${BOLD}${CYAN}üõ†Ô∏è  OUTILS${NC}"
    echo -e "    ${GREEN}5.${NC} üåç Inventaire Ansible"
    echo -e "    ${GREEN}6.${NC} ‚è∞ T√¢ches Planifi√©es (Cron)"
    echo -e "    ${GREEN}7.${NC} üß± Pare-feu (UFW)"
    echo -e "    ${GREEN}8.${NC} üîí Shell Restreint (Jail)"
    echo -e "    ${GREEN}9.${NC} üì¶ Mises √† jour Syst√®me"

    echo -e "$SEP_RED"

    # Section 3
    echo -e " ${BOLD}${RED}üíÄ SYST√àME${NC}"
    echo -e "    ${RED}10.${NC}üîå √âteindre le serveur"
    echo -e "    ${RED}11.${NC}‚ôªÔ∏è  Red√©marrer le serveur"
    echo -e "$SEP"

    # Footer
    echo -e "  [${YELLOW}admin${NC}] üíª Console Admin    |    [${RED}exit${NC}] üö™ Quitter"
    echo -e "$SEP"

    read -r -p "  Votre choix > " choice

    case "$choice" in
        1) module_assistant_dev ;;
        2) module_launcher ;;
        3) module_backup_git ;;
        4) module_project_config ;;
        5) module_inventory ;;
        6) module_cron ;;
        7) module_firewall ;;
        8) module_jail ;;
        9) module_updates ;;
        10) module_power "OFF" ;;
        11) module_power "REBOOT" ;;
        admin) open_user_shell ;;
        exit|q)
            kill -9 $PPID 2>/dev/null || exit 0
            ;;
        *) echo "Choix invalide."; sleep 0.5 ;;
    esac
done
