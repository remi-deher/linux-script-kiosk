#!/bin/bash
# =======================================================
#  MANAGER ANSIBLE - VERSION FINALE (OPTIMISÃ‰E)
# =======================================================

# --- CONFIGURATION ---
export ANSIBLE_HOME_RAW="${ANSIBLE_HOME:-$HOME/ansible}"
export ANSIBLE_HOME=$(readlink -f "$ANSIBLE_HOME_RAW")
export SCRIPTS_DIR="$ANSIBLE_HOME/scripts"
SERVICE_NAME="cron"
CMD_UFW="/usr/sbin/ufw"

# --- SÃ‰CURITÃ‰ & COULEURS ---
trap '' SIGINT SIGQUIT SIGTSTP

BLUE=$'\033[0;34m'
GREEN=$'\033[0;32m'
RED=$'\033[0;31m'
YELLOW=$'\033[1;33m'
CYAN=$'\033[0;36m'
GREY=$'\033[1;30m'
NC=$'\033[0m'
BOLD=$'\033[1m'

# --- GESTION SUDO ---

ask_sudo_gui() {
    if sudo -n true 2>/dev/null; then
        return 0
    fi

    echo -e "\n${YELLOW}ðŸ”’ Authentification requise${NC}"
    read -s -p "Mot de passe : " user_pass
    echo ""

    echo "$user_pass" | sudo -S -v 2>/dev/null
    if [ $? -eq 0 ]; then
        return 0
    else
        echo -e "${RED}âŒ Incorrect.${NC}"
        pause
        return 1
    fi
}

run_sudo() {
    if sudo -n "$@" 2>/dev/null; then
        return 0
    fi

    if sudo -n true 2>/dev/null; then
        sudo "$@" 2>/dev/null
        return $?
    fi

    if ! ask_sudo_gui; then
        return 1
    fi
    sudo "$@"
}

run_sudo_silent() {
    if sudo -n "$@" 2>/dev/null; then
        return 0
    fi
    return 1
}

pause() {
    echo ""
    read -p "EntrÃ©e pour continuer..."
}

server_power_action() {
    local a="$1"
    local c="$2"
    local cw=$(echo "$a" | tr '[:upper:]' '[:lower:]' | sed 's/Ã©/e/g')

    echo -e "\n${RED}${BOLD}âš ï¸  ATTENTION : $a LE SYSTÃˆME${NC}"
    read -p "Tapez '$cw' : " i

    if [ "$i" == "$cw" ]; then
        run_sudo $c
        exit 0
    else
        echo "AnnulÃ©."
        pause
    fi
}

get_sys_info() {
    LOCAL_IP=$(hostname -I | awk '{print $1}')
    PUBLIC_IP=$(curl -s -4 -m 3 https://icanhazip.com 2>/dev/null)
    [[ ! "$PUBLIC_IP" =~ ^[0-9.]+$ ]] && PUBLIC_IP="N/A"

    OS_NAME=$(grep -oP 'PRETTY_NAME="\K[^"]+' /etc/os-release 2>/dev/null | cut -c1-20)
    [ -z "$OS_NAME" ] && OS_NAME="Linux"

    CPU_USAGE=$(top -bn1 | grep "Cpu(s)" | sed "s/.*, *\([0-9.]*\)%* id.*/\1/" | awk '{print 100 - $1"%"}' 2>/dev/null)
    [ -z "$CPU_USAGE" ] && CPU_USAGE="N/A"

    RAM_USAGE=$(free -h | awk '/^Mem:/ {print $3 "/" $2}')
    SYS_UPTIME=$(uptime -p | sed 's/up //;s/ hours/h/;s/ minutes/m/')

    APP_VER=$(ansible --version 2>/dev/null | head -n1 | awk '{print $NF}' | tr -d ']')
    PY_VER=$(python3 --version 2>/dev/null | awk '{print $2}')
}

open_user_shell() {
    if ! ask_sudo_gui; then return; fi
    echo -e "\n${GREEN}ðŸ”“ AccÃ¨s autorisÃ©.${NC}"
    trap - SIGINT SIGQUIT SIGTSTP
    export SKIP_KIOSK=1
    cd "$ANSIBLE_HOME" || cd "$HOME"
    bash --login
    unset SKIP_KIOSK
    trap '' SIGINT SIGQUIT SIGTSTP
}

spawn_restricted_shell() {
    local TD=$(readlink -f "$1")
    local SN="$2"
    [ ! -d "$TD" ] && mkdir -p "$TD"

    echo -e "\n${GREEN}ðŸ”’ JAIL $SN${NC}"
    local OH="$HOME"

    bash --rcfile <(echo "export HOME='$TD'; export PS1='(Restreint:$SN) \[\033[01;34m\]\w\[\033[00m\]\\$ '; check_path() { local c=\$(pwd -P); if [[ \"\$c\" != \"$TD\"* ]]; then echo -e \"\n${RED}â›” Interdit.${NC}\"; cd \"$TD\"; fi; }; alias cd='check_path; cd'; export PROMPT_COMMAND='check_path'; export PATH='/usr/local/bin:/usr/bin:/bin'")

    export HOME="$OH"
    trap '' SIGINT SIGQUIT SIGTSTP
}

run_tool() {
    local script_path="$1"
    local require_sudo="$2"
    export ANSIBLE_HOME

    if [ -f "$script_path" ]; then
        [ ! -x "$script_path" ] && chmod +x "$script_path"

        if [ "$require_sudo" == "true" ]; then
            if ask_sudo_gui; then sudo -E "$script_path"; fi
        else
            trap - SIGINT SIGQUIT SIGTSTP
            "$script_path"
            trap '' SIGINT SIGQUIT SIGTSTP
        fi
    else
        echo -e "${RED}Script introuvable ($script_path)${NC}"
        pause
    fi
}

menu_system_update() {
    while true; do
        clear
        echo -e "${BLUE}=== MISE Ã€ JOUR ===${NC}"
        echo -e "1. Update | 2. Clean | 3. Dist | r. Retour"
        read -r -p "> " u

        case "$u" in
            1)
                if ask_sudo_gui; then
                    sudo apt update && sudo apt upgrade -y
                    pause
                fi
                ;;
            2)
                if ask_sudo_gui; then
                    sudo apt autoremove -y
                    pause
                fi
                ;;
            3)
                if ask_sudo_gui; then
                    sudo apt dist-upgrade -y
                    pause
                fi
                ;;
            r) return ;;
        esac
    done
}

# --- GESTION PARE-FEU UNIFIÃ‰E ---

firewall_checkbox_delete() {
    mapfile -t RULES < <(run_sudo $CMD_UFW status numbered | grep "^\[")
    if [ ${#RULES[@]} -eq 0 ]; then echo "Aucune rÃ¨gle."; pause; return; fi

    declare -a SEL; for i in "${!RULES[@]}"; do SEL[$i]=false; done

    while true; do
        clear
        echo -e "${RED}${BOLD}SUPPRESSION RÃˆGLES (Cochez pour supprimer)${NC}"
        for i in "${!RULES[@]}"; do
            NUM=$(echo "${RULES[$i]}" | sed -E 's/^\[([ 0-9]+)\].*/\1/' | xargs)
            DESC=$(echo "${RULES[$i]}" | sed -E 's/^\[[ 0-9]+\] //')
            if [ "${SEL[$i]}" == "true" ]; then M="${RED}[X]${NC}"; else M="${GREEN}[ ]${NC}"; fi
            printf " %b | %2s | %s\n" "$M" "$NUM" "$DESC"
        done
        echo "------------------------------------------------"
        echo -e "  [Num] Basculer | [a] Tout | [n] Rien"
        echo -e "  [v]   VALIDER | [r] Retour"
        read -r -p "> " k

        if [[ "$k" =~ ^[0-9]+$ ]]; then
            for i in "${!RULES[@]}"; do
                rn=$(echo "${RULES[$i]}" | sed -E 's/^\[([ 0-9]+)\].*/\1/' | xargs)
                if [ "$rn" == "$k" ]; then
                    if [ "${SEL[$i]}" == "true" ]; then SEL[$i]=false; else SEL[$i]=true; fi
                fi
            done
        elif [ "$k" == "v" ]; then
            declare -a DELS
            for i in "${!RULES[@]}"; do
                if [ "${SEL[$i]}" == "true" ]; then
                    rn=$(echo "${RULES[$i]}" | sed -E 's/^\[([ 0-9]+)\].*/\1/' | xargs)
                    DELS+=("$rn")
                fi
            done
            if [ ${#DELS[@]} -gt 0 ]; then
                if ask_sudo_gui; then
                    SORTED=$(printf "%s\n" "${DELS[@]}" | sort -nr)
                    for n in $SORTED; do echo "Suppression rÃ¨gle #$n..."; yes | sudo $CMD_UFW delete "$n" >/dev/null; done
                    echo -e "${GREEN}TerminÃ©.${NC}"; pause; break
                fi
            else echo "Aucune sÃ©lection."; pause; fi
        elif [ "$k" == "r" ]; then break
        elif [ "$k" == "a" ]; then for i in "${!RULES[@]}"; do SEL[$i]=true; done
        elif [ "$k" == "n" ]; then for i in "${!RULES[@]}"; do SEL[$i]=false; done
        fi
    done
}

firewall_manager() {
    while true; do
        clear
        if run_sudo_silent $CMD_UFW status | grep -q "active"; then ST="${GREEN}ACTIF${NC}"; else ST="${RED}INACTIF${NC}"; fi
        echo -e "${BLUE}=== GESTION PARE-FEU ($ST) ===${NC}"

        mapfile -t RULES < <(run_sudo $CMD_UFW status numbered | grep "^\[")
        if [ ${#RULES[@]} -eq 0 ]; then echo "   (Aucune rÃ¨gle)"; else
            for line in "${RULES[@]}"; do
                echo "$line" | sed "s/ALLOW/${GREEN}ALLOW${NC}/" | sed "s/DENY/${RED}DENY${NC}/"
            done
        fi

        echo "------------------------------------------------"
        echo -e "  ${GREEN}1.${NC} ðŸ”‘ Ouvrir SSH (22)"
        echo -e "  ${GREEN}2.${NC} âž• Ouvrir Port Manuel"
        echo -e "  ${GREEN}3.${NC} âš¡ Activer UFW (Enable)"
        echo -e "  ${RED}4.${NC} ðŸ—‘ï¸  Supprimer des rÃ¨gles (SÃ©lection)"
        echo -e "  ${RED}5.${NC} ðŸ›‘ DÃ©sactiver UFW (Disable)"
        echo "------------------------------------------------"
        echo -e "  ${RED}0.${NC} ðŸ”™ Retour au menu principal"
        read -r -p "Choix > " c

        case "$c" in
            1) if ask_sudo_gui; then run_sudo $CMD_UFW allow 22/tcp; echo "OK"; pause; fi ;;
            2) read -p "Port : " p; [ -n "$p" ] && if ask_sudo_gui; then run_sudo $CMD_UFW allow "$p"; pause; fi ;;
            3) if ask_sudo_gui; then run_sudo $CMD_UFW enable; pause; fi ;;
            4) firewall_checkbox_delete ;;
            5) if ask_sudo_gui; then run_sudo $CMD_UFW disable; pause; fi ;;
            0) return ;;
        esac
    done
}

# --- 4. BOUCLE PRINCIPALE ---
SEP="${BLUE}------------------------------------------------${NC}"
SEP_RED="${RED}------------------------------------------------${NC}"

while true; do
    clear
    get_sys_info

    if systemctl is-active --quiet cron; then
        SX="${GREEN}â— ACTIF${NC}"
    else
        SX="${RED}â— OFF${NC}"
    fi

    if run_sudo_silent $CMD_UFW status 2>/dev/null | grep -q "Status: active"; then
        FW="${GREEN}â— ACTIF${NC}"
    else
        FW="${RED}â— INACTIF${NC}"
    fi

    # --- EN-TÃŠTE AVEC CADRE BLEU ---
    echo -e "${BLUE}################################################${NC}"
    echo -e "${BLUE}#        ANSIBLE CONTROLLER - DASHBOARD        #${NC}"
    echo -e "${BLUE}################################################${NC}"

    # --- INFOS SYSTÃˆME ---
    printf "  ðŸ–¥ï¸  %-21s | â±ï¸  %s\n" "${CYAN}$OS_NAME${NC}" "${GREY}$SYS_UPTIME${NC}"
    printf "  ðŸ§  CPU: %-15s | ðŸ’¾ RAM: %s\n" "${YELLOW}$CPU_USAGE${NC}" "${YELLOW}$RAM_USAGE${NC}"
    printf "  ðŸ  LAN: %-15s | ðŸ Python: %s\n" "${YELLOW}$LOCAL_IP${NC}" "${YELLOW}$PY_VER${NC}"

    echo -e "$SEP"

    # --- INFO SERVICE ---
    printf "  â° Automate : %-11b | ðŸ›¡ï¸  Pare-feu : %s\n" "$SX" "$FW"
    printf "  â„¹ï¸  Ansible  : %-11s | ðŸ“ Racine   : %s\n" "${CYAN}$APP_VER${NC}" "$(basename "$ANSIBLE_HOME")"

    echo -e "$SEP"

    # --- MENU : AUTOMATISATION ---
    echo -e " ${BOLD}${CYAN}ðŸ¤– AUTOMATISATION${NC}"
    echo -e "    ${GREEN}1.${NC} ðŸš€ Lancer un Playbook"
    echo -e "    ${GREEN}2.${NC} â° GÃ©rer les TÃ¢ches Cron"
    echo -e "    ${GREEN}3.${NC} ðŸ” Gestion des Secrets (Vault)"
    echo ""

    # --- MENU : OUTILS ---
    echo -e " ${BOLD}${CYAN}ðŸ› ï¸  OUTILS & PARAMÃˆTRES${NC}"
    echo -e "    ${GREEN}4.${NC} ðŸŒ Explorateur d'Inventaire"
    echo -e "    ${GREEN}5.${NC} ðŸ”’ Explorateur Fichiers (Jail)"
    echo -e "    ${GREEN}6.${NC} âž• CrÃ©er un nouveau RÃ´le"
    echo -e "    ${GREEN}7.${NC} ðŸ§± Pare-feu (UFW)"
    echo -e "    ${GREEN}8.${NC} ðŸš€ Mises Ã  jour (App & OS)"

    echo -e "$SEP_RED"

    # --- MENU : SYSTÃˆME (Danger) ---
    echo -e " ${BOLD}${RED}ðŸ’€ ZONES SYSTÃˆME${NC}"
    echo -e "    ${RED}9.${NC} ðŸ”Œ Ã‰teindre le serveur"
    echo -e "    ${RED}10.${NC}â™»ï¸  RedÃ©marrer le serveur"

    echo -e "$SEP"

    # --- PIED DE PAGE ---
    echo -e "  [${YELLOW}admin${NC}] ðŸ’» Console Admin   |   [${RED}exit${NC}] ðŸšª Quitter"
    echo -e "$SEP"

    read -r -p "  Votre choix > " choice

    case "$choice" in
        1) run_tool "$SCRIPTS_DIR/launcher.sh" "false" ;;
        2)
            if [ -f "$SCRIPTS_DIR/manage_ansible_cron.sh" ]; then
                run_tool "$SCRIPTS_DIR/manage_ansible_cron.sh" "true"
            else
                run_tool "$SCRIPTS_DIR/manage_cron.sh" "true"
            fi
            ;;
        3) run_tool "$SCRIPTS_DIR/vault_manager.sh" "false" ;;
        4) run_tool "$SCRIPTS_DIR/inventory_tool.sh" "false" ;;
        5) spawn_restricted_shell "$ANSIBLE_HOME" "ANSIBLE" ;;
        6)
            [ -f "$SCRIPTS_DIR/create_role.sh" ] && run_tool "$SCRIPTS_DIR/create_role.sh" "false" || { echo "Script manquant"; pause; }
            ;;
        7) firewall_manager ;;
        8) menu_system_update ;;
        9) server_power_action "Ã‰TEINDRE" "poweroff" ;;
        10) server_power_action "REDÃ‰MARRER" "reboot" ;;
        admin) open_user_shell ;;
        exit|q) kill -9 $PPID 2>/dev/null; exit 0 ;;
        *) echo "Invalide"; sleep 0.5 ;;
    esac
done
