#!/bin/bash
# =======================================================
#  MANAGER ZORAXY - VERSION FINALE (OPTIMIS√âE)
# =======================================================

# --- CONFIGURATION ---
SERVICE_NAME="zoraxy"
ZORAXY_HOME="/etc/zoraxy"
COOKIE_FILE="/tmp/zoraxy_cookie.txt"
VERSION_FILE="$ZORAXY_HOME/current_version"
BACKUP_DIR="/var/backups/zoraxy"
VERSION_CACHE="/tmp/zoraxy_latest_ver"
PUBLIC_IP_CACHE="/tmp/zoraxy_public_ip"
CMD_UFW="/usr/sbin/ufw"
CONF_CERT="$ZORAXY_HOME/conf/certs"

# --- NETTOYAGE PR√âVENTIF ---
rm -f "$COOKIE_FILE"

# --- S√âCURIT√â & COULEURS ---
trap '' SIGINT SIGQUIT SIGTSTP

BLUE=$'\033[0;34m'
GREEN=$'\033[0;32m'
RED=$'\033[0;31m'
YELLOW=$'\033[1;33m'
CYAN=$'\033[0;36m'
GREY=$'\033[1;30m'
NC=$'\033[0m'
BOLD=$'\033[1m'

# --- FONCTIONS UTILITAIRES ---

# D√©tection du port utilis√© par Zoraxy
get_running_port() {
    PORT_SERVICE=$(systemctl cat "$SERVICE_NAME" 2>/dev/null | grep -oE "\-port=:[0-9]+" | head -n1 | cut -d: -f2)
    if [ -n "$PORT_SERVICE" ]; then
        echo "$PORT_SERVICE"
        return
    fi

    PID=$(pgrep -x "zoraxy" | head -n1)
    if [ -n "$PID" ]; then
        PORT=$(sudo netstat -tulpn 2>/dev/null | grep "$PID/zoraxy" | head -n1 | awk '{print $4}' | awk -F: '{print $NF}')
        if [ -n "$PORT" ]; then
            echo "$PORT"
            return
        fi
    fi
    echo "8000"
}

# Initialisation des variables globales
CURRENT_PORT=$(get_running_port)
API_URL="http://127.0.0.1:$CURRENT_PORT"

ask_sudo_gui() {
    if sudo -n true 2>/dev/null; then
        return 0
    fi

    echo -e "\n${YELLOW}üîí Authentification syst√®me requise${NC}"
    read -s -p "Mot de passe Sudo : " user_pass
    echo ""

    echo "$user_pass" | sudo -S -v 2>/dev/null
    if [ $? -eq 0 ]; then
        return 0
    else
        echo -e "${RED}‚ùå Incorrect.${NC}"
        pause
        return 1
    fi
}

run_sudo() {
    if sudo -n true 2>/dev/null; then
        sudo "$@"
        return $?
    fi
    if ! ask_sudo_gui; then
        return 1
    fi
    sudo "$@"
}

run_sudo_silent() {
    if sudo -n "$@" 2>/dev/null; then
        return 0
    fi
    return 1
}

pause() {
    echo ""
    read -p "Entr√©e pour continuer..."
}

check_requirements() {
    if ! command -v jq &> /dev/null; then
        echo "Erreur: 'jq' manquant. sudo apt install jq"
        exit 1
    fi
}

server_power_action() {
    local a="$1"
    local c="$2"
    local cw=$(echo "$a" | tr '[:upper:]' '[:lower:]' | sed 's/√©/e/g')

    echo -e "\n${RED}${BOLD}‚ö†Ô∏è  ATTENTION : $a LE SYST√àME${NC}"
    read -p "Tapez '$cw' pour confirmer : " i

    if [ "$i" == "$cw" ]; then
        run_sudo $c
        exit 0
    else
        echo "Annul√©."
        pause
    fi
}

get_sys_info() {
    LOCAL_IP=$(hostname -I | awk '{print $1}')

    if [ -f "$PUBLIC_IP_CACHE" ] && [ $(( $(date +%s) - $(stat -c %Y "$PUBLIC_IP_CACHE") )) -lt 3600 ]; then
        PUBLIC_IP=$(cat "$PUBLIC_IP_CACHE")
    else
        PUBLIC_IP=$(curl -s -4 -m 3 https://icanhazip.com 2>/dev/null)
        [[ "$PUBLIC_IP" =~ ^[0-9.]+$ ]] && echo "$PUBLIC_IP" > "$PUBLIC_IP_CACHE" || PUBLIC_IP="N/A"
    fi

    OS_NAME=$(grep -oP 'PRETTY_NAME="\K[^"]+' /etc/os-release 2>/dev/null | cut -c1-20)
    [ -z "$OS_NAME" ] && OS_NAME="Linux"

    CPU_USAGE=$(top -bn1 | grep "Cpu(s)" | sed "s/.*, *\([0-9.]*\)%* id.*/\1/" | awk '{print 100 - $1"%"}' 2>/dev/null)
    [ -z "$CPU_USAGE" ] && CPU_USAGE="N/A"

    RAM_USAGE=$(free -h | awk '/^Mem:/ {print $3 "/" $2}')
    SYS_UPTIME=$(uptime -p | sed 's/up //;s/ hours/h/;s/ minutes/m/')

    if [ -f "$VERSION_FILE" ]; then
        APP_VER=$(cat "$VERSION_FILE")
    else
        APP_VER="Unknown"
    fi
}

# --- AUTHENTIFICATION API ---

check_api_token_bool() {
    if [ ! -f "$COOKIE_FILE" ]; then
        return 1
    fi

    CHECK=$(curl -s -m 2 -k -b "$COOKIE_FILE" "$API_URL/api/auth/username")
    if [[ "$CHECK" == *\"* ]] && [[ "$CHECK" != *"error"* ]] && [[ "$CHECK" != *"<html"* ]]; then
        return 0
    fi
    return 1
}

ensure_api_auth() {
    if check_api_token_bool; then return 0; fi

    echo -e "\n${CYAN}üîê Authentification API Zoraxy requise${NC}"
    HOMEPAGE=$(curl -s -L -k -c "$COOKIE_FILE" -b "$COOKIE_FILE" "$API_URL/" --max-time 2)

    if [ $? -ne 0 ]; then
        echo -e "${RED}Erreur: Zoraxy injoignable ($API_URL)${NC}"
        return 1
    fi

    CSRF_TOKEN=$(echo "$HOMEPAGE" | grep -o 'name="zoraxy.csrf.Token" content="[^"]*"' | head -n 1 | sed 's/.*content="//;s/"//')
    [ -z "$CSRF_TOKEN" ] && { echo "Erreur Token CSRF"; return 1; }

    while true; do
        read -p "Utilisateur : " u
        read -s -p "Mot de passe : " p
        echo ""

        curl -s -k -X POST -c "$COOKIE_FILE" -b "$COOKIE_FILE" -H "X-CSRF-Token: $CSRF_TOKEN" -d "username=$u" -d "password=$p" "$API_URL/api/auth/login" > /dev/null

        if check_api_token_bool; then
            echo -e "${GREEN}Connexion r√©ussie.${NC}"
            return 0
        else
            echo -e "${RED}Identifiants incorrects.${NC}"
            read -p "R√©essayer ? (o/n) " r
            if [[ "$r" != "o" ]]; then return 1; fi
        fi
    done
}

get_api_status_indicator() {
    if check_api_token_bool; then
        echo -e "${GREEN}‚óè Connect√©${NC}"
    else
        echo -e "${RED}‚óè D√©connect√©${NC}"
    fi
}

api_req() {
    endpoint="$1"
    shift
    HOMEPAGE=$(curl -s -k -b "$COOKIE_FILE" "$API_URL/")
    CSRF_TOKEN=$(echo "$HOMEPAGE" | grep -o 'name="zoraxy.csrf.Token" content="[^"]*"' | head -n 1 | sed 's/.*content="//;s/"//')
    curl -s -k -b "$COOKIE_FILE" -H "X-CSRF-Token: $CSRF_TOKEN" "$@" "$API_URL$endpoint"
}

# --- GESTION PROXY ---

declare -A MAP_DOMAINS
declare -A MAP_TARGETS
COUNT_PROXIES=0

refresh_proxy_list_api() {
    if ! check_api_token_bool; then ensure_api_auth || return 1; fi

    echo -e "${CYAN}Chargement depuis l'API...${NC}"
    JSON=$(api_req "/api/proxy/list" --data-urlencode "type=host")

    MAP_DOMAINS=()
    MAP_TARGETS=()
    COUNT_PROXIES=0

    API_ST=$(get_api_status_indicator)
    clear
    echo -e "${BLUE}=== LISTE VHOSTS (API) ===${NC}  [üîå API: $API_ST]"
    printf "${GREY}%-3s %-30s %-25s %-8s %-8s${NC}\n" "ID" "DOMAINE" "CIBLE" "SSL" "√âTAT"
    echo "--------------------------------------------------------------------------------"

    # Parsing JSON via JQ
    mapfile -t SITES < <(echo "$JSON" | jq -r 'to_entries[] | "\(.value.RootOrMatchingDomain)|\(.value.ActiveOrigins[0].OriginIpOrDomain // "N/A")|\(.value.UseTLS // false)|\(.value.Disabled // false)"')

    if [ ${#SITES[@]} -eq 0 ]; then
        echo "   (Aucun proxy trouv√©)"
    else
        for site in "${SITES[@]}"; do
            COUNT_PROXIES=$((COUNT_PROXIES+1))
            IFS='|'
            read -r domain target use_tls is_disabled <<< "$site"

            # V√©rification certificat local (approximatif)
            if sudo -n test -f "$CONF_CERT/$domain.pem" 2>/dev/null || [ -f "$CONF_CERT/$domain.pem" ]; then
                ssl_txt="${GREEN}OUI${NC}"
            else
                ssl_txt="${RED}NON${NC}"
            fi

            # √âtat du proxy
            if [[ "$is_disabled" == "true" ]]; then
                st_txt="${RED}‚óè OFF${NC}"
            else
                st_txt="${GREEN}‚óè ON${NC}"
            fi

            printf "%-3s %-30s %-25s %-8b %b\n" "$COUNT_PROXIES" "${domain:0:29}" "${target:0:24}" "$ssl_txt" "$st_txt"

            MAP_DOMAINS[$COUNT_PROXIES]="$domain"
            MAP_TARGETS[$COUNT_PROXIES]="$target"
        done
    fi
    echo "--------------------------------------------------------------------------------"
}

# --- ACTIONS WIZARD ---

add_proxy_wizard() {
    echo -e "\n${BLUE}=== üßô ASSISTANT AJOUT ===${NC}"
    read -p "Domaine (ex: app.lan) : " d
    [ -z "$d" ] && return

    read -p "Cible (IP:Port) : " t
    [ -z "$t" ] && return

    read -p "HTTPS Cible ? (o/n) : " x
    [ "$x" == "o" ] && tls="true" || tls="false"

    api_req "/api/proxy/add" --data-urlencode "type=host" --data-urlencode "rootname=$d" --data-urlencode "ep=$t" --data-urlencode "tls=$tls" >/dev/null
    echo -e "\n${GREEN}Ajout√©.${NC}"
    pause
}

edit_proxy_target() {
    read -p "Num√©ro : " sel
    if [[ "$sel" =~ ^[0-9]+$ ]] && [ -n "${MAP_DOMAINS[$sel]}" ]; then
        dom="${MAP_DOMAINS[$sel]}"
        old="${MAP_TARGETS[$sel]}"

        echo -e "Cible actuelle : ${YELLOW}$old${NC}"
        read -p "Nouvelle Cible : " new_ep
        [ -z "$new_ep" ] && return

        read -p "HTTPS sur nouvelle cible ? (o/n) : " x
        [ "$x" == "o" ] && tls="true" || tls="false"

        # On utilise add pour √©craser/mettre √† jour
        api_req "/api/proxy/add" --data-urlencode "type=host" --data-urlencode "rootname=$dom" --data-urlencode "ep=$new_ep" --data-urlencode "tls=$tls" >/dev/null
        echo -e "\n${GREEN}Mise √† jour envoy√©e.${NC}"
        pause
    fi
}

delete_proxy_ui() {
    read -p "Num√©ro : " sel
    if [[ "$sel" =~ ^[0-9]+$ ]] && [ -n "${MAP_DOMAINS[$sel]}" ]; then
        dom="${MAP_DOMAINS[$sel]}"
        read -p "Supprimer $dom ? (o/n) " c
        if [ "$c" == "o" ]; then
            api_req "/api/proxy/del" --data-urlencode "type=host" --data-urlencode "ep=$dom" >/dev/null
            echo "Supprim√©."
            pause
        fi
    fi
}

ssl_proxy_ui() {
    read -p "Num√©ro : " sel
    if [[ "$sel" =~ ^[0-9]+$ ]] && [ -n "${MAP_DOMAINS[$sel]}" ]; then
        dom="${MAP_DOMAINS[$sel]}"
        read -p "Email (Let's Encrypt) : " email
        echo "Demande en cours..."
        api_req "/api/acme/obtainCert" --data-urlencode "domains=$dom" --data-urlencode "filename=$dom" --data-urlencode "email=$email" --data-urlencode "ca=Let's Encrypt" --data-urlencode "skipTLS=false" --data-urlencode "dns=false" >/dev/null
        echo "Fini."
        pause
    fi
}

manage_zoraxy_menu() {
    ensure_api_auth || return
    check_requirements
    while true; do
        clear
        refresh_proxy_list_api
        echo -e "${BOLD}--- ACTIONS ---${NC}"
        echo -e "  ${GREEN}1.${NC} ‚ûï Ajouter | ${CYAN}2.${NC} Modifier Cible | ${CYAN}3.${NC} SSL | ${RED}4.${NC} Supprimer | ${RED}r.${NC} Retour"
        read -r -p "> " ch
        case "$ch" in
            1) add_proxy_wizard ;;
            2) edit_proxy_target ;;
            3) ssl_proxy_ui ;;
            4) delete_proxy_ui ;;
            r) break ;;
            *) echo "Invalide"; sleep 0.5 ;;
        esac
    done
}

# --- WORKFLOW PORT ---

workflow_change_port() {
    clear
    echo -e "${BLUE}=== ‚öôÔ∏è  CHANGEMENT DE PORT ===${NC}"
    echo "Port Actuel : $CURRENT_PORT"
    read -p "Nouveau Port : " new_port

    if [[ ! "$new_port" =~ ^[0-9]+$ ]] || [ "$new_port" -eq "$CURRENT_PORT" ]; then
        echo "Invalide."
        pause
        return
    fi

    echo -e "\n${BOLD}1. Authentification REQUISE${NC}"
    rm -f "$COOKIE_FILE"
    if ! ensure_api_auth; then return; fi
    if ! ask_sudo_gui; then return; fi

    echo -e "\n${BOLD}2. Mise √† jour VHosts...${NC}"
    JSON=$(api_req "/api/proxy/list" --data-urlencode "type=host")
    mapfile -t TARGETS < <(echo "$JSON" | jq -r 'to_entries[] | "\(.value.RootOrMatchingDomain)|\(.value.ActiveOrigins[0].OriginIpOrDomain)"')

    local_ip=$(hostname -I | awk '{print $1}')
    count=0

    for item in "${TARGETS[@]}"; do
        domain=${item%%|*}
        target=${item#*|}

        if [[ "$target" =~ (127\.0\.0\.1|localhost|$local_ip):$CURRENT_PORT ]]; then
            new_target=$(echo "$target" | sed "s/:$CURRENT_PORT/:$new_port/")
            echo -e "  -> Update $domain : $target => $new_target"
            api_req "/api/proxy/add" --data-urlencode "type=host" --data-urlencode "rootname=$domain" --data-urlencode "ep=$new_target" --data-urlencode "tls=false" >/dev/null
            ((count++))
        fi
    done

    echo "  $count mis √† jour."
    echo -e "\n${BOLD}3. Syst√®me & Restart...${NC}"
    SERVICE_PATH=$(systemctl show -p FragmentPath "$SERVICE_NAME" | cut -d= -f2)
    run_sudo sed -i "s/-port=:$CURRENT_PORT/-port=:$new_port/g" "$SERVICE_PATH"

    run_sudo ufw allow "$new_port/tcp" >/dev/null
    run_sudo ufw delete allow "$CURRENT_PORT/tcp" >/dev/null
    run_sudo systemctl daemon-reload
    run_sudo systemctl restart "$SERVICE_NAME"

    CURRENT_PORT=$new_port
    API_URL="http://127.0.0.1:$CURRENT_PORT"
    echo -e "${GREEN}Termin√©.${NC}"
    pause
}

# --- MENUS SYST√àME ---

menu_daemon_modern() {
    while true; do
        clear
        ST=$(systemctl is-active "$SERVICE_NAME")
        if [ "$ST" == "active" ]; then
            C="${GREEN}ACTIF${NC}"
        else
            C="${RED}INACTIF${NC}"
        fi

        API_ST=$(get_api_status_indicator)
        echo -e "${BLUE}=== ‚öôÔ∏è  DAEMON ===${NC}"
        echo -e "  √âtat : $C | API : $API_ST | Port : $CURRENT_PORT"
        echo "------------------------------------------------"
        echo -e "  1. ‚ö° Changer Port (Wizard) | 2. Restart | 3. Stop | 4. Start | r. Retour"
        read -r -p "> " c

        case "$c" in
            1) workflow_change_port ;;
            2) if ask_sudo_gui; then run_sudo systemctl restart "$SERVICE_NAME"; echo "OK"; pause; fi ;;
            3) if ask_sudo_gui; then run_sudo systemctl stop "$SERVICE_NAME"; echo "OK"; pause; fi ;;
            4) if ask_sudo_gui; then run_sudo systemctl start "$SERVICE_NAME"; echo "OK"; pause; fi ;;
            r) return ;;
        esac
    done
}

firewall_checkbox_delete() {
    mapfile -t RULES < <(run_sudo ufw status numbered | grep "^\[")
    if [ ${#RULES[@]} -eq 0 ]; then echo "Aucune r√®gle."; pause; return; fi

    declare -a SEL; for i in "${!RULES[@]}"; do SEL[$i]=false; done

    while true; do
        clear
        echo -e "${RED}${BOLD}SUPPRESSION R√àGLES (Cochez pour supprimer)${NC}"
        for i in "${!RULES[@]}"; do
            NUM=$(echo "${RULES[$i]}" | sed -E 's/^\[([ 0-9]+)\].*/\1/' | xargs)
            DESC=$(echo "${RULES[$i]}" | sed -E 's/^\[[ 0-9]+\] //')
            if [ "${SEL[$i]}" == "true" ]; then M="${RED}[X]${NC}"; else M="${GREEN}[ ]${NC}"; fi
            printf " %b | %2s | %s\n" "$M" "$NUM" "$DESC"
        done
        echo "------------------------------------------------"
        echo -e "  [Num] Basculer | [a] Tout | [n] Rien"
        echo -e "  [v]   VALIDER | [r] Retour"
        read -r -p "> " k

        if [[ "$k" =~ ^[0-9]+$ ]]; then
            for i in "${!RULES[@]}"; do
                rn=$(echo "${RULES[$i]}" | sed -E 's/^\[([ 0-9]+)\].*/\1/' | xargs)
                if [ "$rn" == "$k" ]; then
                    if [ "${SEL[$i]}" == "true" ]; then SEL[$i]=false; else SEL[$i]=true; fi
                fi
            done
        elif [ "$k" == "v" ]; then
            declare -a DELS
            for i in "${!RULES[@]}"; do
                if [ "${SEL[$i]}" == "true" ]; then
                    rn=$(echo "${RULES[$i]}" | sed -E 's/^\[([ 0-9]+)\].*/\1/' | xargs)
                    DELS+=("$rn")
                fi
            done
            if [ ${#DELS[@]} -gt 0 ]; then
                if ask_sudo_gui; then
                    SORTED=$(printf "%s\n" "${DELS[@]}" | sort -nr)
                    for n in $SORTED; do echo "Suppression r√®gle #$n..."; yes | sudo ufw delete "$n" >/dev/null; done
                    echo -e "${GREEN}Termin√©.${NC}"; pause; break
                fi
            else echo "Aucune s√©lection."; pause; fi
        elif [ "$k" == "r" ]; then break
        elif [ "$k" == "a" ]; then for i in "${!RULES[@]}"; do SEL[$i]=true; done
        elif [ "$k" == "n" ]; then for i in "${!RULES[@]}"; do SEL[$i]=false; done
        fi
    done
}

firewall_manager() {
    while true; do
        clear
        if run_sudo_silent ufw status | grep -q "active"; then ST="${GREEN}ACTIF${NC}"; else ST="${RED}INACTIF${NC}"; fi
        echo -e "${BLUE}=== GESTION PARE-FEU ($ST) ===${NC}"

        mapfile -t RULES < <(run_sudo ufw status numbered | grep "^\[")
        if [ ${#RULES[@]} -eq 0 ]; then echo "   (Aucune r√®gle)"; else
            for line in "${RULES[@]}"; do
                echo "$line" | sed "s/ALLOW/${GREEN}ALLOW${NC}/" | sed "s/DENY/${RED}DENY${NC}/"
            done
        fi

        echo "------------------------------------------------"
        echo -e "  ${GREEN}1.${NC} üîë Ouvrir SSH (22)"
        echo -e "  ${GREEN}2.${NC} üîå Ouvrir Port Zoraxy ($CURRENT_PORT)"
        echo -e "  ${GREEN}3.${NC} ‚ûï Ouvrir Port Manuel"
        echo -e "  ${GREEN}4.${NC} ‚ö° Activer UFW (Enable)"
        echo -e "  ${RED}5.${NC} üóëÔ∏è  Supprimer des r√®gles (S√©lection)"
        echo -e "  ${RED}6.${NC} üõë D√©sactiver UFW (Disable)"
        echo "------------------------------------------------"
        echo -e "  ${RED}0.${NC} üîô Retour au menu principal"
        read -r -p "Choix > " c

        case "$c" in
            1) if ask_sudo_gui; then run_sudo ufw allow 22/tcp; echo "OK"; pause; fi ;;
            2) if ask_sudo_gui; then run_sudo ufw allow "$CURRENT_PORT"/tcp; echo "OK"; pause; fi ;;
            3) read -p "Port : " p; [ -n "$p" ] && if ask_sudo_gui; then run_sudo ufw allow "$p"; pause; fi ;;
            4) if ask_sudo_gui; then run_sudo ufw enable; pause; fi ;;
            5) firewall_checkbox_delete ;;
            6) if ask_sudo_gui; then run_sudo ufw disable; pause; fi ;;
            0) return ;;
        esac
    done
}

menu_backup() {
    if [ ! -d "$BACKUP_DIR" ]; then run_sudo mkdir -p "$BACKUP_DIR"; fi

    while true; do
        clear
        echo -e "${BLUE}=== BACKUP ===${NC}"
        ls -lh "$BACKUP_DIR" | grep "tar.gz"
        echo "1. Cr√©er | 2. Supprimer | r. Retour"
        read -r -p "> " c

        case "$c" in
            1)
                if ask_sudo_gui; then
                    T=$(date +%Y%m%d_%H%M)
                    sudo bash -c "cd $ZORAXY_HOME && tar --exclude='zoraxy' --exclude='*.tar.gz' -czf '$BACKUP_DIR/bkp_$T.tar.gz' ."
                    echo "OK"
                    pause
                fi
                ;;
            2)
                read -p "Fichier: " f
                if [ -f "$BACKUP_DIR/$f" ] && ask_sudo_gui; then
                    sudo rm "$BACKUP_DIR/$f"
                    echo "Del"
                    pause
                fi
                ;;
            r) return ;;
        esac
    done
}

menu_update_center() {
    while true; do
        clear
        echo -e "${BLUE}=== UPDATE ===${NC}"
        L=$(get_local_version)
        R=$(get_remote_version_managed)
        echo "Local: $L | Remote: $R"
        echo "1. Update Zoraxy | 2. System Update | r. Retour"
        read -r -p "> " c

        case "$c" in
            1)
                if ask_sudo_gui; then
                    wget -q --show-progress -O /tmp/z_new "https://github.com/$GITHUB_REPO/releases/download/$R/zoraxy_linux_amd64" && \
                    run_sudo systemctl stop $SERVICE_NAME && \
                    run_sudo mv $ZORAXY_HOME/zoraxy $ZORAXY_HOME/zoraxy.old && \
                    run_sudo mv /tmp/z_new $ZORAXY_HOME/zoraxy && \
                    run_sudo chmod +x $ZORAXY_HOME/zoraxy && \
                    echo "$R" | run_sudo tee "$VERSION_FILE" && \
                    run_sudo systemctl start $SERVICE_NAME && \
                    echo "OK"
                    pause
                fi
                ;;
            2)
                if ask_sudo_gui; then
                    sudo apt update && sudo apt upgrade -y
                    pause
                fi
                ;;
            r) return ;;
        esac
    done
}

open_user_shell() {
    if ! ask_sudo_gui; then return; fi
    echo -e "\n${GREEN}üîì Acc√®s autoris√©.${NC}"
    trap - SIGINT SIGQUIT SIGTSTP
    export SKIP_KIOSK=1
    cd "$ZORAXY_HOME" || cd "$HOME"
    bash --login
    unset SKIP_KIOSK
    trap '' SIGINT SIGQUIT SIGTSTP
}

spawn_restricted_shell() {
    local TD="$1"
    local SN="$2"
    [ ! -d "$TD" ] && run_sudo mkdir -p "$TD"

    echo -e "\n${GREEN}üîí JAIL $SN${NC}"
    local OH="$HOME"

    bash --rcfile <(echo "export HOME='$TD'; export PS1='(Restreint:$SN) \[\033[01;34m\]\w\[\033[00m\]\\$ '; check_path() { if [[ \"\$PWD\" != \"$TD\"* ]]; then echo -e \"\n${RED}‚õî Interdit.${NC}\"; cd \"$TD\"; fi; }; alias cd='check_path; cd'; export PROMPT_COMMAND='check_path'; export PATH='/usr/local/bin:/usr/bin:/bin'")

    export HOME="$OH"
    trap '' SIGINT SIGQUIT SIGTSTP
}

# --- 4. BOUCLE PRINCIPALE ---
SEP="${BLUE}------------------------------------------------${NC}"
SEP_RED="${RED}------------------------------------------------${NC}"

while true; do
    clear
    check_requirements
    get_sys_info

    # √âtat des services
    ST=$(systemctl is-active --quiet "$SERVICE_NAME" && echo "${GREEN}‚óè ON${NC}" || echo "${RED}‚óè OFF${NC}")
    if run_sudo_silent $CMD_UFW status 2>/dev/null | grep -q "Status: active"; then
        FW_ST="${GREEN}‚óè ACTIF${NC}"
    else
        FW_ST="${RED}‚óè INACTIF${NC}"
    fi

    # --- EN-T√äTE AVEC CADRE BLEU ---
    echo -e "${BLUE}################################################${NC}"
    echo -e "${BLUE}#          ZORAXY MANAGER - DASHBOARD          #${NC}"
    echo -e "${BLUE}################################################${NC}"

    # --- INFOS SYST√àME ---
    printf "  üñ•Ô∏è  %-21s | ‚è±Ô∏è  %s\n" "${CYAN}$OS_NAME${NC}" "${GREY}$SYS_UPTIME${NC}"
    printf "  üß† CPU: %-15s | üíæ RAM: %s\n" "${YELLOW}$CPU_USAGE${NC}" "${YELLOW}$RAM_USAGE${NC}"
    printf "  üè† LAN: %-15s | üåç WAN: %s\n" "${YELLOW}$LOCAL_IP${NC}" "${YELLOW}$PUBLIC_IP${NC}"

    echo -e "$SEP"

    # --- INFO SERVICE ---
    printf "  üîå Service : %-12b | üõ°Ô∏è  Pare-feu : %s\n" "$ST" "$FW_ST"
    printf "  ‚ÑπÔ∏è  Version : %-12s | ‚öì Port     : %s\n" "${CYAN}$APP_VER${NC}" "${YELLOW}$CURRENT_PORT${NC}"

    echo -e "$SEP"

    # --- MENU : SECTION SERVICE ---
    echo -e " ${BOLD}${CYAN}‚ö° GESTION DU SERVICE${NC}"
    echo -e "    ${GREEN}1.${NC} üìú Voir les Logs (Live)"
    echo -e "    ${GREEN}2.${NC} ‚öôÔ∏è  Gestion du Daemon (Start/Stop)"
    echo ""

    # --- MENU : SECTION PROXY ---
    echo -e " ${BOLD}${CYAN}üåê PROXY & R√âSEAU${NC}"
    echo -e "    ${GREEN}3.${NC} üí† Gestion VHosts (Menu Principal)"
    echo -e "    ${GREEN}4.${NC} üß± Pare-Feu (UFW)"
    echo -e "    ${GREEN}5.${NC} üì¶ Sauvegardes"
    echo -e "    ${GREEN}6.${NC} üöÄ Mises √† jour (App & Syst√®me)"
    echo -e "    ${GREEN}7.${NC} üîí Shell Restreint (Jail)"

    echo -e "$SEP_RED"

    # --- MENU : SECTION SYST√àME (Danger) ---
    echo -e " ${BOLD}${RED}üíÄ ZONES SYST√àME${NC}"
    echo -e "    ${RED}8.${NC} üîå √âteindre le serveur"
    echo -e "    ${RED}9.${NC} ‚ôªÔ∏è  Red√©marrer le serveur"

    echo -e "$SEP"

    # --- PIED DE PAGE ---
    echo -e "  [${YELLOW}admin${NC}] üíª Console Admin   |   [${RED}exit${NC}] üö™ Quitter"
    echo -e "$SEP"

    read -r -p "  Votre choix > " ch

    case "$ch" in
        1)
           trap - SIGINT
           echo -e "\n${CYAN}--- LOGS (Ctrl+C pour quitter) ---${NC}"
           run_sudo journalctl -u "$SERVICE_NAME" -f -n 50
           trap '' SIGINT
           ;;
        2) menu_daemon_modern ;;
        3) manage_zoraxy_menu ;;
        4) firewall_manager ;;
        5) menu_backup ;;
        6) menu_update_center ;;
        7) spawn_restricted_shell "$ZORAXY_HOME" "Config" ;;
        8) server_power_action "√âTEINDRE" "poweroff" ;;
        9) server_power_action "RED√âMARRER" "reboot" ;;
        admin) open_user_shell ;;
        exit|q) kill -9 $PPID 2>/dev/null; exit 0 ;;
        *) echo "Choix invalide"; sleep 0.5 ;;
    esac
done
