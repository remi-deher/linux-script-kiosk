#!/bin/bash
# ============================
#  MANAGER BASE DE DONN√âES
# ============================

# --- CONFIGURATION ---
SERVICE_NAME="mariadb"
MARIADB_HOME="/etc/mysql"
BACKUP_DIR="/var/backups/mariadb-manager"
LOG_ERROR="/var/log/mysql/error.log"
CMD_UFW="/usr/sbin/ufw"

DB_ROOT_USER="root"

# --- CONFIGURATION SYST√àME ---
DIR_WEB="/var/www"
DIR_NGINX="/etc/nginx"
DIR_PHP="/etc/php"
PUBLIC_IP_CACHE="/tmp/mariadb_public_ip"
LOCAL_IP=""
PUBLIC_IP=""

# --- S√âCURIT√â & COULEURS ---
trap '' SIGINT SIGQUIT SIGTSTP

BLUE=$'\033[0;34m'
GREEN=$'\033[0;32m'
RED=$'\033[0;31m'
YELLOW=$'\033[1;33m'
CYAN=$'\033[0;36m'
GREY=$'\033[1;30m'
NC=$'\033[0m'
BOLD=$'\033[1m'

# --- 1. FONCTIONS SYST√àME DE BASE ---

ask_sudo_gui() {
    if sudo -n true 2>/dev/null; then
        return 0
    fi

    echo -e "\n${YELLOW}üîí Authentification requise (Mot de passe Sudo)${NC}"
    read -s -p "Mot de passe : " user_pass
    echo ""

    echo "$user_pass" | sudo -S -v 2>/dev/null
    if [ $? -eq 0 ]; then
        return 0
    else
        echo -e "${RED}‚ùå Mot de passe incorrect.${NC}"
        pause
        return 1
    fi
}

run_sudo() {
    if sudo -n "$@" 2>/dev/null; then
        return 0
    fi

    if sudo -n true 2>/dev/null; then
        sudo "$@"
        return $?
    fi

    if ! ask_sudo_gui; then return 1; fi
    sudo "$@"
}

run_sudo_silent() {
    if sudo -n "$@" 2>/dev/null; then
        return 0
    fi
    return 1
}

pause() {
    echo ""
    read -p "Appuyez sur Entr√©e pour continuer..."
}

ensure_installed() {
    local cmd="$1"
    local pkg="$2"

    if ! command -v "$cmd" &> /dev/null; then
        echo -e "\n${YELLOW}‚ö†Ô∏è  Outil requis manquant : '$cmd'${NC}"
        read -p "Installer '$pkg' maintenant ? (o/n) " i
        if [[ "$i" == "o" ]]; then
            if ask_sudo_gui; then
                echo -e "${CYAN}Installation de $pkg...${NC}"
                run_sudo apt-get update -qq
                if run_sudo apt-get install -y "$pkg"; then
                    echo -e "${GREEN}‚úÖ Install√©.${NC}"
                    return 0
                else
                    echo -e "${RED}‚ùå √âchec.${NC}"
                    return 1
                fi
            fi
        else
            echo -e "${RED}‚ùå Annul√©.${NC}"
            return 1
        fi
    fi
    return 0
}

server_power_action() {
    echo -e "\n${RED}${BOLD}‚ö†Ô∏è  ATTENTION : $1 LE SYST√àME${NC}"
    read -p "Tapez 'confirmer' pour ex√©cuter : " i
    if [ "$i" == "confirmer" ]; then
        run_sudo $2
        exit 0
    else
        echo "Annul√©."
        pause
    fi
}

get_remote_ip_managed() {
    if [ -f "$PUBLIC_IP_CACHE" ]; then
        LAST_MOD=$(stat -c %Y "$PUBLIC_IP_CACHE")
        NOW=$(date +%s)
        DIFF=$((NOW - LAST_MOD))
        if [ $DIFF -lt 3600 ]; then
            cat "$PUBLIC_IP_CACHE"
            return
        fi
    fi
    local PUB_IP=$(curl -s -4 -m 3 https://icanhazip.com 2>/dev/null)
    if [[ "$PUB_IP" =~ ^[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}$ ]]; then
        echo "$PUB_IP" | tee "$PUBLIC_IP_CACHE"
    else
        [ -f "$PUBLIC_IP_CACHE" ] && cat "$PUBLIC_IP_CACHE" || echo "N/A"
    fi
}

get_sys_info() {
    LOCAL_IP=$(hostname -I | awk '{print $1}')
    PUBLIC_IP=$(get_remote_ip_managed)

    OS_NAME=$(grep -oP 'PRETTY_NAME="\K[^"]+' /etc/os-release 2>/dev/null | cut -c1-20)
    [ -z "$OS_NAME" ] && OS_NAME="Linux"

    CPU_USAGE=$(top -bn1 | grep "Cpu(s)" | sed "s/.*, *\([0-9.]*\)%* id.*/\1/" | awk '{print 100 - $1"%"}' 2>/dev/null)
    [ -z "$CPU_USAGE" ] && CPU_USAGE="N/A"

    RAM_USAGE=$(free -h | awk '/^Mem:/ {print $3 "/" $2}')
    SYS_UPTIME=$(uptime -p | sed 's/up //;s/ hours/h/;s/ minutes/m/')
}

open_user_shell() {
    if ! ask_sudo_gui; then return; fi
    echo -e "\n${GREEN}üîì Acc√®s autoris√©.${NC} Tapez 'exit' pour revenir."
    trap - SIGINT SIGQUIT SIGTSTP
    export SKIP_KIOSK=1
    cd "MARIADB_HOME" || cd "$HOME"
    bash --login
    unset SKIP_KIOSK


    trap '' SIGINT SIGQUIT SIGTSTP
}

# --- 2. CENTRE DE MISE √Ä JOUR ---

menu_system_update() {
    while true; do
        clear
        echo -e "${BLUE}#############################################${NC}"
        echo -e "${BLUE}#           CENTRE DE MISE √Ä JOUR           #${NC}"
        echo -e "${BLUE}#############################################${NC}"
        echo ""
        echo -e "${BOLD}SYST√àME D'EXPLOITATION (OS) :${NC}"
        echo -e "  ${CYAN}1.${NC} üîÑ Mise √† jour paquets (apt update/upgrade)"
        echo -e "  ${CYAN}2.${NC} üßπ Nettoyage (autoremove & clean)"
        echo -e "  ${CYAN}3.${NC} üÜô Mise √† niveau compl√®te (apt dist-upgrade)"
        echo -e "  ${CYAN}4.${NC} üìù √âditer les d√©p√¥ts (sources.list)"
        echo "---------------------------------------------"
        echo -e "  ${RED}0.${NC} üîô Retour"
        echo "---------------------------------------------"
        read -r -p "Choix > " uc

        case "$uc" in
            1)
               if ask_sudo_gui; then
                   echo -e "\n${CYAN}--- APT UPDATE ---${NC}"
                   sudo apt-get update
                   echo -e "\n${CYAN}--- APT UPGRADE ---${NC}"
                   sudo apt-get upgrade -y
                   echo -e "\n${GREEN}Fini.${NC}"
                   pause
               fi
               ;;
            2)
               if ask_sudo_gui; then
                   echo -e "\n${CYAN}--- NETTOYAGE (Autoremove) ---${NC}"
                   sudo apt-get autoremove -y
                   echo -e "\n${CYAN}--- NETTOYAGE (Clean) ---${NC}"
                   sudo apt-get clean
                   echo -e "\n${GREEN}Syst√®me nettoy√©.${NC}"
                   pause
               fi
               ;;
            3)
               if ask_sudo_gui; then
                   echo -e "\n${CYAN}--- DIST-UPGRADE ---${NC}"
                   sudo apt-get dist-upgrade -y
                   echo -e "\n${GREEN}Fini.${NC}"
                   pause
               fi
               ;;
            4)
               if ask_sudo_gui; then run_sudo nano /etc/apt/sources.list; fi
               ;;
            0) return ;;
        esac
    done
}


# --- 3. UFW & RESEAU UNIFI√â (CORRIG√â) ---

firewall_checkbox_delete() {
    # Utilisation explicite de CMD_UFW sans v√©rification pr√©alable bloquante
    mapfile -t RULES < <(run_sudo $CMD_UFW status numbered 2>/dev/null | grep "^\[")
    if [ ${#RULES[@]} -eq 0 ]; then echo "Aucune r√®gle ou UFW inactif."; pause; return; fi

    declare -a SEL; for i in "${!RULES[@]}"; do SEL[$i]=false; done

    while true; do
        clear
        echo -e "${RED}${BOLD}SUPPRESSION R√àGLES (Cochez pour supprimer)${NC}"
        for i in "${!RULES[@]}"; do
            NUM=$(echo "${RULES[$i]}" | sed -E 's/^\[([ 0-9]+)\].*/\1/' | xargs)
            DESC=$(echo "${RULES[$i]}" | sed -E 's/^\[[ 0-9]+\] //')
            if [ "${SEL[$i]}" == "true" ]; then M="${RED}[X]${NC}"; else M="${GREEN}[ ]${NC}"; fi
            printf " %b | %2s | %s\n" "$M" "$NUM" "$DESC"
        done
        echo "------------------------------------------------"
        echo -e "  [Num] Basculer | [a] Tout | [n] Rien"
        echo -e "  [v]   VALIDER | [r] Retour"
        read -r -p "> " k

        if [[ "$k" =~ ^[0-9]+$ ]]; then
            for i in "${!RULES[@]}"; do
                rn=$(echo "${RULES[$i]}" | sed -E 's/^\[([ 0-9]+)\].*/\1/' | xargs)
                if [ "$rn" == "$k" ]; then
                    if [ "${SEL[$i]}" == "true" ]; then SEL[$i]=false; else SEL[$i]=true; fi
                fi
            done
        elif [ "$k" == "v" ]; then
            declare -a DELS
            for i in "${!RULES[@]}"; do
                if [ "${SEL[$i]}" == "true" ]; then
                    rn=$(echo "${RULES[$i]}" | sed -E 's/^\[([ 0-9]+)\].*/\1/' | xargs)
                    DELS+=("$rn")
                fi
            done
            if [ ${#DELS[@]} -gt 0 ]; then
                if ask_sudo_gui; then
                    SORTED=$(printf "%s\n" "${DELS[@]}" | sort -nr)
                    for n in $SORTED; do echo "Suppression r√®gle #$n..."; yes | sudo $CMD_UFW delete "$n" >/dev/null; done
                    echo -e "${GREEN}Termin√©.${NC}"; pause; break
                fi
            else echo "Aucune s√©lection."; pause; fi
        elif [ "$k" == "r" ]; then break
        elif [ "$k" == "a" ]; then for i in "${!RULES[@]}"; do SEL[$i]=true; done
        elif [ "$k" == "n" ]; then for i in "${!RULES[@]}"; do SEL[$i]=false; done
        fi
    done
}

firewall_manager() {
    # Suppression du ensure_installed bloquant pour s'aligner sur zoraxy-manager
    while true; do
        clear
        if run_sudo_silent $CMD_UFW status 2>/dev/null | grep -q "active"; then ST="${GREEN}ACTIF${NC}"; else ST="${RED}INACTIF${NC}"; fi
        echo -e "${BLUE}=== GESTION PARE-FEU ($ST) ===${NC}"

        mapfile -t RULES < <(run_sudo $CMD_UFW status numbered 2>/dev/null | grep "^\[")
        if [ ${#RULES[@]} -eq 0 ]; then echo "   (Aucune r√®gle)"; else
            for line in "${RULES[@]}"; do
                echo "$line" | sed "s/ALLOW/${GREEN}ALLOW${NC}/" | sed "s/DENY/${RED}DENY${NC}/"
            done
        fi

        echo "------------------------------------------------"
        echo -e "  ${GREEN}1.${NC} üîë Ouvrir SSH (22)"
        echo -e "  ${GREEN}2.${NC} üóÉÔ∏è  Ouvrir MariaDB (${DB_PORT}/tcp)"
        echo -e "  ${GREEN}3.${NC} ‚ûï Ouvrir Port Manuel"
        echo -e "  ${GREEN}4.${NC} ‚ö° Activer UFW (Enable)"
        echo -e "  ${RED}5.${NC} üóëÔ∏è  Supprimer des r√®gles (S√©lection)"
        echo -e "  ${RED}6.${NC} üõë D√©sactiver UFW (Disable)"
        echo "------------------------------------------------"
        echo -e "  ${RED}0.${NC} üîô Retour au menu principal"
        read -r -p "Choix > " c

        case "$c" in
            1) if ask_sudo_gui; then run_sudo $CMD_UFW allow 22/tcp; echo "OK"; pause; fi ;;
            2) if ask_sudo_gui; then run_sudo $CMD_UFW allow "$DB_PORT"/tcp; echo "OK"; pause; fi ;;
            3) read -p "Port : " p; [ -n "$p" ] && if ask_sudo_gui; then run_sudo $CMD_UFW allow "$p"; pause; fi ;;
            4) if ask_sudo_gui; then run_sudo $CMD_UFW enable; pause; fi ;;
            5) firewall_checkbox_delete ;;
            6) if ask_sudo_gui; then run_sudo $CMD_UFW disable; pause; fi ;;
            0) return ;;
        esac
    done
}

# --- 4. FONCTIONS SP√âCIFIQUES MARIA DB ---

check_mariadb_installed() {
    if ! command -v mysql &> /dev/null; then
        echo -e "${RED}‚ùå MariaDB n'est pas install√©. Veuillez l'installer d'abord.${NC}"
        pause
        return 1
    fi
    return 0
}

run_db_command() {
    local cmd="$1"
    if run_sudo mysql -u $DB_ROOT_USER -e "$cmd" 2>/dev/null; then
        return 0
    else
        return 1
    fi
}

get_db_info() {
    DB_STATUS="${RED}‚óè OFF${NC}"
    DB_VERSION="N/A"
    DB_UPTIME="N/A"
    DB_PORT="üîí"

    if systemctl is-active --quiet $SERVICE_NAME; then
        DB_STATUS="${GREEN}‚óè ON${NC}"

        if check_mariadb_installed; then
            local INFOS=$(run_db_command "(SELECT VARIABLE_VALUE, 1 AS ord FROM information_schema.global_variables WHERE VARIABLE_NAME = 'version')
                                         UNION ALL
                                         (SELECT VARIABLE_VALUE, 2 AS ord FROM information_schema.global_variables WHERE VARIABLE_NAME = 'port')
                                         UNION ALL
                                         (SELECT VARIABLE_VALUE, 3 AS ord FROM information_schema.global_status WHERE VARIABLE_NAME = 'Uptime')
                                         ORDER BY ord;" 2>/dev/null)

            if [ $? -eq 0 ] && [ -n "$INFOS" ]; then
                DB_VERSION=$(echo "$INFOS" | tail -n +2 | awk 'NR==1{print $1}')
                DB_PORT=$(echo "$INFOS" | tail -n +2 | awk 'NR==2{print $1}')
                DB_UPTIME_RAW=$(echo "$INFOS" | tail -n +2 | awk 'NR==3{print $1}')

                if [[ "$DB_UPTIME_RAW" =~ ^[0-9]+$ ]]; then
                    local D=$((DB_UPTIME_RAW/86400))
                    local H=$((DB_UPTIME_RAW%86400/3600))
                    local M=$((DB_UPTIME_RAW%3600/60))
                    DB_UPTIME="${D}j ${H}h ${M}m"
                else
                    DB_UPTIME="N/A"
                fi
            fi
        fi
    fi
}

# --- 5. GESTION DU SERVICE ---

menu_service_management() {
    while true; do
        clear
        get_db_info
        echo -e "${BLUE}=== GESTION DU SERVICE $SERVICE_NAME ===${NC}"
        echo -e "  Statut : $DB_STATUS | Version : ${YELLOW}$DB_VERSION${NC} | Port : ${YELLOW}$DB_PORT${NC}"
        echo -e "  Uptime : ${CYAN}$DB_UPTIME${NC}"
        echo "-------------------------------------"
        echo -e "  ${GREEN}1.${NC} üîÑ Red√©marrer"
        echo -e "  ${GREEN}2.${NC} üü¢ D√©marrer"
        echo -e "  ${RED}3.${NC} üõë Arr√™ter"
        echo -e "  ${YELLOW}4.${NC} üõ°Ô∏è  Lancer ${BOLD}mysql_secure_installation${NC}"
        echo -e "  ${YELLOW}5.${NC} ‚öôÔ∏è  √âditer config principale (50-server.cnf)"
        echo "-------------------------------------"
        echo -e "  ${RED}r.${NC} Retour"
        read -r -p "> " c

        case "$c" in
            1) if ask_sudo_gui; then run_sudo systemctl restart $SERVICE_NAME && echo -e "${GREEN}Red√©marrage OK.${NC}"; pause; fi ;;
            2) if ask_sudo_gui; then run_sudo systemctl start $SERVICE_NAME && echo -e "${GREEN}D√©marrage OK.${NC}"; pause; fi ;;
            3) if ask_sudo_gui; then run_sudo systemctl stop $SERVICE_NAME && echo -e "${RED}Arr√™t√©.${NC}"; pause; fi ;;
            4) if ask_sudo_gui; then run_sudo mysql_secure_installation; pause; fi ;;
            5) if ask_sudo_gui; then run_sudo nano $MARIADB_HOME/mariadb.conf.d/50-server.cnf; fi ;;
            r) return ;;
        esac
    done
}

# --- 6. GESTION DES BASES DE DONN√âES (CRUD) ---

list_databases() {
    run_db_command "SHOW DATABASES" | grep -E -v 'Database|information_schema|mysql|performance_schema|sys'
}

manage_databases() {
    if ! check_mariadb_installed || ! systemctl is-active --quiet $SERVICE_NAME; then return; fi
    while true; do
        clear
        echo -e "${BLUE}--- GESTION DES BASES DE DONN√âES ---${NC}"
        echo -e "${BOLD}Bases existantes :${NC}"
        mapfile -t DBS < <(list_databases)
        i=1
        if [ ${#DBS[@]} -eq 0 ]; then
            echo "  (Aucune DB utilisateur)"
        else
            for db in "${DBS[@]}"; do
                printf "  ${CYAN}%-2d.${NC} %s\n" "$i" "$db"
                ((i++))
            done
        fi
        echo "----------------------------------------"
        echo -e "  ${GREEN}a.${NC} Cr√©er une nouvelle DB"
        echo -e "  ${RED}d.${NC} Supprimer une DB existante"
        echo -e "  ${RED}r.${NC} Retour"
        read -r -p "> " c

        case "$c" in
            a)
                read -p "Nom de la nouvelle DB : " new_db
                [[ -z "$new_db" ]] && continue
                if ask_sudo_gui; then
                    if run_db_command "CREATE DATABASE IF NOT EXISTS \`$new_db\` CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;"; then
                        echo -e "${GREEN}‚úÖ Base de donn√©es '$new_db' cr√©√©e.${NC}"
                    else
                        echo -e "${RED}‚ùå √âchec de la cr√©ation.${NC}"
                    fi
                    pause
                fi
                ;;
            d)
                read -p "Num√©ro de la DB √† supprimer : " sel
                if [[ "$sel" =~ ^[0-9]+$ ]] && [ "$sel" -ge 1 ] && [ "$sel" -le ${#DBS[@]} ]; then
                    db_to_del="${DBS[$((sel-1))]}"
                    echo -e "${RED}‚ö†Ô∏è  SUPPRESSION DE LA DB : $db_to_del${NC}"
                    read -p "Confirmer la suppression (taper '${BOLD}OUI${NC}') : " confirm
                    if [[ "$confirm" == "OUI" ]]; then
                        if ask_sudo_gui; then
                            if run_db_command "DROP DATABASE \`$db_to_del\`;"; then
                                echo -e "${GREEN}‚úÖ Base de donn√©es '$db_to_del' supprim√©e.${NC}"
                            else
                                echo -e "${RED}‚ùå √âchec de la suppression.${NC}"
                            fi
                        fi
                    else
                         echo "Annul√©."
                    fi
                    pause
                fi
                ;;
            r) return ;;
        esac
    done
}

# --- 7. SAUVEGARDE & RESTAURATION ---

multi_select_db_backup() {
    if ! check_mariadb_installed || ! systemctl is-active --quiet $SERVICE_NAME; then return; fi

    run_sudo mkdir -p "$BACKUP_DIR"
    mapfile -t DBS < <(list_databases)
    [ ${#DBS[@]} -eq 0 ] && { echo "Aucune base de donn√©es √† sauvegarder."; pause; return; }

    declare -A S
    for i in "${!DBS[@]}"; do S[$i]=0; done

    while true; do
        clear
        echo -e "${BLUE}BACKUP : S√âLECTION BASES DE DONN√âES${NC}"
        C=0
        for i in "${!DBS[@]}"; do
            [ "${S[$i]}" -eq 1 ] && M="${GREEN}[x]${NC}" || M="${RED}[ ]${NC}"
            printf "  %s %2d. %s\n" "$M" $((i+1)) "${DBS[$i]}"
            ((C++))
        done
        echo "----------------------------------------"
        echo -e "  G. Go | T. Tout | N. Rien | r. Retour"
        read -r -p "> " c

        [[ "$c" == "r" ]] && break
        [[ "$c" =~ [Tt] ]] && { for i in "${!DBS[@]}"; do S[$i]=1; done; continue; }
        [[ "$c" =~ [Nn] ]] && { for i in "${!DBS[@]}"; do S[$i]=0; done; continue; }

        if [[ "$c" =~ [Gg] ]]; then
            DB_LIST=""
            H=0
            for i in "${!DBS[@]}"; do
                [ "${S[$i]}" -eq 1 ] && { DB_LIST="$DB_LIST ${DBS[$i]}"; H=1; }
            done

            [ $H -eq 0 ] && continue

            if ask_sudo_gui; then
                D=$(date +%Y%m%d_%H%M%S)
                A="$BACKUP_DIR/backup_DBs_$D.sql.gz"
                echo -e "${CYAN}Sauvegarde des DBs s√©lectionn√©es...${NC}"
                run_sudo mysqldump -u $DB_ROOT_USER $DB_LIST | gzip > "$A"
                if [ $? -eq 0 ]; then
                    echo -e "${GREEN}‚úÖ OK: $A${NC}"
                else
                    echo -e "${RED}‚ùå √âchec de la sauvegarde.${NC}"
                fi
            fi
            pause; break
        fi

        [[ "$c" =~ ^[0-9]+$ ]] && [ "$c" -ge 1 ] && [ "$c" -le $C ] && { idx=$((c-1)); [ "${S[$idx]}" -eq 0 ] && S[$idx]=1 || S[$idx]=0; }
    done
}

backup_menu() {
    while true; do
        clear; echo -e "${BLUE}=== üíæ SAUVEGARDES MARIA DB ===${NC}"
        echo -e "  ${GREEN}1.${NC} üåç Sauvegarde Compl√®te (Toutes les DBs)"
        echo -e "  ${GREEN}2.${NC} üìÇ Sauvegarde S√©lective (Choix des DBs)"
        echo -e "  ${GREEN}3.${NC} üìú Voir sauvegardes"
        echo -e "  ${GREEN}4.${NC} ‚ôªÔ∏è  Restaurer une DB (depuis un fichier)"
        echo -e "  ${RED}r.${NC} Retour"
        read -r -p "> " c
        D=$(date +%Y%m%d_%H%M%S)

        if ! check_mariadb_installed; then continue; fi
        if ! systemctl is-active --quiet $SERVICE_NAME; then echo "${RED}Service MariaDB inactif.${NC}"; pause; continue; fi
        if ! ask_sudo_gui; then continue; fi

        case "$c" in
            1)
               echo -e "${CYAN}Sauvegarde compl√®te...${NC}"
               A="$BACKUP_DIR/FULL_DB_BACKUP_$D.sql.gz"
               run_sudo mkdir -p "$BACKUP_DIR"
               run_sudo mysqldump -u $DB_ROOT_USER --all-databases | gzip > "$A"
               if [ $? -eq 0 ]; then echo -e "${GREEN}‚úÖ OK: $A${NC}"; else echo -e "${RED}‚ùå √âchec.${NC}"; fi; pause ;;
            2) multi_select_db_backup ;;
            3) run_sudo mkdir -p "$BACKUP_DIR" 2>/dev/null; ls -lh "$BACKUP_DIR" 2>/dev/null; pause ;;
            4)
               read -e -p "Chemin absolu du fichier SQL/GZ √† restaurer : " file_path
               if [ -f "$file_path" ]; then
                   echo -e "${RED}‚ö†Ô∏è  CETTE OP√âRATION PEUT √âCRASER DES DONN√âES !${NC}"
                   read -p "Confirmer la restauration du fichier ($file_path) (o/n) : " confirm
                   if [[ "$confirm" == "o" ]]; then
                       echo -e "${CYAN}Restauration...${NC}"
                       if [[ "$file_path" == *.gz ]]; then
                           run_sudo zcat "$file_path" | run_sudo mysql -u $DB_ROOT_USER
                       else
                           run_sudo cat "$file_path" | run_sudo mysql -u $DB_ROOT_USER
                       fi
                       if [ $? -eq 0 ]; then echo -e "${GREEN}‚úÖ Restauration termin√©e.${NC}"; else echo -e "${RED}‚ùå Erreur de restauration. V√©rifiez les logs.${NC}"; fi
                   fi
               else
                   echo "${RED}Fichier non trouv√© ou acc√®s refus√©.${NC}"
               fi; pause ;;
            r) break ;;
        esac
    done
}

# --- 8. OUTILS DIVERS ---

spawn_restricted_shell() {
    local T="$1"
    local N="$2"
    [ ! -d "$T" ] && run_sudo mkdir -p "$T"
    cd "$T" || return

    echo -e "\n${GREEN}üîí JAIL $N${NC} (ls, cd, cat, nano, cp, mv, rm, mkdir, pwd)"
    trap 'echo ""' SIGINT
    while true; do
        R="${PWD#$T}"; [ -z "$R" ] && R="/"
        read -e -p "${YELLOW}$N${NC}:[${BLUE}$R${NC}]$ " c a
        [ -z "$c" ] && continue
        if [[ "$a" == /* || "$a" == *" /"* || ("$c" != "cd" && "$a" == *".."*) ]]; then echo "${RED}Interdit${NC}"; continue; fi
        case "$c" in
            cd) [ -z "$a" ] && cd "$T" || { cd "$a" 2>/dev/null; [[ "$PWD" != "$T"* ]] && cd "$T"; } ;;
            ls|ll|la) ls --color=auto -h $a ;;
            cat) [ -f "$a" ] && cat "$a" ;;
            nano) if [ -w "$a" ] || [ ! -e "$a" ] && [ -w . ]; then nano -R "$a"; else run_sudo nano -R "$a"; fi ;;
            mkdir) run_sudo mkdir -p "$a" ;;
            cp) run_sudo cp -r $a ;;
            mv) run_sudo mv $a ;;
            rm) run_sudo rm -rf $a ;;
            pwd) echo "$PWD" ;;
            clear) clear ;;
            exit|quit) break ;;
            *) echo "${RED}?${NC}" ;;
        esac
    done
    trap '' SIGINT SIGQUIT SIGTSTP
}


# --- 9. MAIN LOOP ---
SEP="${BLUE}------------------------------------------------${NC}"
SEP_RED="${RED}------------------------------------------------${NC}"

while true; do
    clear
    get_sys_info
    get_db_info

    if run_sudo_silent $CMD_UFW status 2>/dev/null | grep -q "Status: active"; then
        FW="${GREEN}‚óè ACTIF${NC}"
    else
        FW="${RED}‚óè INACTIF${NC}"
    fi

    # --- EN-T√äTE AVEC CADRE BLEU ---
    echo -e "${BLUE}################################################${NC}"
    echo -e "${BLUE}#           MANAGER BASE DE DONN√âES            #${NC}"
    echo -e "${BLUE}################################################${NC}"

    # --- INFOS SYST√àME ---
    printf "  üñ•Ô∏è  %-21s | ‚è±Ô∏è  %s\n" "${CYAN}$OS_NAME${NC}" "${GREY}$SYS_UPTIME${NC}"
    printf "  üß† CPU: %-15s | üíæ RAM: %s\n" "${YELLOW}$CPU_USAGE${NC}" "${YELLOW}$RAM_USAGE${NC}"
    printf "  üè† LAN: %-15s | üåç WAN: %s\n" "${YELLOW}$LOCAL_IP${NC}" "${YELLOW}$PUBLIC_IP${NC}"

    echo -e "$SEP"

    # --- INFO SERVICE ---
    printf "  üíæ MariaDB : %-16b | üõ°Ô∏è  Pare-feu : %s\n" "$DB_STATUS" "$FW"
    printf "  ‚ÑπÔ∏è  Version : %-16s | ‚öì Port     : %s\n" "${CYAN}$DB_VERSION${NC}" "${YELLOW}$DB_PORT${NC}"

    echo -e "$SEP"

    # --- MENU : SERVICE ---
    echo -e " ${BOLD}${CYAN}‚ö° GESTION DU SERVICE${NC}"
    echo -e "    ${GREEN}1.${NC} ‚öôÔ∏è  Gestion du Service (Start/Stop)"
    echo -e "    ${GREEN}2.${NC} üìú Logs d'Erreur MariaDB"
    echo ""

    # --- MENU : DONN√âES ---
    echo -e " ${BOLD}${CYAN}üóÉÔ∏è  DONN√âES & SAUVEGARDES${NC}"
    echo -e "    ${GREEN}3.${NC} üóÉÔ∏è  Gestion des Bases de Donn√©es (CRUD)"
    echo -e "    ${GREEN}4.${NC} üíæ Sauvegardes & Restauration"
    echo ""

    # --- MENU : OUTILS ---
    echo -e " ${BOLD}${CYAN}üõ†Ô∏è  OUTILS & SYST√àME${NC}"
    echo -e "    ${GREEN}5.${NC} üß± Pare-feu (UFW) & R√©seau"
    echo -e "    ${GREEN}6.${NC} üìÇ Explorateur Fichiers (Jails)"
    echo -e "    ${GREEN}7.${NC} üöÄ Mises √† jour Syst√®me (OS)"

    echo -e "$SEP_RED"

    # --- MENU : SYST√àME (Danger) ---
    echo -e " ${BOLD}${RED}üíÄ ZONES SYST√àME${NC}"
    echo -e "    ${RED}8.${NC} üîå √âteindre le serveur"
    echo -e "    ${RED}9.${NC} ‚ôªÔ∏è  Red√©marrer le serveur"

    echo -e "$SEP"

    # --- PIED DE PAGE ---
    echo -e "  [${YELLOW}admin${NC}] üíª Console Shell   |   [${RED}exit${NC}] üö™ Quitter"
    echo -e "$SEP"

    read -r -p "  Votre choix > " ch

    case "$ch" in
        1) menu_service_management ;;
        2)
           if ask_sudo_gui; then
               echo -e "${CYAN}Affichage des logs... (Ctrl+C pour revenir)${NC}"
               run_sudo tail -f "$LOG_ERROR"
           fi
           trap '' SIGINT SIGQUIT SIGTSTP
           pause
           ;;
        3) manage_databases ;;
        4) backup_menu ;;
        5) firewall_manager ;;
        6)
           echo "1. Config MariaDB | 2. Dossier Backups"
           read -p "> " j
           [ "$j" == "1" ] && spawn_restricted_shell "$MARIADB_HOME" "CONF DB"
           [ "$j" == "2" ] && spawn_restricted_shell "$BACKUP_DIR" "BACKUPS"
           ;;
        7) menu_system_update ;;
        8) server_power_action "√âTEINDRE" "poweroff" ;;
        9) server_power_action "RED√âMARRER" "reboot" ;;
        admin) open_user_shell ;;
        exit|q) kill -9 $PPID 2>/dev/null; exit 0 ;;
        *) echo "Choix invalide"; sleep 1 ;;
    esac
done
