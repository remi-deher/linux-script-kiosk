#!/bin/bash

# =======================================================
#  MANAGER BASE DE DONNÃ‰ES - VERSION FINALE
# =======================================================

# --- CONFIGURATION ---
SERVICE_NAME="mariadb"
DIR_CONF="/etc/mysql"
BACKUP_DIR="/var/backups/mariadb-manager"
LOG_ERROR="/var/log/mysql/error.log"
DB_ROOT_USER="root"
PUBLIC_IP_CACHE="/tmp/mariadb_public_ip"
CMD_MYSQL="/usr/bin/mysql"
CMD_UFW="/usr/sbin/ufw"

# --- SÃ‰CURITÃ‰ & COULEURS ---
trap '' SIGINT SIGQUIT SIGTSTP
BLUE=$'\033[0;34m'; GREEN=$'\033[0;32m'; RED=$'\033[0;31m'; YELLOW=$'\033[1;33m'; CYAN=$'\033[0;36m'; GREY=$'\033[1;30m'; NC=$'\033[0m'; BOLD=$'\033[1m'

# --- 1. GESTION SUDO ---
ask_sudo_gui() {
    if sudo -n true 2>/dev/null; then return 0; fi
    echo -e "\n${YELLOW}ðŸ”’ Authentification requise${NC}"
    read -s -p "Mot de passe : " user_pass; echo ""
    echo "$user_pass" | sudo -S -v 2>/dev/null
    if [ $? -eq 0 ]; then return 0; else echo -e "${RED}âŒ Incorrect.${NC}"; pause; return 1; fi
}
run_sudo() {
    if sudo -n "$@" 2>/dev/null; then return 0; fi
    if sudo -n true 2>/dev/null; then sudo "$@"; return $?; fi
    if ! ask_sudo_gui; then return 1; fi
    sudo "$@"
}
run_sudo_silent() { if sudo -n "$@" 2>/dev/null; then return 0; fi; return 1; }
pause() { echo ""; read -p "EntrÃ©e pour continuer..."; }

server_power_action() {
    local a="$1"; local c="$2"; local cw=$(echo "$a" | tr '[:upper:]' '[:lower:]' | sed 's/Ã©/e/g')
    echo -e "\n${RED}${BOLD}âš ï¸  ATTENTION : $a LE SYSTÃˆME${NC}"; read -p "Tapez '$cw' : " i
    if [ "$i" == "$cw" ]; then run_sudo $c; exit 0; else echo "AnnulÃ©."; pause; fi
}

get_sys_info() {
    LOCAL_IP=$(hostname -I | awk '{print $1}')
    if [ -f "$PUBLIC_IP_CACHE" ] && [ $(( $(date +%s) - $(stat -c %Y "$PUBLIC_IP_CACHE") )) -lt 3600 ]; then PUBLIC_IP=$(cat "$PUBLIC_IP_CACHE"); else
        PUBLIC_IP=$(curl -s -4 -m 3 https://icanhazip.com 2>/dev/null); [[ "$PUBLIC_IP" =~ ^[0-9.]+$ ]] && echo "$PUBLIC_IP" > "$PUBLIC_IP_CACHE" || PUBLIC_IP="N/A"
    fi
    OS_NAME=$(grep -oP 'PRETTY_NAME="\K[^"]+' /etc/os-release 2>/dev/null | cut -c1-20); [ -z "$OS_NAME" ] && OS_NAME="Linux"
    CPU_USAGE=$(top -bn1 | grep "Cpu(s)" | sed "s/.*, *\([0-9.]*\)%* id.*/\1/" | awk '{print 100 - $1"%"}' 2>/dev/null); [ -z "$CPU_USAGE" ] && CPU_USAGE="N/A"
    RAM_USAGE=$(free -h | awk '/^Mem:/ {print $3 "/" $2}')
    SYS_UPTIME=$(uptime -p | sed 's/up //;s/ hours/h/;s/ minutes/m/')
}

# --- 2. GESTION PARE-FEU AMÃ‰LIORÃ‰E (STANDARDISÃ‰E) ---

firewall_manager() {
    while true; do
        clear
        if run_sudo_silent ufw status | grep -q "active"; then ST="${GREEN}ACTIF${NC}"; else ST="${RED}INACTIF${NC}"; fi
        echo -e "${BLUE}=== GESTION PARE-FEU ($ST) ===${NC}"

        mapfile -t RULES < <(run_sudo ufw status numbered | grep "^\[")
        if [ ${#RULES[@]} -eq 0 ]; then echo -e "${GREY}   (Aucune rÃ¨gle)${NC}"; else
            echo "   RÃˆGLES :"
            for line in "${RULES[@]}"; do
                c_line=$(echo "$line" | sed "s/ALLOW/${GREEN}ALLOW${NC}/g" | sed "s/DENY/${RED}DENY${NC}/g")
                echo "   $c_line"
            done
        fi
        echo "------------------------------------------------"
        echo -e "  ${GREEN}1.${NC} âž• Ajouter un port"
        echo -e "  ${GREEN}2.${NC} ðŸ—‘ï¸  Supprimer (Checkbox)"
        echo -e "  ${GREEN}3.${NC} âš¡ Activer"
        echo -e "  ${RED}4.${NC} ðŸ›‘ DÃ©sactiver"
        echo -e "  ${YELLOW}5.${NC} ðŸ—ƒï¸  Ouvrir MariaDB (3306)"
        echo -e "  ${YELLOW}6.${NC} ðŸ”‘ Ouvrir SSH (22)"
        echo "------------------------------------------------"
        echo -e "  ${RED}r.${NC} Retour"
        read -r -p "Choix > " u

        case "$u" in
            1) read -p "Port : " p; [ -n "$p" ] && if ask_sudo_gui; then run_sudo ufw allow "$p"; pause; fi ;;
            2) firewall_checkbox_mode ;;
            3) if ask_sudo_gui; then run_sudo ufw enable; pause; fi ;;
            4) if ask_sudo_gui; then run_sudo ufw disable; pause; fi ;;
            5) if ask_sudo_gui; then run_sudo ufw allow 3306/tcp; echo "OK"; pause; fi ;;
            6) if ask_sudo_gui; then run_sudo ufw allow 22/tcp; echo "OK"; pause; fi ;;
            r) return ;;
        esac
    done
}

firewall_checkbox_mode() {
    mapfile -t RULES < <(run_sudo ufw status numbered | grep "^\[")
    if [ ${#RULES[@]} -eq 0 ]; then echo "Aucune rÃ¨gle."; pause; return; fi
    declare -a SEL; for i in "${!RULES[@]}"; do SEL[$i]=false; done

    while true; do
        clear; echo -e "${RED}${BOLD}MODE SUPPRESSION${NC}"
        printf "%-5s %-6s %-30s\n" "COCHE" "NUM" "RÃˆGLE"
        for i in "${!RULES[@]}"; do
            NUM=$(echo "${RULES[$i]}" | sed -E 's/^\[([ 0-9]+)\].*/\1/' | xargs)
            RAW_DESC=$(echo "${RULES[$i]}" | sed -E 's/^\[[ 0-9]+\] //')
            DESC=$(echo "$RAW_DESC" | sed "s/ALLOW/${GREEN}ALLOW${NC}/g" | sed "s/DENY/${RED}DENY${NC}/g")
            if [ "${SEL[$i]}" == "true" ]; then M="${RED}[X]${NC}"; else M="${GREY}[ ]${NC}"; fi
            printf " %b   %-6s %b\n" "$M" "#$NUM" "$DESC"
        done
        echo "------------------------------------------------"
        echo -e "  ${CYAN}[Num]${NC} Coche/DÃ©coche | ${RED}[v]${NC} VALIDER | ${GREEN}[r]${NC} Retour"
        read -r -p "> " k

        if [[ "$k" =~ ^[0-9]+$ ]] && [ "$k" -ge 1 ] && [ "$k" -le "${#RULES[@]}" ]; then
            idx=$((k-1)); [ "${SEL[$idx]}" == "true" ] && SEL[$idx]=false || SEL[$idx]=true
        elif [ "$k" == "v" ]; then
            if ask_sudo_gui; then
                declare -a DELS; for i in "${!RULES[@]}"; do [ "${SEL[$i]}" == "true" ] && DELS+=("$(echo "${RULES[$i]}" | sed -E 's/^\[([ 0-9]+)\].*/\1/' | xargs)"); done
                SORTED=$(printf "%s\n" "${DELS[@]}" | sort -nr)
                for n in $SORTED; do yes | sudo ufw delete "$n" >/dev/null; done
                echo -e "${GREEN}TerminÃ©.${NC}"; pause; break
            fi
        elif [ "$k" == "r" ]; then break; fi
    done
}

# --- 3. FONCTIONS DB MÃ‰TIER ---

check_mariadb_installed() { if ! command -v mysql &> /dev/null; then return 1; fi; return 0; }
run_db_command() { if run_sudo $CMD_MYSQL -u $DB_ROOT_USER -e "$1" 2>/dev/null; then return 0; else return 1; fi; }

get_db_info() {
    DB_STATUS="${RED}â— OFF${NC}"; DB_VERSION="N/A"; DB_PORT="ðŸ”’"
    if systemctl is-active --quiet $SERVICE_NAME; then
        DB_STATUS="${GREEN}â— ACTIF${NC}"
        if check_mariadb_installed; then
            local Q="(SELECT VARIABLE_VALUE FROM information_schema.global_variables WHERE VARIABLE_NAME = 'version') UNION ALL (SELECT VARIABLE_VALUE FROM information_schema.global_variables WHERE VARIABLE_NAME = 'port')"
            local INFOS=$(run_sudo_silent $CMD_MYSQL -u $DB_ROOT_USER -e "$Q" 2>/dev/null)
            if [ $? -eq 0 ] && [ -n "$INFOS" ]; then
                DB_VERSION=$(echo "$INFOS" | tail -n +2 | awk 'NR==1{print $1}')
                DB_PORT=$(echo "$INFOS" | tail -n +2 | awk 'NR==2{print $1}')
            fi
        fi
    fi
}

menu_service_management() {
    while true; do
        clear; get_db_info
        echo -e "${BLUE}=== SERVICE ===${NC}"; echo -e "Statut : $DB_STATUS | Ver : $DB_VERSION | Port : $DB_PORT"
        echo -e "1. Restart | 2. Start | 3. Stop | 4. Secure Install | 5. Config (50-server.cnf) | r. Retour"
        read -r -p "> " c
        case "$c" in
            1) if ask_sudo_gui; then run_sudo systemctl restart $SERVICE_NAME && echo "OK"; pause; fi ;;
            2) if ask_sudo_gui; then run_sudo systemctl start $SERVICE_NAME && echo "OK"; pause; fi ;;
            3) if ask_sudo_gui; then run_sudo systemctl stop $SERVICE_NAME && echo "ArrÃªtÃ©"; pause; fi ;;
            4) if ask_sudo_gui; then run_sudo mysql_secure_installation; pause; fi ;;
            5) if ask_sudo_gui; then run_sudo nano $DIR_CONF/mariadb.conf.d/50-server.cnf; fi ;;
            r) return ;;
        esac
    done
}

list_databases() {
    run_db_command "SHOW DATABASES" | grep -E -v 'Database|information_schema|mysql|performance_schema|sys'
}

manage_databases() {
    if ! check_mariadb_installed || ! systemctl is-active --quiet $SERVICE_NAME; then return; fi
    while true; do
        clear; echo -e "${BLUE}=== BASES DE DONNÃ‰ES ===${NC}"; mapfile -t DBS < <(list_databases); i=1
        if [ ${#DBS[@]} -eq 0 ]; then echo "  (Aucune DB)"; else for db in "${DBS[@]}"; do printf "  ${CYAN}%-2d.${NC} %s\n" "$i" "$db"; ((i++)); done; fi
        echo "  a. CrÃ©er | d. Supprimer | r. Retour"; read -r -p "> " c
        case "$c" in
            a) read -p "Nom : " new_db; [[ -z "$new_db" ]] && continue
               if ask_sudo_gui; then if run_db_command "CREATE DATABASE IF NOT EXISTS \`$new_db\` CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;"; then echo "${GREEN}OK${NC}"; else echo "${RED}Erreur${NC}"; fi; pause; fi ;;
            d) read -p "NumÃ©ro : " sel; if [[ "$sel" =~ ^[0-9]+$ ]] && [ "$sel" -ge 1 ] && [ "$sel" -le ${#DBS[@]} ]; then db="${DBS[$((sel-1))]}"; read -p "Confirmer $db (OUI) : " k; if [[ "$k" == "OUI" ]] && ask_sudo_gui; then run_db_command "DROP DATABASE \`$db\`;"; echo "SupprimÃ©"; pause; fi; fi ;;
            r) return ;;
        esac
    done
}

multi_select_db_backup() {
    if ! check_mariadb_installed || ! systemctl is-active --quiet $SERVICE_NAME; then return; fi
    run_sudo mkdir -p "$BACKUP_DIR"; mapfile -t DBS < <(list_databases)
    [ ${#DBS[@]} -eq 0 ] && { echo "Aucune base."; pause; return; }
    declare -A S; for i in "${!DBS[@]}"; do S[$i]=0; done
    while true; do
        clear; echo -e "${BLUE}BACKUP SÃ‰LECTIF${NC}"; C=0
        for i in "${!DBS[@]}"; do [ "${S[$i]}" -eq 1 ] && M="${GREEN}[x]${NC}" || M="${RED}[ ]${NC}"; printf "  %s %2d. %s\n" "$M" $((i+1)) "${DBS[$i]}"; ((C++)); done
        echo "  G. Go | T. Tout | N. Rien | r. Retour"; read -r -p "> " c
        [[ "$c" == "r" ]] && break; [[ "$c" =~ [Tt] ]] && { for i in "${!DBS[@]}"; do S[$i]=1; done; continue; }; [[ "$c" =~ [Nn] ]] && { for i in "${!DBS[@]}"; do S[$i]=0; done; continue; }
        if [[ "$c" =~ [Gg] ]]; then
            L=""; H=0; for i in "${!DBS[@]}"; do [ "${S[$i]}" -eq 1 ] && { L="$L ${DBS[$i]}"; H=1; }; done
            [ $H -eq 0 ] && continue
            if ask_sudo_gui; then D=$(date +%Y%m%d_%H%M%S); A="$BACKUP_DIR/backup_DBs_$D.sql.gz"; echo "Sauvegarde..."; run_sudo mysqldump -u $DB_ROOT_USER $L | gzip > "$A"; echo "Fini"; fi; pause; break
        fi
        [[ "$c" =~ ^[0-9]+$ ]] && [ "$c" -ge 1 ] && [ "$c" -le $C ] && { idx=$((c-1)); [ "${S[$idx]}" -eq 0 ] && S[$idx]=1 || S[$idx]=0; }
    done
}

backup_menu() {
    while true; do
        clear; echo -e "${BLUE}=== SAUVEGARDES ===${NC}"; echo -e "  1. ComplÃ¨te | 2. SÃ©lective | 3. Voir | 4. Restaurer | r. Retour"
        read -r -p "> " c; D=$(date +%Y%m%d_%H%M%S)
        if ! check_mariadb_installed || ! systemctl is-active --quiet $SERVICE_NAME; then echo "Service inactif."; pause; continue; fi
        case "$c" in
            1) if ask_sudo_gui; then A="$BACKUP_DIR/FULL_DB_BACKUP_$D.sql.gz"; run_sudo mkdir -p "$BACKUP_DIR"; echo "Dump..."; run_sudo mysqldump -u $DB_ROOT_USER --all-databases | gzip > "$A"; pause; fi ;;
            2) multi_select_db_backup ;;
            3) run_sudo mkdir -p "$BACKUP_DIR" 2>/dev/null; ls -lh "$BACKUP_DIR" 2>/dev/null; pause ;;
            4) if ask_sudo_gui; then read -e -p "Fichier : " f; if [ -f "$f" ]; then read -p "Confirmer (o) : " o; if [[ "$o" == "o" ]]; then echo "Restauration..."; if [[ "$f" == *.gz ]]; then run_sudo zcat "$f" | run_sudo $CMD_MYSQL -u $DB_ROOT_USER; else run_sudo cat "$f" | run_sudo $CMD_MYSQL -u $DB_ROOT_USER; fi; fi; else echo "Introuvable"; fi; pause; fi ;;
            r) break ;;
        esac
    done
}

menu_system_update() {
    while true; do
        clear; echo -e "${BLUE}=== MISE Ã€ JOUR ===${NC}"; echo -e "  1. Update | 2. Clean | 0. Retour"; read -r -p "> " u
        case "$u" in 1) if ask_sudo_gui; then sudo apt update && sudo apt upgrade -y; pause; fi ;; 2) if ask_sudo_gui; then sudo apt autoremove -y; pause; fi ;; 0) return ;; esac
    done
}

open_user_shell() { if ! ask_sudo_gui; then return; fi; echo -e "\n${GREEN}ðŸ”“ AccÃ¨s autorisÃ©.${NC}"; trap - SIGINT SIGQUIT SIGTSTP; export SKIP_KIOSK_MENU=1; bash --login; unset SKIP_KIOSK_MENU; trap '' SIGINT SIGQUIT SIGTSTP; }
spawn_restricted_shell() {
    local TD="$1"; local SN="$2"; [ ! -d "$TD" ] && run_sudo mkdir -p "$TD"; echo -e "\n${GREEN}ðŸ”’ JAIL $SN${NC}"; local OH="$HOME"
    bash --rcfile <(echo "export HOME='$TD'; export PS1='(Restreint:$SN) \[\033[01;34m\]\w\[\033[00m\]\\$ '; check_path() { if [[ \"\$PWD\" != \"$TD\"* ]]; then echo -e \"\n${RED}â›” Interdit.${NC}\"; cd \"$TD\"; fi; }; alias cd='check_path; cd'; export PROMPT_COMMAND='check_path'; export PATH='/usr/local/bin:/usr/bin:/bin'")
    export HOME="$OH"; trap '' SIGINT SIGQUIT SIGTSTP
}

# --- 3. BOUCLE PRINCIPALE ---
HEADER_LINE="#############################################"
while true; do
    clear; get_sys_info; get_db_info
    if run_sudo_silent $CMD_UFW status 2>/dev/null | grep -q "Status: active"; then FW="${GREEN}â— ACTIF${NC}"; else FW="${RED}â— INACTIF${NC}"; fi

    echo -e "${BLUE}$HEADER_LINE${NC}"
    echo -e "${BLUE}#         MANAGER BASE DE DONNÃ‰ES         #${NC}"
    echo -e "${BLUE}$HEADER_LINE${NC}"
    printf "  ðŸ–¥ï¸  %-20s | â±ï¸  %s\n" "${CYAN}$OS_NAME${NC}" "${GREY}$SYS_UPTIME${NC}"
    printf "  ðŸ§  CPU: %-14s | ðŸ’¾ RAM: %s\n" "${YELLOW}$CPU_USAGE${NC}" "${YELLOW}$RAM_USAGE${NC}"
    printf "  ðŸ  LAN: %-14s | ðŸŒ WAN: %s\n" "${YELLOW}$LOCAL_IP${NC}" "${YELLOW}$PUBLIC_IP${NC}"
    echo "---------------------------------------------"
    printf "  ðŸ”Œ Service : %-11b | ðŸ›¡ï¸  Pare-feu : %s\n" "$DB_STATUS" "$FW"
    printf "  â„¹ï¸  Version : %-11s | âš“ Port     : %s\n" "${CYAN}$DB_VERSION${NC}" "${YELLOW}$DB_PORT${NC}"

    echo "---------------------------------------------"
    echo -e "${BOLD}--- SECTION SERVICE ---${NC}"
    echo -e "  ${GREEN}1.${NC} âš™ï¸  Gestion du Service"
    echo -e "  ${GREEN}2.${NC} ðŸ—ƒï¸  Gestion des Bases de DonnÃ©es (CRUD)"
    echo -e "  ${GREEN}3.${NC} ðŸ’¾ Sauvegardes"
    echo -e "  ${GREEN}4.${NC} ðŸ“œ Logs du service"
    echo ""
    echo -e "${BOLD}--- SECTION GESTION ---${NC}"
    echo -e "  ${GREEN}5.${NC} ðŸ§± Pare-feu (UFW)"
    echo -e "  ${GREEN}6.${NC} ðŸ“‚ Explorateur Fichiers (Jails)"
    echo -e "  ${GREEN}7.${NC} ðŸš€ Mises Ã  jour (App & OS)"
    echo ""
    echo -e "${BOLD}--- SECTION SYSTÃˆME ---${NC}"
    echo -e "  ${RED}8.${NC} ðŸ”Œ Ã‰teindre le serveur"
    echo -e "  ${RED}9.${NC} â™»ï¸  RedÃ©marrer le serveur"
    echo "---------------------------------------------"
    echo -e "  [${YELLOW}admin${NC}] ðŸ’» Console Admin"
    echo -e "  [${RED}exit${NC}]  ðŸšª Quitter"
    echo "---------------------------------------------"
    read -r -p "Votre choix > " ch

    case "$ch" in
        1) menu_service_management ;;
        2) manage_databases ;;
        3) backup_menu ;;
        4) if ask_sudo_gui; then run_sudo tail -f "$LOG_ERROR"; fi ;;
        5) firewall_manager ;;
        6) echo "1. Config | 2. Backups"; read -p "> " j; [ "$j" == "1" ] && spawn_restricted_shell "$DIR_CONF" "CONF-DB"; [ "$j" == "2" ] && spawn_restricted_shell "$BACKUP_DIR" "BACKUPS" ;;
        7) menu_system_update ;;
        8) server_power_action "Ã‰TEINDRE" "poweroff" ;;
        9) server_power_action "REDÃ‰MARRER" "reboot" ;;
        admin) open_user_shell ;;
        exit) kill -9 $PPID 2>/dev/null; exit 0 ;;
        *) echo "Choix invalide"; sleep 1 ;;
    esac
done
